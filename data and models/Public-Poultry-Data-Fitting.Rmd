---
title: "Public-Poultry-Data-Fitting"
author: "Cecil Barnett-Neefs"
date: "2023-06-01"
output: html_document
---

```{r setup, echo=FALSE}
library(readxl)
library(rjags) # https://mcmc-jags.sourceforge.io/
library(fitdistrplus)
library(stringr)
library(pastecs)
library(knitr)
library(MASS)

# MPN Fit ----
# Uses the Ebel model modified by Kowalcyk
# Important: Returns in LN format! Use log10(exp()) to correct
mpn_fit <- function(mpn_data, n_total, n_pos_test, n_pos_test_mpn, n_tubes, type) {
  # MPN ----
  N.total <- n_total
  N.pos.test <- n_pos_test
  N.pos.test.mpn <- n_pos_test_mpn
  N.ND <- N.total - N.pos.test
  num.tubes <- n_tubes
  
  if (type == "ground") {
    v.screen <- 325 # From Kowalcyk Model-turkey  
    v.mpn <- 1 # From Kowalcyk Model-turkey: Ground model does not use v.mpn, set to 1 so that we don't have to create multiple files
  } else if (type == "parts") {
    v.screen <- 136.35 # From Kowalcyk Model-chicken
    v.mpn <- 45.45 # From Kowalcyk Model-chicken
  }
  
  screen.results <- c(
    rep(1,N.pos.test.mpn),
    rep(1,N.pos.test-N.pos.test.mpn),
    rep(0,N.total-N.pos.test)
  )
  
  data <- list(
    v.screen = v.screen,
    v.mpn = v.mpn,
    N.tubes = num.tubes,
    N.total = N.total,
    N.pos.test.mpn = N.pos.test.mpn,
    tube = mpn_data,
    screened = screen.results
    )
  
  inits = list(
    list(lambda = rlnorm(N.total,-9,0.02), tau = 0.05, .RNG.seed=1,.RNG.name= 'base::Wichmann-Hill'), # random seed
    list(lambda = rlnorm(N.total,-6,0.03), tau = 0.3, .RNG.seed=2,.RNG.name= 'base::Wichmann-Hill'), 
    list(lambda = rlnorm(N.total,-2.5,0.01), tau = 0.1, .RNG.seed=3,.RNG.name= 'base::Wichmann-Hill')
  )
  
  n.adapt = 5000  # n iteration for adaptation
  n.update = 10000  # n iterations to add
  n.iter = 5000 # n iteration to keep in the final chain
  n.thinval = 10 # Thinning constant (10).  (Use n.thinval = 1 when just checking out the model run).
  burn.in = 100
  
  set.seed(1)
  if (n_tubes==3) {
    model <- jags.model(
      "JAGS_MPN_Model.jag",
      n.adapt = n.adapt,
      n.chains = 3,
      inits = inits,
      data = data
    )
  } else if(n_tubes==5) {
    model <- jags.model(
      "JAGS_MPN_Model_5-Tube.jag",
      n.adapt = n.adapt,
      n.chains = 3,
      inits = inits,
      data = data
    )
  }
  
  suppressWarnings(update(
    model,
    n.iter = n.update
  ))
  zm1 <- coda.samples(
    model,
    variable.names = c("mu","tau"),
    n.iter = n.iter,
    thin = n.thinval
  )
  (SummaryResults=summary(window(zm1, start = burn.in), quantiles=c(0.025, 0.5, 0.975)))
  mu=    c(window(zm1[[1]][,1],start=burn.in),
           window(zm1[[2]][,1],start=burn.in),
           window(zm1[[3]][,1],start=burn.in))
  
  tau=    c(window(zm1[[1]][,2],start=burn.in),  # change subscript as needed
            window(zm1[[2]][,2],start=burn.in),
            window(zm1[[3]][,2],start=burn.in))
  
  sigma= sqrt(1/tau)
  
  # Plots and outputs:
  summary_stats <- as.data.frame(cbind(pastecs::stat.desc(mu), pastecs::stat.desc(sigma)) )  
  names(summary_stats) <- c("mu","sigma")
  fit <- c(mean(mu), mean(sigma))
  return(summary_stats)
}
# rh_fit <- qpcr_fit(subset_data, 10^-1.48, 10^0, 10^4, 10^8, "qPCR")
qpcr_fit <- function (input_table, lod, enumeration_lower, enumeration_upper, upper_bound, method, full=TRUE) {
  # Create left/right table ----
  left_right_table <- data.frame(
    matrix(
      ncol = 2,
      nrow = dim(input_table)[1]
    )
  )
  colnames(left_right_table) <- c('left', 'right')
  colnames(input_table) <- c("test","value")
  
  # fill left/right table ----
  i <- 1
  while (i <= dim(input_table)[1]) {
    if (grepl("qPCR", method)) {
      x <- input_table$value[i]
    } else if (grepl("plate count", method)|grepl("APC", method)) {
      x <- input_table$value[i]
    }
    y <- input_table$test[i]
    # TO DO: Zero detection
    if (y=="Positive") {
      if (grepl(">", x)) { # Has a "<", above enumeration_upper and cannot convert to a "real number" with as.numeric
        left_right_table$left[i] <- (enumeration_upper)
        left_right_table$right[i] <- (upper_bound)
      } else if (grepl("<", x)) { # Has a "<", below enumeration_lower and cannot convert to a "real number" with as.numeric
        left_right_table$left[i] <- (lod)
        left_right_table$right[i] <- (enumeration_lower)
      } else {
        x <- as.numeric(x) # Is a "real number" and can be checked with numerical rules
      }
      
      if (enumeration_upper<x) { # Above enumeration_upper
        left_right_table$left[i] <- (enumeration_upper)
        left_right_table$right[i] <- (upper_bound)
      } else if ((enumeration_lower)<=x & x<=(enumeration_upper)) { # Between enumeration_lower and enumeration_upper
        left_right_table$left[i] <- x
        left_right_table$right[i] <- x
      } else if (x < enumeration_lower) { # Below enumeration_lower
        left_right_table$left[i] <- (lod)
        left_right_table$right[i] <- (enumeration_lower)
      }
    } else if (y=="Negative") {
      left_right_table$left[i] <- NA
      if (full==FALSE) {
        left_right_table$right[i] <- NA
      } else {
        left_right_table$right[i] <- (lod)
      }
    }
    i <- i+1
  }
  if (full==FALSE) {
    left_right_table <- left_right_table[-which(is.na(left_right_table$left) & is.na(left_right_table$right)),]
  }
  # Log10 ----
  i <- 1
  while (i <= length(left_right_table$left)) {
    ## Left ----
    if (left_right_table$left[i]!=0 & !is.na(left_right_table$left[i])) {
        left_right_table$left[i] <- log10(left_right_table$left[i])
    }
    # Right ----
    if (left_right_table$right[i]!=0 & !is.na(left_right_table$right[i])) {
        left_right_table$right[i] <- log10(left_right_table$right[i])
    }
    i <- i+1
  }
  # Return ----
  fit <- (fitdistrplus::fitdistcens(left_right_table, "norm"))
  return(fit)
}

cfu_threshold_cut <- function(cfu, values, types, rounding) {
  values <- as.data.frame(values)
  colnames(values) <- c("V1")
  types <- as.data.frame(types)
  colnames(types) <- c("V1")
  count <- sum(as.numeric(as.character(values$V1[which(types$V1=="value")]))>as.numeric(cfu))
  percentage <- round(count/length(values$V1)*100, rounding)
  paste0(">", MASS::fractions(cfu), " CFU: ", count, " (", percentage, "%)")
}

cfu_threshold_cut_return <- function(cfu, values, types, rounding) {
  values <- as.data.frame(values)
  colnames(values) <- c("V1")
  types <- as.data.frame(types)
  colnames(types) <- c("V1")
  count <-  sum(as.numeric(as.character(values$V1[which(types$V1=="value")]))>as.numeric(cfu))
  if (!is.na(rounding)) {
    percentage <- round(count/length(values$V1)*100, rounding)
  } else {
    percentage <- count/length(values$V1)*100
  }
  return(c(count, percentage))
}

fitted_count_parts <- function(mean, sd) {
  cat(paste0(">10 CFU (Fit): ", round((1-pnorm(log10(10), mean, sd, TRUE))*100,2), "%\n>1 CFU (Fit): ", round((1-pnorm(log10(1), mean, sd, TRUE))*100,2), "%\n>1/30 CFU (Positive) (Fit): ", round((1-pnorm(log10(1/30), mean, sd, TRUE))*100,2), "%\n<1/30 CFU (Negative) (Fit): ", round((pnorm(log10(1/30), mean, sd, TRUE))*100,2), "%\n"))
}

fitted_count_ground <- function(mean, sd) {
  cat(paste0(">10 CFU (Fit): ", round((1-pnorm(log10(10), mean, sd, TRUE))*100,2), "%\n>1 CFU (Fit): ", round((1-pnorm(log10(1), mean, sd, TRUE))*100,2), "%\n>1/325 CFU (Positive) (Fit): ", round((1-pnorm(log10(1/325), mean, sd, TRUE))*100,2), "%\n<1/325 CFU (Negative) (Fit): ", round((pnorm(log10(1/325), mean, sd, TRUE))*100,2), "%\n"))
}

fitted_count_parts_return <- function(mean, sd, l=c(10,1,1/30)) {
  return(c((1-pnorm(log10(l[1]), mean, sd, TRUE))*100, (1-pnorm(log10(l[2]), mean, sd, TRUE))*100, (1-pnorm(log10(l[3]), mean, sd, TRUE))*100, (pnorm(log10(l[3]), mean, sd, TRUE))*100))
}

fitted_count_ground_return <- function(mean, sd) {
  return(c((1-pnorm(log10(10), mean, sd, TRUE))*100, (1-pnorm(log10(1), mean, sd, TRUE))*100, (1-pnorm(log10(1/325), mean, sd, TRUE))*100, (pnorm(log10(1/325), mean, sd, TRUE))*100))
}

MPN_Refence <- read.csv("MPN_Lookup.csv")
MPN_Refence_LOD <- MPN_Refence[c(1,40),]
MPN_Refence <- MPN_Refence[-c(1,40),]
MPN_Refence$MPN_Index <- as.double(MPN_Refence$MPN_Index)
```

Notes

1-Sample_result DI =Comminuted =\> You need to filter by Projectcd column, HC_CH_COM01 value. GROUND!!!!\
2-Exploratory =\>carcass exploratory , CH=Post chill, RH=rehang, This is qPCR!!!\
3-2012 RCPBS=\> Parts Baseline, MPN 3 tubes.\
4-2007_08 YCBS=\> Carcass Baseline, Projectid column, REHG=rehang, POST=Post chill, MPN 3 tube.\
Note that in some files, there might be some values like 25-24 Lab meaning lab error and result should not be included. Those result need to be removed. In MPN code it should be written as NA or some other value.

```{r filepath reports, echo=FALSE}
path_raw_data <- paste0(getwd(),"/raw data/data from FOIA/Chicken")
input_list <- list.files(path_raw_data)
paste0("Pulling data from ",paste0(path_raw_data))
```

```{r 1-Sample_results DI.csv Ebel, echo=FALSE}
paste0("1-Sample_results DI.csv")
paste0(path_raw_data, "/", input_list[1])
input_data <- read.csv(paste0(path_raw_data, "/", input_list[1]))
# Remove empty columns
clean_data <- dplyr::select(input_data, -c("X","X.1","X.2","X.3","X.4","X.5","X.6","X.7","X.8","X.9"))
# Format dates correctly
clean_data$collectdt <- as.Date(clean_data$collectdt, tryFormats = "%m/%d/%Y")
# Convert projectcd to factors
clean_data$projectcd <- as.factor(clean_data$projectcd)
# Convert ssNM to factors
clean_data$ssNm <- as.factor(clean_data$ssNm)
# Convert Salmonella to factors
clean_data$Salmonella <- as.factor(clean_data$Salmonella)
# Convert Serotype to factors and convert blanks to NA
clean_data$Serotype <- as.factor(clean_data$Serotype)
clean_data$Serotype[which(clean_data$Serotype=="")] <- NA
clean_data$Serotype <- factor(clean_data$Serotype)
# Convert Salm_MPN_Comb to factors, add leading zeros if necessary
clean_data$Salm_MPN_Comb <- as.character(clean_data$Salm_MPN_Comb)
clean_data$Salm_MPN_Comb[which(!is.na(clean_data$Salm_MPN_Comb))] <- sprintf("%05d",as.numeric(clean_data$Salm_MPN_Comb[which(!is.na(clean_data$Salm_MPN_Comb))]))
clean_data$Salm_MPN_Comb[which(clean_data$Salm_MPN_Comb=="   NA")] <- NA
clean_data$Salm_MPN_Comb <- factor(clean_data$Salm_MPN_Comb)
# Split MPN results to individual columns
mpn_columns <- as.data.frame(t(as.data.frame(strsplit(as.character(clean_data$Salm_MPN_Comb),""))))
colnames(mpn_columns) <- c("MPN_Tube_1","MPN_Tube_2","MPN_Tube_3","MPN_Tube_4","MPN_Tube_5")
rownames(mpn_columns) <- seq(1,dim(mpn_columns)[1])
mpn_columns$MPN_Tube_1 <- as.numeric(mpn_columns$MPN_Tube_1)
mpn_columns$MPN_Tube_2 <- as.numeric(mpn_columns$MPN_Tube_2)
mpn_columns$MPN_Tube_3 <- as.numeric(mpn_columns$MPN_Tube_3)
mpn_columns$MPN_Tube_4 <- as.numeric(mpn_columns$MPN_Tube_4)
mpn_columns$MPN_Tube_5 <- as.numeric(mpn_columns$MPN_Tube_5)
clean_data <- cbind(clean_data,mpn_columns)
# Convert Salm_Qualit_MPN to factors
clean_data$Salm_Qualit_MPN <- as.factor(clean_data$Salm_Qualit_MPN)

clean_data$value_type <- NA
clean_data$value_type[grepl("<",clean_data$Salm_MPN)] <- ("cutoff_left")
clean_data$value_type[grepl(">",clean_data$Salm_MPN)] <- ("cutoff_right")
clean_data$value_type[which(!grepl("<",clean_data$Salm_MPN) & !grepl(">",clean_data$Salm_MPN) & !is.na(clean_data$Salm_MPN))] <- "value"
clean_data$value_type <- factor(clean_data$value_type)
# Convert Salm_MPN to factors
clean_data$Salm_MPN <- as.factor(clean_data$Salm_MPN)
# Drop data rows with problems
# clean_data <- clean_data[which(clean_data$Salm_MPN!="25-24 Lab Problem - Resources or Personnel not available due to emergency response"),]
# clean_data <- clean_data[which(clean_data$Salm_MPN!="No Reserve"),]
# clean_data <- clean_data[which(clean_data$Salm_MPN!="9.3; <0.03"),] 

subset_data <- clean_data[clean_data$projectcd=="HC_CH_COM01",]
rownames(subset_data) <- seq(1, dim(subset_data)[1])

subset_data <- subset_data[-which(subset_data$Salm_MPN=="25-24 Lab Problem - Resources or Personnel not available due to emergency response"),]
subset_data <- subset_data[-which(subset_data$Salm_MPN=="9.3; <0.03"),] # Weird/confused MPN value and no tubes

n_total <- dim(subset_data)[1] # Rows
n_pos_test <- sum(!is.na(subset_data$Salm_MPN_Comb))
# n_pos_test <- 398
n_pos_test_mpn <- sum(!is.na(subset_data$Salm_MPN_Comb)) # Salm_MPN_Comb
# n_pos_test_mpn <- 398

paste0("Left Cutoff")
summary(factor(subset_data$Salm_MPN[which(subset_data$value_type=="cutoff_left")]))
paste0("Right Cutoff")
summary(factor(subset_data$Salm_MPN[which(subset_data$value_type=="cutoff_right")]))
paste0("Values")
summary(factor(subset_data$Salm_MPN[which(subset_data$value_type=="value")]))

cfu_threshold_cut(10, subset_data$Salm_MPN, subset_data$value_type, 2)
cfu_threshold_cut(1, subset_data$Salm_MPN, subset_data$value_type, 2)
cfu_threshold_cut(1/10, subset_data$Salm_MPN, subset_data$value_type, 2)
cfu_threshold_cut(1/30, subset_data$Salm_MPN, subset_data$value_type, 2)
cfu_threshold_cut(1/325, subset_data$Salm_MPN, subset_data$value_type, 2)

over_10_cfu <- cfu_threshold_cut_return(10, subset_data$Salm_MPN, subset_data$value_type, NA)[1]
over_10_cfu_pct <- cfu_threshold_cut_return(10, subset_data$Salm_MPN, subset_data$value_type, NA)[2]

over_1_cfu <- cfu_threshold_cut_return(1, subset_data$Salm_MPN, subset_data$value_type, NA)[1]
over_1_cfu_pct <- cfu_threshold_cut_return(1, subset_data$Salm_MPN, subset_data$value_type, NA)[2]

paste0("Positives: ", sum(subset_data$Salmonella=="Positive"), " (", round(sum(subset_data$Salmonella=="Positive")/length(subset_data$Salmonella)*100,2), "%)")
paste0("Negatives: ", sum(subset_data$Salmonella=="Negative"), " (", round(sum(subset_data$Salmonella=="Negative")/length(subset_data$Salmonella)*100,2), "%)")
paste0("Total: ", length(subset_data$Salmonella))
total <- length(subset_data$Salmonella)
positives <- sum(subset_data$Salmonella=="Positive")
positives_pct <- sum(subset_data$Salmonella=="Positive")/length(subset_data$Salmonella)*100
negatives <- sum(subset_data$Salmonella=="Negative")
negatives_pct <- sum(subset_data$Salmonella=="Negative")/length(subset_data$Salmonella)*100

subset_data$ksi_serotype <- NA
i <- 1
while (i <= length(subset_data$Serotype)) {
  if (is.na(subset_data$Serotype[i])) {
    subset_data$ksi_serotype[i] <- NA
  } else if(subset_data$Serotype[i]=="Enteritidis"|subset_data$Serotype[i]=="Infantis"|subset_data$Serotype[i]=="Kentucky"|subset_data$Serotype[i]=="Typhimurium") {
    subset_data$ksi_serotype[i] <- as.character(subset_data$Serotype[i])
  } else {
    subset_data$ksi_serotype[i] <- "Other"
  }
  i <- i+1
}
subset_data$ksi_serotype <- factor(subset_data$ksi_serotype)

# Drop Salm_MPN_Comb NAs
subset_data <- subset_data[!is.na(subset_data$Salm_MPN_Comb),]
fit_dist_comminuted_censor_mpn <- mpn_fit(subset(subset_data, select = c("MPN_Tube_1","MPN_Tube_2","MPN_Tube_3","MPN_Tube_4","MPN_Tube_5")), n_total, n_pos_test, n_pos_test_mpn, 5, "ground")
cat(paste0("\nMean: ", log10(exp(fit_dist_comminuted_censor_mpn$mu[9])), " SD: ", log10(exp(fit_dist_comminuted_censor_mpn$sigma[9])), "\n"))
fitted_count_ground(log10(exp(fit_dist_comminuted_censor_mpn$mu[9])), log10(exp(fit_dist_comminuted_censor_mpn$sigma[9])))
new_row <- data.frame(
  file=input_list[1],
  scenario="comminuted",
  fit_type="mpn_ebel_log10norm",
  total=total,
  positives=positives,
  positives_pct=positives_pct,
  negatives=negatives,
  negatives_pct=negatives_pct,
  product_type="ground",
  positive_threshold=1/325,
  over_1_cfu=over_1_cfu,
  over_1_cfu_pct=over_1_cfu_pct,
  over_10_cfu=over_10_cfu,
  over_10_cfu_pct=over_10_cfu_pct,
  total_serotype_hits=sum((summary(subset_data$ksi_serotype)[c(1:5)])),
  ksi_serotypes_missing=length(which(subset_data$Salmonella=="Positive" & is.na(subset_data$Serotype))),
  ksi_serotype_hits=sum((summary(subset_data$ksi_serotype)[c(1:3,5)])),
  ksi_enteritidis=as.numeric(summary(subset_data$ksi_serotype)[1]),
  ksi_enteritidis_pct=as.numeric(summary(subset_data$ksi_serotype)[1])/sum((summary(subset_data$ksi_serotype)[c(1:5)]))*100,
  ksi_typhimurium=as.numeric(summary(subset_data$ksi_serotype)[5]),
  ksi_typhimurium_pct=as.numeric(summary(subset_data$ksi_serotype)[5])/sum((summary(subset_data$ksi_serotype)[c(1:5)]))*100,
  ksi_infantis=as.numeric(summary(subset_data$ksi_serotype)[2]),
  ksi_infantis_pct=as.numeric(summary(subset_data$ksi_serotype)[2])/sum((summary(subset_data$ksi_serotype)[c(1:5)]))*100,
  ksi_kentucky=as.numeric(summary(subset_data$ksi_serotype)[3]),
  ksi_kentucky_pct=as.numeric(summary(subset_data$ksi_serotype)[3])/sum((summary(subset_data$ksi_serotype)[c(1:5)]))*100,
  ksi_other=as.numeric(summary(subset_data$ksi_serotype)[4]),
  ksi_other_pct=as.numeric(summary(subset_data$ksi_serotype)[4])/sum((summary(subset_data$ksi_serotype)[c(1:5)]))*100,
  mean=log10(exp(fit_dist_comminuted_censor_mpn$mu[9])),
  sd=log10(exp(fit_dist_comminuted_censor_mpn$sigma[9])),
  positives_pct_fit=fitted_count_ground_return(log10(exp(fit_dist_comminuted_censor_mpn$mu[9])), log10(exp(fit_dist_comminuted_censor_mpn$sigma[9])))[3],
  negatives_pct_fit=fitted_count_ground_return(log10(exp(fit_dist_comminuted_censor_mpn$mu[9])), log10(exp(fit_dist_comminuted_censor_mpn$sigma[9])))[4],
  over_1_cfu_pct_fit=fitted_count_ground_return(log10(exp(fit_dist_comminuted_censor_mpn$mu[9])), log10(exp(fit_dist_comminuted_censor_mpn$sigma[9])))[2],
  over_10_cfu_pct_fit=fitted_count_ground_return(log10(exp(fit_dist_comminuted_censor_mpn$mu[9])), log10(exp(fit_dist_comminuted_censor_mpn$sigma[9])))[1]
)
fit_row_comminuted_censor_ebel <- new_row
```

```{r 1-Sample_results DI.csv Ebel_override, echo=FALSE}
paste0("1-Sample_results DI.csv")
paste0(path_raw_data, "/", input_list[1])
input_data <- read.csv(paste0(path_raw_data, "/", input_list[1]))
# Remove empty columns
clean_data <- dplyr::select(input_data, -c("X","X.1","X.2","X.3","X.4","X.5","X.6","X.7","X.8","X.9"))
# Format dates correctly
clean_data$collectdt <- as.Date(clean_data$collectdt, tryFormats = "%m/%d/%Y")
# Convert projectcd to factors
clean_data$projectcd <- as.factor(clean_data$projectcd)
# Convert ssNM to factors
clean_data$ssNm <- as.factor(clean_data$ssNm)
# Convert Salmonella to factors
clean_data$Salmonella <- as.factor(clean_data$Salmonella)
# Convert Serotype to factors and convert blanks to NA
clean_data$Serotype <- as.factor(clean_data$Serotype)
clean_data$Serotype[which(clean_data$Serotype=="")] <- NA
clean_data$Serotype <- factor(clean_data$Serotype)
# Convert Salm_MPN_Comb to factors, add leading zeros if necessary
clean_data$Salm_MPN_Comb <- as.character(clean_data$Salm_MPN_Comb)
clean_data$Salm_MPN_Comb[which(!is.na(clean_data$Salm_MPN_Comb))] <- sprintf("%05d",as.numeric(clean_data$Salm_MPN_Comb[which(!is.na(clean_data$Salm_MPN_Comb))]))
clean_data$Salm_MPN_Comb[which(clean_data$Salm_MPN_Comb=="   NA")] <- NA
clean_data$Salm_MPN_Comb <- factor(clean_data$Salm_MPN_Comb)
# Split MPN results to individual columns
mpn_columns <- as.data.frame(t(as.data.frame(strsplit(as.character(clean_data$Salm_MPN_Comb),""))))
colnames(mpn_columns) <- c("MPN_Tube_1","MPN_Tube_2","MPN_Tube_3","MPN_Tube_4","MPN_Tube_5")
rownames(mpn_columns) <- seq(1,dim(mpn_columns)[1])
mpn_columns$MPN_Tube_1 <- as.numeric(mpn_columns$MPN_Tube_1)
mpn_columns$MPN_Tube_2 <- as.numeric(mpn_columns$MPN_Tube_2)
mpn_columns$MPN_Tube_3 <- as.numeric(mpn_columns$MPN_Tube_3)
mpn_columns$MPN_Tube_4 <- as.numeric(mpn_columns$MPN_Tube_4)
mpn_columns$MPN_Tube_5 <- as.numeric(mpn_columns$MPN_Tube_5)
clean_data <- cbind(clean_data,mpn_columns)
# Convert Salm_Qualit_MPN to factors
clean_data$Salm_Qualit_MPN <- as.factor(clean_data$Salm_Qualit_MPN)

clean_data$value_type <- NA
clean_data$value_type[grepl("<",clean_data$Salm_MPN)] <- ("cutoff_left")
clean_data$value_type[grepl(">",clean_data$Salm_MPN)] <- ("cutoff_right")
clean_data$value_type[which(!grepl("<",clean_data$Salm_MPN) & !grepl(">",clean_data$Salm_MPN) & !is.na(clean_data$Salm_MPN))] <- "value"
clean_data$value_type <- factor(clean_data$value_type)
# Convert Salm_MPN to factors
clean_data$Salm_MPN <- as.factor(clean_data$Salm_MPN)
# Drop data rows with problems
# clean_data <- clean_data[which(clean_data$Salm_MPN!="25-24 Lab Problem - Resources or Personnel not available due to emergency response"),]
# clean_data <- clean_data[which(clean_data$Salm_MPN!="No Reserve"),]
# clean_data <- clean_data[which(clean_data$Salm_MPN!="9.3; <0.03"),] 

subset_data <- clean_data[clean_data$projectcd=="HC_CH_COM01",]
rownames(subset_data) <- seq(1, dim(subset_data)[1])

subset_data <- subset_data[-which(subset_data$Salm_MPN=="25-24 Lab Problem - Resources or Personnel not available due to emergency response"),]
subset_data <- subset_data[-which(subset_data$Salm_MPN=="9.3; <0.03"),] # Weird/confused MPN value and no tubes

# n_total <- dim(subset_data)[1] # Rows
# Problem: many positive samples are not enumerated
pct_positive <- round(as.numeric(summary(subset_data$Salmonella)/sum(as.numeric(summary(subset_data$Salmonella)))*100)[2],1) # Use positive percentage to back-calculate n_total based on proportions
n_total <- round(sum(!is.na(subset_data$Salm_MPN_Comb))*(100/pct_positive),0)
n_pos_test <- sum(!is.na(subset_data$Salm_MPN_Comb))
# n_pos_test <- 398
n_pos_test_mpn <- sum(!is.na(subset_data$Salm_MPN_Comb)) # Salm_MPN_Comb
# n_pos_test_mpn <- 398

paste0("Left Cutoff")
summary(factor(subset_data$Salm_MPN[which(subset_data$value_type=="cutoff_left")]))
paste0("Right Cutoff")
summary(factor(subset_data$Salm_MPN[which(subset_data$value_type=="cutoff_right")]))
paste0("Values")
summary(factor(subset_data$Salm_MPN[which(subset_data$value_type=="value")]))

cfu_threshold_cut(10, subset_data$Salm_MPN, subset_data$value_type, 2)
cfu_threshold_cut(1, subset_data$Salm_MPN, subset_data$value_type, 2)
cfu_threshold_cut(1/10, subset_data$Salm_MPN, subset_data$value_type, 2)
cfu_threshold_cut(1/30, subset_data$Salm_MPN, subset_data$value_type, 2)
cfu_threshold_cut(1/325, subset_data$Salm_MPN, subset_data$value_type, 2)

over_10_cfu <- cfu_threshold_cut_return(10, subset_data$Salm_MPN, subset_data$value_type, NA)[1]
over_10_cfu_pct <- cfu_threshold_cut_return(10, subset_data$Salm_MPN, subset_data$value_type, NA)[2]

over_1_cfu <- cfu_threshold_cut_return(1, subset_data$Salm_MPN, subset_data$value_type, NA)[1]
over_1_cfu_pct <- cfu_threshold_cut_return(1, subset_data$Salm_MPN, subset_data$value_type, NA)[2]

paste0("Positives: ", sum(subset_data$Salmonella=="Positive"), " (", round(sum(subset_data$Salmonella=="Positive")/length(subset_data$Salmonella)*100,2), "%)")
paste0("Negatives: ", sum(subset_data$Salmonella=="Negative"), " (", round(sum(subset_data$Salmonella=="Negative")/length(subset_data$Salmonella)*100,2), "%)")
paste0("Total: ", length(subset_data$Salmonella))
total <- length(subset_data$Salmonella)
positives <- sum(subset_data$Salmonella=="Positive")
positives_pct <- sum(subset_data$Salmonella=="Positive")/length(subset_data$Salmonella)*100
negatives <- sum(subset_data$Salmonella=="Negative")
negatives_pct <- sum(subset_data$Salmonella=="Negative")/length(subset_data$Salmonella)*100

subset_data$ksi_serotype <- NA
i <- 1
while (i <= length(subset_data$Serotype)) {
  if (is.na(subset_data$Serotype[i])) {
    subset_data$ksi_serotype[i] <- NA
  } else if(subset_data$Serotype[i]=="Enteritidis"|subset_data$Serotype[i]=="Infantis"|subset_data$Serotype[i]=="Kentucky"|subset_data$Serotype[i]=="Typhimurium") {
    subset_data$ksi_serotype[i] <- as.character(subset_data$Serotype[i])
  } else {
    subset_data$ksi_serotype[i] <- "Other"
  }
  i <- i+1
}
subset_data$ksi_serotype <- factor(subset_data$ksi_serotype)
# Drop Salm_MPN_Comb NAs
subset_data <- subset_data[!is.na(subset_data$Salm_MPN_Comb),]
fit_dist_comminuted_censor_mpn_override <- mpn_fit(subset(subset_data, select = c("MPN_Tube_1","MPN_Tube_2","MPN_Tube_3","MPN_Tube_4","MPN_Tube_5")), n_total, n_pos_test, n_pos_test_mpn, 5, "ground")
cat(paste0("\nMean: ", log10(exp(fit_dist_comminuted_censor_mpn_override$mu[9])), " SD: ", log10(exp(fit_dist_comminuted_censor_mpn_override$sigma[9])), "\n"))
fitted_count_ground(log10(exp(fit_dist_comminuted_censor_mpn_override$mu[9])), log10(exp(fit_dist_comminuted_censor_mpn_override$sigma[9])))
new_row <- data.frame(
  file=input_list[1],
  scenario="comminuted",
  fit_type="mpn_ebel_log10norm_override",
  total=total,
  positives=positives,
  positives_pct=positives_pct,
  negatives=negatives,
  negatives_pct=negatives_pct,
  product_type="ground",
  positive_threshold=1/325,
  over_1_cfu=over_1_cfu,
  over_1_cfu_pct=over_1_cfu_pct,
  over_10_cfu=over_10_cfu,
  over_10_cfu_pct=over_10_cfu_pct,
  total_serotype_hits=sum((summary(subset_data$ksi_serotype)[c(1:5)])),
  ksi_serotypes_missing=length(which(subset_data$Salmonella=="Positive" & is.na(subset_data$Serotype))),
  ksi_serotype_hits=sum((summary(subset_data$ksi_serotype)[c(1:3,5)])),
  ksi_enteritidis=as.numeric(summary(subset_data$ksi_serotype)[1]),
  ksi_enteritidis_pct=as.numeric(summary(subset_data$ksi_serotype)[1])/sum((summary(subset_data$ksi_serotype)[c(1:5)]))*100,
  ksi_typhimurium=as.numeric(summary(subset_data$ksi_serotype)[5]),
  ksi_typhimurium_pct=as.numeric(summary(subset_data$ksi_serotype)[5])/sum((summary(subset_data$ksi_serotype)[c(1:5)]))*100,
  ksi_infantis=as.numeric(summary(subset_data$ksi_serotype)[2]),
  ksi_infantis_pct=as.numeric(summary(subset_data$ksi_serotype)[2])/sum((summary(subset_data$ksi_serotype)[c(1:5)]))*100,
  ksi_kentucky=as.numeric(summary(subset_data$ksi_serotype)[3]),
  ksi_kentucky_pct=as.numeric(summary(subset_data$ksi_serotype)[3])/sum((summary(subset_data$ksi_serotype)[c(1:5)]))*100,
  ksi_other=as.numeric(summary(subset_data$ksi_serotype)[4]),
  ksi_other_pct=as.numeric(summary(subset_data$ksi_serotype)[4])/sum((summary(subset_data$ksi_serotype)[c(1:5)]))*100,
  mean=log10(exp(fit_dist_comminuted_censor_mpn_override$mu[9])),
  sd=log10(exp(fit_dist_comminuted_censor_mpn_override$sigma[9])),
  positives_pct_fit=fitted_count_ground_return(log10(exp(fit_dist_comminuted_censor_mpn_override$mu[9])), log10(exp(fit_dist_comminuted_censor_mpn_override$sigma[9])))[3],
  negatives_pct_fit=fitted_count_ground_return(log10(exp(fit_dist_comminuted_censor_mpn_override$mu[9])), log10(exp(fit_dist_comminuted_censor_mpn_override$sigma[9])))[4],
  over_1_cfu_pct_fit=fitted_count_ground_return(log10(exp(fit_dist_comminuted_censor_mpn_override$mu[9])), log10(exp(fit_dist_comminuted_censor_mpn_override$sigma[9])))[2],
  over_10_cfu_pct_fit=fitted_count_ground_return(log10(exp(fit_dist_comminuted_censor_mpn_override$mu[9])), log10(exp(fit_dist_comminuted_censor_mpn_override$sigma[9])))[1]
)
fit_row_comminuted_censor_mpn_override <- new_row
```

```{r 1-Sample_results DI.csv fitdistcens_short, echo=FALSE, eval=FALSE}
paste0("1-Sample_results DI.csv")
paste0(path_raw_data, "/", input_list[1])
input_data <- read.csv(paste0(path_raw_data, "/", input_list[1]))
# Remove empty columns
clean_data <- dplyr::select(input_data, -c("X","X.1","X.2","X.3","X.4","X.5","X.6","X.7","X.8","X.9"))
# Format dates correctly
clean_data$collectdt <- as.Date(clean_data$collectdt, tryFormats = "%m/%d/%Y")
# Convert projectcd to factors
clean_data$projectcd <- as.factor(clean_data$projectcd)
# Convert ssNM to factors
clean_data$ssNm <- as.factor(clean_data$ssNm)
# Convert Salmonella to factors
clean_data$Salmonella <- as.factor(clean_data$Salmonella)
# Convert Serotype to factors and convert blanks to NA
clean_data$Serotype <- as.factor(clean_data$Serotype)
clean_data$Serotype[which(clean_data$Serotype=="")] <- NA
clean_data$Serotype <- factor(clean_data$Serotype)
# Convert Salm_MPN_Comb to factors, add leading zeros if necessary
clean_data$Salm_MPN_Comb <- as.character(clean_data$Salm_MPN_Comb)
clean_data$Salm_MPN_Comb[which(!is.na(clean_data$Salm_MPN_Comb))] <- sprintf("%05d",as.numeric(clean_data$Salm_MPN_Comb[which(!is.na(clean_data$Salm_MPN_Comb))]))
clean_data$Salm_MPN_Comb[which(clean_data$Salm_MPN_Comb=="   NA")] <- NA
clean_data$Salm_MPN_Comb <- factor(clean_data$Salm_MPN_Comb)
# Split MPN results to individual columns
mpn_columns <- as.data.frame(t(as.data.frame(strsplit(as.character(clean_data$Salm_MPN_Comb),""))))
colnames(mpn_columns) <- c("MPN_Tube_1","MPN_Tube_2","MPN_Tube_3","MPN_Tube_4","MPN_Tube_5")
rownames(mpn_columns) <- seq(1,dim(mpn_columns)[1])
mpn_columns$MPN_Tube_1 <- as.numeric(mpn_columns$MPN_Tube_1)
mpn_columns$MPN_Tube_2 <- as.numeric(mpn_columns$MPN_Tube_2)
mpn_columns$MPN_Tube_3 <- as.numeric(mpn_columns$MPN_Tube_3)
mpn_columns$MPN_Tube_4 <- as.numeric(mpn_columns$MPN_Tube_4)
mpn_columns$MPN_Tube_5 <- as.numeric(mpn_columns$MPN_Tube_5)
clean_data <- cbind(clean_data,mpn_columns)
# Convert Salm_Qualit_MPN to factors
clean_data$Salm_Qualit_MPN <- as.factor(clean_data$Salm_Qualit_MPN)

clean_data$value_type <- NA
clean_data$value_type[grepl("<",clean_data$Salm_MPN)] <- ("cutoff_left")
clean_data$value_type[grepl(">",clean_data$Salm_MPN)] <- ("cutoff_right")
clean_data$value_type[which(!grepl("<",clean_data$Salm_MPN) & !grepl(">",clean_data$Salm_MPN) & !is.na(clean_data$Salm_MPN))] <- "value"
clean_data$value_type <- factor(clean_data$value_type)
# Convert Salm_MPN to factors
clean_data$Salm_MPN <- as.factor(clean_data$Salm_MPN)
# Drop data rows with problems
# clean_data <- clean_data[which(clean_data$Salm_MPN!="25-24 Lab Problem - Resources or Personnel not available due to emergency response"),]
# clean_data <- clean_data[which(clean_data$Salm_MPN!="No Reserve"),]
# clean_data <- clean_data[which(clean_data$Salm_MPN!="9.3; <0.03"),] 

subset_data <- clean_data[clean_data$projectcd=="HC_CH_COM01",]
rownames(subset_data) <- seq(1, dim(subset_data)[1])

subset_data <- subset_data[-which(subset_data$Salm_MPN=="25-24 Lab Problem - Resources or Personnel not available due to emergency response"),]
subset_data <- subset_data[-which(subset_data$Salm_MPN=="9.3; <0.03"),] # Weird/confused MPN value and no tubes

# n_total <- dim(subset_data)[1] # Rows
# Problem: many positive samples are not enumerated
pct_positive <- round(as.numeric(summary(subset_data$Salmonella)/sum(as.numeric(summary(subset_data$Salmonella)))*100)[2],1) # Use positive percentage to back-calculate n_total based on proportions
n_total <- round(sum(!is.na(subset_data$Salm_MPN_Comb))*(100/pct_positive),0)
n_pos_test <- sum(!is.na(subset_data$Salm_MPN_Comb))
# n_pos_test <- 398
n_pos_test_mpn <- sum(!is.na(subset_data$Salm_MPN_Comb)) # Salm_MPN_Comb
# n_pos_test_mpn <- 398

paste0("Left Cutoff")
summary(factor(subset_data$Salm_MPN[which(subset_data$value_type=="cutoff_left")]))
paste0("Right Cutoff")
summary(factor(subset_data$Salm_MPN[which(subset_data$value_type=="cutoff_right")]))
paste0("Values")
summary(factor(subset_data$Salm_MPN[which(subset_data$value_type=="value")]))

cfu_threshold_cut(10, subset_data$Salm_MPN, subset_data$value_type, 2)
cfu_threshold_cut(1, subset_data$Salm_MPN, subset_data$value_type, 2)
cfu_threshold_cut(1/10, subset_data$Salm_MPN, subset_data$value_type, 2)
cfu_threshold_cut(1/30, subset_data$Salm_MPN, subset_data$value_type, 2)
cfu_threshold_cut(1/325, subset_data$Salm_MPN, subset_data$value_type, 2)

over_10_cfu <- cfu_threshold_cut_return(10, subset_data$Salm_MPN, subset_data$value_type, NA)[1]
over_10_cfu_pct <- cfu_threshold_cut_return(10, subset_data$Salm_MPN, subset_data$value_type, NA)[2]

over_1_cfu <- cfu_threshold_cut_return(1, subset_data$Salm_MPN, subset_data$value_type, NA)[1]
over_1_cfu_pct <- cfu_threshold_cut_return(1, subset_data$Salm_MPN, subset_data$value_type, NA)[2]

paste0("Positives: ", sum(subset_data$Salmonella=="Positive"), " (", round(sum(subset_data$Salmonella=="Positive")/length(subset_data$Salmonella)*100,2), "%)")
paste0("Negatives: ", sum(subset_data$Salmonella=="Negative"), " (", round(sum(subset_data$Salmonella=="Negative")/length(subset_data$Salmonella)*100,2), "%)")
paste0("Total: ", length(subset_data$Salmonella))
total <- length(subset_data$Salmonella)
positives <- sum(subset_data$Salmonella=="Positive")
positives_pct <- sum(subset_data$Salmonella=="Positive")/length(subset_data$Salmonella)*100
negatives <- sum(subset_data$Salmonella=="Negative")
negatives_pct <- sum(subset_data$Salmonella=="Negative")/length(subset_data$Salmonella)*100

subset_data$ksi_serotype <- NA
i <- 1
while (i <= length(subset_data$Serotype)) {
  if (is.na(subset_data$Serotype[i])) {
    subset_data$ksi_serotype[i] <- NA
  } else if(subset_data$Serotype[i]=="Enteritidis"|subset_data$Serotype[i]=="Infantis"|subset_data$Serotype[i]=="Kentucky"|subset_data$Serotype[i]=="Typhimurium") {
    subset_data$ksi_serotype[i] <- as.character(subset_data$Serotype[i])
  } else {
    subset_data$ksi_serotype[i] <- "Other"
  }
  i <- i+1
}
subset_data$ksi_serotype <- factor(subset_data$ksi_serotype)

mpn_values <- subset_data[,c("Salm_MPN","value_type")]
mpn_values$Salm_MPN <- as.character(mpn_values$Salm_MPN)
mpn_values$Salm_MPN <- str_replace_all(mpn_values$Salm_MPN,"<","")
mpn_values$Salm_MPN <- str_replace_all(mpn_values$Salm_MPN,">","")
mpn_values$Salm_MPN <- as.numeric(mpn_values$Salm_MPN)
mpn_values$left <- NA
mpn_values$right <- NA

i <- 1
while (i<=length(mpn_values$Salm_MPN)) {
  if (is.na(mpn_values$value_type[i])) {
    mpn_values$left[i] <- NA
    mpn_values$right[i] <- NA
  } else if (mpn_values$value_type[i]=="cutoff_left") {
    mpn_values$left[i] <- NA
    mpn_values$right[i] <- mpn_values$Salm_MPN[i]
  } else if (mpn_values$value_type[i]=="cutoff_right") {
    mpn_values$left[i] <- mpn_values$Salm_MPN[i]
    mpn_values$right[i] <- NA
  } else if (mpn_values$value_type[i]=="value") {
    mpn_values$left[i] <- mpn_values$Salm_MPN[i]
    mpn_values$right[i] <- mpn_values$Salm_MPN[i]
  }
  i <- i+1
}
left_right_table <- mpn_values[,c("left","right")]
left_right_table <- left_right_table[-which(is.na(left_right_table$left) & is.na(left_right_table$right)),]
fit_dist_comminuted_censor_fitdistcens_short <- fitdistrplus::fitdistcens(log10(left_right_table), "norm")

cat(paste0("\nMean: ", (as.numeric(fit_dist_comminuted_censor_fitdistcens_short$estimate[1])), " SD: ", (as.numeric(fit_dist_comminuted_censor_fitdistcens_short$estimate[2])), "\n"))
fitted_count_ground((as.numeric(fit_dist_comminuted_censor_fitdistcens_short$estimate[1])), (as.numeric(fit_dist_comminuted_censor_fitdistcens_short$estimate[2])))
new_row <- data.frame(
  file=input_list[1],
  scenario="comminuted",
  fit_type="mpn_fitdistcens_log10norm_short",
  total=total,
  positives=positives,
  positives_pct=positives_pct,
  negatives=negatives,
  negatives_pct=negatives_pct,
  product_type="ground",
  positive_threshold=1/325,
  over_1_cfu=over_1_cfu,
  over_1_cfu_pct=over_1_cfu_pct,
  over_10_cfu=over_10_cfu,
  over_10_cfu_pct=over_10_cfu_pct,
  total_serotype_hits=sum((summary(subset_data$ksi_serotype)[c(1:5)])),
  ksi_serotypes_missing=length(which(subset_data$Salmonella=="Positive" & is.na(subset_data$Serotype))),
  ksi_serotype_hits=sum((summary(subset_data$ksi_serotype)[c(1:3,5)])),
  ksi_enteritidis=as.numeric(summary(subset_data$ksi_serotype)[1]),
  ksi_enteritidis_pct=as.numeric(summary(subset_data$ksi_serotype)[1])/sum((summary(subset_data$ksi_serotype)[c(1:5)]))*100,
  ksi_typhimurium=as.numeric(summary(subset_data$ksi_serotype)[5]),
  ksi_typhimurium_pct=as.numeric(summary(subset_data$ksi_serotype)[5])/sum((summary(subset_data$ksi_serotype)[c(1:5)]))*100,
  ksi_infantis=as.numeric(summary(subset_data$ksi_serotype)[2]),
  ksi_infantis_pct=as.numeric(summary(subset_data$ksi_serotype)[2])/sum((summary(subset_data$ksi_serotype)[c(1:5)]))*100,
  ksi_kentucky=as.numeric(summary(subset_data$ksi_serotype)[3]),
  ksi_kentucky_pct=as.numeric(summary(subset_data$ksi_serotype)[3])/sum((summary(subset_data$ksi_serotype)[c(1:5)]))*100,
  ksi_other=as.numeric(summary(subset_data$ksi_serotype)[4]),
  ksi_other_pct=as.numeric(summary(subset_data$ksi_serotype)[4])/sum((summary(subset_data$ksi_serotype)[c(1:5)]))*100,
  mean=(as.numeric(fit_dist_comminuted_censor_fitdistcens_short$estimate[1])),
  sd=(as.numeric(fit_dist_comminuted_censor_fitdistcens_short$estimate[2])),
  positives_pct_fit=fitted_count_ground_return((as.numeric(fit_dist_comminuted_censor_fitdistcens_short$estimate[1])), (as.numeric(fit_dist_comminuted_censor_fitdistcens_short$estimate[2])))[3],
  negatives_pct_fit=fitted_count_ground_return((as.numeric(fit_dist_comminuted_censor_fitdistcens_short$estimate[1])), (as.numeric(fit_dist_comminuted_censor_fitdistcens_short$estimate[2])))[4],
  over_1_cfu_pct_fit=fitted_count_ground_return((as.numeric(fit_dist_comminuted_censor_fitdistcens_short$estimate[1])), (as.numeric(fit_dist_comminuted_censor_fitdistcens_short$estimate[2])))[2],
  over_10_cfu_pct_fit=fitted_count_ground_return((as.numeric(fit_dist_comminuted_censor_fitdistcens_short$estimate[1])), (as.numeric(fit_dist_comminuted_censor_fitdistcens_short$estimate[2])))[1]
)
fit_row_comminuted_censor_fitdistcens_short <- new_row
```

```{r 1-Sample_results DI.csv fitdistcens_full, echo=FALSE}
paste0("1-Sample_results DI.csv")
paste0(path_raw_data, "/", input_list[1])
input_data <- read.csv(paste0(path_raw_data, "/", input_list[1]))
# Remove empty columns
clean_data <- dplyr::select(input_data, -c("X","X.1","X.2","X.3","X.4","X.5","X.6","X.7","X.8","X.9"))
# Format dates correctly
clean_data$collectdt <- as.Date(clean_data$collectdt, tryFormats = "%m/%d/%Y")
# Convert projectcd to factors
clean_data$projectcd <- as.factor(clean_data$projectcd)
# Convert ssNM to factors
clean_data$ssNm <- as.factor(clean_data$ssNm)
# Convert Salmonella to factors
clean_data$Salmonella <- as.factor(clean_data$Salmonella)
# Convert Serotype to factors and convert blanks to NA
clean_data$Serotype <- as.factor(clean_data$Serotype)
clean_data$Serotype[which(clean_data$Serotype=="")] <- NA
clean_data$Serotype <- factor(clean_data$Serotype)
# Convert Salm_MPN_Comb to factors, add leading zeros if necessary
clean_data$Salm_MPN_Comb <- as.character(clean_data$Salm_MPN_Comb)
clean_data$Salm_MPN_Comb[which(!is.na(clean_data$Salm_MPN_Comb))] <- sprintf("%05d",as.numeric(clean_data$Salm_MPN_Comb[which(!is.na(clean_data$Salm_MPN_Comb))]))
clean_data$Salm_MPN_Comb[which(clean_data$Salm_MPN_Comb=="   NA")] <- NA
clean_data$Salm_MPN_Comb <- factor(clean_data$Salm_MPN_Comb)
# Split MPN results to individual columns
mpn_columns <- as.data.frame(t(as.data.frame(strsplit(as.character(clean_data$Salm_MPN_Comb),""))))
colnames(mpn_columns) <- c("MPN_Tube_1","MPN_Tube_2","MPN_Tube_3","MPN_Tube_4","MPN_Tube_5")
rownames(mpn_columns) <- seq(1,dim(mpn_columns)[1])
mpn_columns$MPN_Tube_1 <- as.numeric(mpn_columns$MPN_Tube_1)
mpn_columns$MPN_Tube_2 <- as.numeric(mpn_columns$MPN_Tube_2)
mpn_columns$MPN_Tube_3 <- as.numeric(mpn_columns$MPN_Tube_3)
mpn_columns$MPN_Tube_4 <- as.numeric(mpn_columns$MPN_Tube_4)
mpn_columns$MPN_Tube_5 <- as.numeric(mpn_columns$MPN_Tube_5)
clean_data <- cbind(clean_data,mpn_columns)
# Convert Salm_Qualit_MPN to factors
clean_data$Salm_Qualit_MPN <- as.factor(clean_data$Salm_Qualit_MPN)

clean_data$value_type <- NA
clean_data$value_type[grepl("<",clean_data$Salm_MPN)] <- ("cutoff_left")
clean_data$value_type[grepl(">",clean_data$Salm_MPN)] <- ("cutoff_right")
clean_data$value_type[which(!grepl("<",clean_data$Salm_MPN) & !grepl(">",clean_data$Salm_MPN) & !is.na(clean_data$Salm_MPN))] <- "value"
clean_data$value_type <- factor(clean_data$value_type)
# Convert Salm_MPN to factors
clean_data$Salm_MPN <- as.factor(clean_data$Salm_MPN)
# Drop data rows with problems
# clean_data <- clean_data[which(clean_data$Salm_MPN!="25-24 Lab Problem - Resources or Personnel not available due to emergency response"),]
# clean_data <- clean_data[which(clean_data$Salm_MPN!="No Reserve"),]
# clean_data <- clean_data[which(clean_data$Salm_MPN!="9.3; <0.03"),] 

subset_data <- clean_data[clean_data$projectcd=="HC_CH_COM01",]
rownames(subset_data) <- seq(1, dim(subset_data)[1])

subset_data <- subset_data[-which(subset_data$Salm_MPN=="25-24 Lab Problem - Resources or Personnel not available due to emergency response"),]
subset_data <- subset_data[-which(subset_data$Salm_MPN=="9.3; <0.03"),] # Weird/confused MPN value and no tubes

# n_total <- dim(subset_data)[1] # Rows
# Problem: many positive samples are not enumerated
pct_positive <- round(as.numeric(summary(subset_data$Salmonella)/sum(as.numeric(summary(subset_data$Salmonella)))*100)[2],1) # Use positive percentage to back-calculate n_total based on proportions
n_total <- round(sum(!is.na(subset_data$Salm_MPN_Comb))*(100/pct_positive),0)
n_pos_test <- sum(!is.na(subset_data$Salm_MPN_Comb))
# n_pos_test <- 398
n_pos_test_mpn <- sum(!is.na(subset_data$Salm_MPN_Comb)) # Salm_MPN_Comb
# n_pos_test_mpn <- 398

paste0("Left Cutoff")
summary(factor(subset_data$Salm_MPN[which(subset_data$value_type=="cutoff_left")]))
paste0("Right Cutoff")
summary(factor(subset_data$Salm_MPN[which(subset_data$value_type=="cutoff_right")]))
paste0("Values")
summary(factor(subset_data$Salm_MPN[which(subset_data$value_type=="value")]))

cfu_threshold_cut(10, subset_data$Salm_MPN, subset_data$value_type, 2)
cfu_threshold_cut(1, subset_data$Salm_MPN, subset_data$value_type, 2)
cfu_threshold_cut(1/10, subset_data$Salm_MPN, subset_data$value_type, 2)
cfu_threshold_cut(1/30, subset_data$Salm_MPN, subset_data$value_type, 2)
cfu_threshold_cut(1/325, subset_data$Salm_MPN, subset_data$value_type, 2)

over_10_cfu <- cfu_threshold_cut_return(10, subset_data$Salm_MPN, subset_data$value_type, NA)[1]
over_10_cfu_pct <- cfu_threshold_cut_return(10, subset_data$Salm_MPN, subset_data$value_type, NA)[2]

over_1_cfu <- cfu_threshold_cut_return(1, subset_data$Salm_MPN, subset_data$value_type, NA)[1]
over_1_cfu_pct <- cfu_threshold_cut_return(1, subset_data$Salm_MPN, subset_data$value_type, NA)[2]


paste0("Positives: ", sum(subset_data$Salmonella=="Positive"), " (", round(sum(subset_data$Salmonella=="Positive")/length(subset_data$Salmonella)*100,2), "%)")
paste0("Negatives: ", sum(subset_data$Salmonella=="Negative"), " (", round(sum(subset_data$Salmonella=="Negative")/length(subset_data$Salmonella)*100,2), "%)")
paste0("Total: ", length(subset_data$Salmonella))
total <- length(subset_data$Salmonella)
positives <- sum(subset_data$Salmonella=="Positive")
positives_pct <- sum(subset_data$Salmonella=="Positive")/length(subset_data$Salmonella)*100
negatives <- sum(subset_data$Salmonella=="Negative")
negatives_pct <- sum(subset_data$Salmonella=="Negative")/length(subset_data$Salmonella)*100

subset_data$ksi_serotype <- NA
i <- 1
while (i <= length(subset_data$Serotype)) {
  if (is.na(subset_data$Serotype[i])) {
    subset_data$ksi_serotype[i] <- NA
  } else if(subset_data$Serotype[i]=="Enteritidis"|subset_data$Serotype[i]=="Infantis"|subset_data$Serotype[i]=="Kentucky"|subset_data$Serotype[i]=="Typhimurium") {
    subset_data$ksi_serotype[i] <- as.character(subset_data$Serotype[i])
  } else {
    subset_data$ksi_serotype[i] <- "Other"
  }
  i <- i+1
}
subset_data$ksi_serotype <- factor(subset_data$ksi_serotype)

mpn_values <- subset_data[,c("Salm_MPN","value_type")]
colnames(mpn_values) <- c("Salm_MPN", "value_type")
mpn_values$Salm_MPN <- as.character(mpn_values$Salm_MPN)
mpn_values$Salm_MPN <- str_replace_all(mpn_values$Salm_MPN,"<","")
mpn_values$Salm_MPN <- str_replace_all(mpn_values$Salm_MPN,">","")
mpn_values$Salm_MPN <- as.numeric(mpn_values$Salm_MPN)
mpn_values$left <- NA
mpn_values$right <- NA

i <- 1
while (i<=length(mpn_values$Salm_MPN)) {
  if (is.na(mpn_values$value_type[i])) {
    mpn_values$left[i] <- NA
    mpn_values$right[i] <- min(mpn_values$Salm_MPN, na.rm = TRUE)
  } else if (mpn_values$value_type[i]=="cutoff_left") {
    mpn_values$left[i] <- NA
    mpn_values$right[i] <- mpn_values$Salm_MPN[i]
  } else if (mpn_values$value_type[i]=="cutoff_right") {
    mpn_values$left[i] <- mpn_values$Salm_MPN[i]
    mpn_values$right[i] <- NA
  } else if (mpn_values$value_type[i]=="value") {
    mpn_values$left[i] <- mpn_values$Salm_MPN[i]
    mpn_values$right[i] <- mpn_values$Salm_MPN[i]
  }
  i <- i+1
}
left_right_table <- mpn_values[,c("left","right")]
# left_right_table <- left_right_table[which(!is.na(left_right_table$left) & !is.na(left_right_table$right)),]
fit_dist_comminuted_censor_fitdistcens_full <- fitdistrplus::fitdistcens(log10(left_right_table), "norm")

cat(paste0("\nMean: ", (as.numeric(fit_dist_comminuted_censor_fitdistcens_full$estimate[1])), " SD: ", (as.numeric(fit_dist_comminuted_censor_fitdistcens_full$estimate[2])), "\n"))
fitted_count_ground((as.numeric(fit_dist_comminuted_censor_fitdistcens_full$estimate[1])), (as.numeric(fit_dist_comminuted_censor_fitdistcens_full$estimate[2])))
new_row <- data.frame(
  file=input_list[1],
  scenario="comminuted",
  fit_type="mpn_fitdistcens_log10norm_full",
  total=total,
  positives=positives,
  positives_pct=positives_pct,
  negatives=negatives,
  negatives_pct=negatives_pct,
  product_type="ground",
  positive_threshold=1/325,
  over_1_cfu=over_1_cfu,
  over_1_cfu_pct=over_1_cfu_pct,
  over_10_cfu=over_10_cfu,
  over_10_cfu_pct=over_10_cfu_pct,
  total_serotype_hits=sum((summary(subset_data$ksi_serotype)[c(1:5)])),
  ksi_serotypes_missing=length(which(subset_data$Salmonella=="Positive" & is.na(subset_data$Serotype))),
  ksi_serotype_hits=sum((summary(subset_data$ksi_serotype)[c(1:3,5)])),
  ksi_enteritidis=as.numeric(summary(subset_data$ksi_serotype)[1]),
  ksi_enteritidis_pct=as.numeric(summary(subset_data$ksi_serotype)[1])/sum((summary(subset_data$ksi_serotype)[c(1:5)]))*100,
  ksi_typhimurium=as.numeric(summary(subset_data$ksi_serotype)[5]),
  ksi_typhimurium_pct=as.numeric(summary(subset_data$ksi_serotype)[5])/sum((summary(subset_data$ksi_serotype)[c(1:5)]))*100,
  ksi_infantis=as.numeric(summary(subset_data$ksi_serotype)[2]),
  ksi_infantis_pct=as.numeric(summary(subset_data$ksi_serotype)[2])/sum((summary(subset_data$ksi_serotype)[c(1:5)]))*100,
  ksi_kentucky=as.numeric(summary(subset_data$ksi_serotype)[3]),
  ksi_kentucky_pct=as.numeric(summary(subset_data$ksi_serotype)[3])/sum((summary(subset_data$ksi_serotype)[c(1:5)]))*100,
  ksi_other=as.numeric(summary(subset_data$ksi_serotype)[4]),
  ksi_other_pct=as.numeric(summary(subset_data$ksi_serotype)[4])/sum((summary(subset_data$ksi_serotype)[c(1:5)]))*100,
  mean=(as.numeric(fit_dist_comminuted_censor_fitdistcens_full$estimate[1])),
  sd=(as.numeric(fit_dist_comminuted_censor_fitdistcens_full$estimate[2])),
  positives_pct_fit=fitted_count_ground_return((as.numeric(fit_dist_comminuted_censor_fitdistcens_full$estimate[1])), (as.numeric(fit_dist_comminuted_censor_fitdistcens_full$estimate[2])))[3],
  negatives_pct_fit=fitted_count_ground_return((as.numeric(fit_dist_comminuted_censor_fitdistcens_full$estimate[1])), (as.numeric(fit_dist_comminuted_censor_fitdistcens_full$estimate[2])))[4],
  over_1_cfu_pct_fit=fitted_count_ground_return((as.numeric(fit_dist_comminuted_censor_fitdistcens_full$estimate[1])), (as.numeric(fit_dist_comminuted_censor_fitdistcens_full$estimate[2])))[2],
  over_10_cfu_pct_fit=fitted_count_ground_return((as.numeric(fit_dist_comminuted_censor_fitdistcens_full$estimate[1])), (as.numeric(fit_dist_comminuted_censor_fitdistcens_full$estimate[2])))[1]
)
fit_row_comminuted_censor_fitdistcens_full <- new_row
```

```{r 2-Exploratory_Paired DI.csv fitdistcens_short, echo=FALSE}
paste0("2-Exploratory_Paired DI.csv")
paste0(path_raw_data, "/", input_list[2])
input_data <- read.csv(paste0(path_raw_data, "/", input_list[2]))
# Remove empty columns
clean_data <- dplyr::select(input_data, -c("X","X.1","X.2","X.3"))
# Format dates correctly
clean_data$collectdt <- as.Date(clean_data$collectdt, tryFormats = "%m/%d/%Y")
# Convert HACCPProcessingSize to factors
clean_data$HACCPProcessingSize <- as.factor(clean_data$HACCPProcessingSize)
# Convert ssNm to factors
clean_data$ssNm <- as.factor(clean_data$ssNm)
# Convert RH_DiscardCode to factors
clean_data$RH_DiscardCode <- as.factor(clean_data$RH_DiscardCode)
# Blank RH_Discard_Reason to NAs
clean_data$RH_Discard_Reason[clean_data$RH_Discard_Reason==""] <- NA
# Convert CH_DiscardCode to factors
clean_data$CH_DiscardCode <- as.factor(clean_data$CH_DiscardCode)
# Blank CH_Discard_Reason to NAs
clean_data$CH_Discard_Reason[clean_data$CH_Discard_Reason==""] <- NA
# Convert Salm_RH_Salmonella to factors
clean_data$Salm_RH_Salmonella[which(clean_data$Salm_RH_Salmonella=="")] <- NA
clean_data$Salm_RH_Salmonella <- as.factor(clean_data$Salm_RH_Salmonella)
# Convert Salm_CH_Salmonella to factors
clean_data$Salm_CH_Salmonella[which(clean_data$Salm_CH_Salmonella=="")] <- NA
clean_data$Salm_CH_Salmonella <- as.factor(clean_data$Salm_CH_Salmonella)
# Convert Salm_CH_Serotypes to factors
clean_data$Salm_CH_Serotypes <- as.factor(clean_data$Salm_CH_Serotypes)
# 
clean_data$MT_CH_Salmonella_Quantitative[which(clean_data$MT_CH_Salmonella_Quantitative=="")] <- NA
# 
clean_data$MT_RH_Salmonella_Quantitative[which(clean_data$MT_RH_Salmonella_Quantitative=="")] <- NA
clean_data <- clean_data[which(is.na(clean_data$RH_Discard_Reason)),]
clean_data <- clean_data[which(is.na(clean_data$CH_Discard_Reason)),]
# Rehang ----
paste0("Rehang")
subset_data <- subset(clean_data, select = c("Salm_RH_Salmonella", "MT_RH_Salmonella_Quantitative"))
subset_data <- subset_data[!is.na(subset_data$Salm_RH_Salmonella),]
subset_data$value_type <- NA
subset_data$value_type[grepl("<",subset_data$MT_RH_Salmonella_Quantitative)] <- ("cutoff_left")
subset_data$value_type[grepl(">",subset_data$MT_RH_Salmonella_Quantitative)] <- ("cutoff_right")
subset_data$value_type[which(!grepl("<",subset_data$MT_RH_Salmonella_Quantitative) & !grepl(">",subset_data$MT_RH_Salmonella_Quantitative) & !is.na(subset_data$MT_RH_Salmonella_Quantitative))] <- "value"
subset_data$value_type <- factor(subset_data$value_type)
subset_data <- subset_data[which(!is.na(subset_data$MT_RH_Salmonella_Quantitative) & subset_data$Salm_RH_Salmonella=="Positive" | subset_data$Salm_RH_Salmonella=="Negative"),] # PROBLEM: Positive Salm_RH_Salmonella values with NA MT_RH_Salmonella_Quantitative values; Removed NA rows
paste0("Left Cutoff")
summary(factor(subset_data$MT_RH_Salmonella_Quantitative[which(subset_data$value_type=="cutoff_left")]))
paste0("Right Cutoff")
summary(factor(subset_data$MT_RH_Salmonella_Quantitative[which(subset_data$value_type=="cutoff_right")]))
paste0("Values")
summary(factor(subset_data$MT_RH_Salmonella_Quantitative[which(subset_data$value_type=="value")]))

cfu_threshold_cut(10, subset_data$MT_RH_Salmonella_Quantitative, subset_data$value_type, 2)
cfu_threshold_cut(1, subset_data$MT_RH_Salmonella_Quantitative, subset_data$value_type, 2)
cfu_threshold_cut(1/10, subset_data$MT_RH_Salmonella_Quantitative, subset_data$value_type, 2)
cfu_threshold_cut(1/30, subset_data$MT_RH_Salmonella_Quantitative, subset_data$value_type, 2)
cfu_threshold_cut(1/325, subset_data$MT_RH_Salmonella_Quantitative, subset_data$value_type, 2)

over_10_cfu <- cfu_threshold_cut_return(10, subset_data$MT_RH_Salmonella_Quantitative, subset_data$value_type, NA)[1]
over_10_cfu_pct <- cfu_threshold_cut_return(10, subset_data$MT_RH_Salmonella_Quantitative, subset_data$value_type, NA)[2]

over_1_cfu <- cfu_threshold_cut_return(1, subset_data$MT_RH_Salmonella_Quantitative, subset_data$value_type, NA)[1]
over_1_cfu_pct <- cfu_threshold_cut_return(1, subset_data$MT_RH_Salmonella_Quantitative, subset_data$value_type, NA)[2]

paste0("Positives: ", sum(subset_data$Salm_RH_Salmonella=="Positive"), " (", round(sum(subset_data$Salm_RH_Salmonella=="Positive")/length(subset_data$Salm_RH_Salmonella)*100,2), "%)")
paste0("Negatives: ", sum(subset_data$Salm_RH_Salmonella=="Negative"), " (", round(sum(subset_data$Salm_RH_Salmonella=="Negative")/length(subset_data$Salm_RH_Salmonella)*100,2), "%)")
paste0("Total: ", length(subset_data$Salm_RH_Salmonella))
total <- length(subset_data$Salm_RH_Salmonella)
positives <- sum(subset_data$Salm_RH_Salmonella=="Positive")
positives_pct <- sum(subset_data$Salm_RH_Salmonella=="Positive")/length(subset_data$Salm_RH_Salmonella)*100
negatives <- sum(subset_data$Salm_RH_Salmonella=="Negative")
negatives_pct <- sum(subset_data$Salm_RH_Salmonella=="Negative")/length(subset_data$Salm_RH_Salmonella)*100

subset_data <- subset(subset_data, select = c("Salm_RH_Salmonella", "MT_RH_Salmonella_Quantitative"))
fit_dist_carcass_exploratory_rehang_fitdistcens_short <- qpcr_fit(subset_data, 10^-1.48, 10^1, 10^4, 10^8, "qPCR", FALSE)
cat(paste0("\n Mean: ", fit_dist_carcass_exploratory_rehang_fitdistcens_short$estimate[1], " SD: ", fit_dist_carcass_exploratory_rehang_fitdistcens_short$estimate[2], "\n"))
fitted_count_parts(fit_dist_carcass_exploratory_rehang_fitdistcens_short$estimate[1], fit_dist_carcass_exploratory_rehang_fitdistcens_short$estimate[2])
new_row <- data.frame(
  file=input_list[2],
  scenario="carcass_exploratory_rehang",
  fit_type="qpcr_fitdistcens_log10norm_short",
  total=total,
  positives=positives,
  positives_pct=positives_pct,
  negatives=negatives,
  negatives_pct=negatives_pct,
  product_type="carcass",
  positive_threshold=1/30,
  over_1_cfu=over_1_cfu,
  over_1_cfu_pct=over_1_cfu_pct,
  over_10_cfu=over_10_cfu,
  over_10_cfu_pct=over_10_cfu_pct,
  mean=as.numeric(fit_dist_carcass_exploratory_rehang_fitdistcens_short$estimate[1]),
  sd=as.numeric(fit_dist_carcass_exploratory_rehang_fitdistcens_short$estimate[2]),
  positives_pct_fit=fitted_count_parts_return(fit_dist_carcass_exploratory_rehang_fitdistcens_short$estimate[1], fit_dist_carcass_exploratory_rehang_fitdistcens_short$estimate[2])[3],
  negatives_pct_fit=fitted_count_parts_return(fit_dist_carcass_exploratory_rehang_fitdistcens_short$estimate[1], fit_dist_carcass_exploratory_rehang_fitdistcens_short$estimate[2])[4],
  over_1_cfu_pct_fit=fitted_count_parts_return(fit_dist_carcass_exploratory_rehang_fitdistcens_short$estimate[1], fit_dist_carcass_exploratory_rehang_fitdistcens_short$estimate[2])[2],
  over_10_cfu_pct_fit=fitted_count_parts_return(fit_dist_carcass_exploratory_rehang_fitdistcens_short$estimate[1], fit_dist_carcass_exploratory_rehang_fitdistcens_short$estimate[2])[1]
)
fit_row_carcass_exploratory_rehang_fitdistcens_short <- new_row
# Post Chill ----
paste0("Post Chill")
subset_data <- subset(clean_data, select = c("Salm_CH_Salmonella", "MT_CH_Salmonella_Quantitative"))
subset_data <- subset_data[!is.na(subset_data$Salm_CH_Salmonella),]
subset_data$value_type <- NA
subset_data$value_type[grepl("<",subset_data$MT_CH_Salmonella_Quantitative)] <- ("cutoff_left")
subset_data$value_type[grepl(">",subset_data$MT_CH_Salmonella_Quantitative)] <- ("cutoff_right")
subset_data$value_type[which(!grepl("<",subset_data$MT_CH_Salmonella_Quantitative) & !grepl(">",subset_data$MT_CH_Salmonella_Quantitative) & !is.na(subset_data$MT_CH_Salmonella_Quantitative))] <- "value"
subset_data <- subset_data[which(!is.na(subset_data$MT_CH_Salmonella_Quantitative) & subset_data$Salm_CH_Salmonella=="Positive" | subset_data$Salm_CH_Salmonella=="Negative"),] # PROBLEM: Positive Salm_RH_Salmonella values with NA MT_CH_Salmonella_Quantitative values; Removed NA rows
paste0("Left Cutoff")
summary(factor(subset_data$MT_CH_Salmonella_Quantitative[which(subset_data$value_type=="cutoff_left")]))
paste0("Right Cutoff")
summary(factor(subset_data$MT_CH_Salmonella_Quantitative[which(subset_data$value_type=="cutoff_right")]))
paste0("Values")
summary(factor(subset_data$MT_CH_Salmonella_Quantitative[which(subset_data$value_type=="value")]))

cfu_threshold_cut(10, subset_data$MT_CH_Salmonella_Quantitative, subset_data$value_type, 2)
cfu_threshold_cut(1, subset_data$MT_CH_Salmonella_Quantitative, subset_data$value_type, 2)
cfu_threshold_cut(1/10, subset_data$MT_CH_Salmonella_Quantitative, subset_data$value_type, 2)
cfu_threshold_cut(1/30, subset_data$MT_CH_Salmonella_Quantitative, subset_data$value_type, 2)
cfu_threshold_cut(1/325, subset_data$MT_CH_Salmonella_Quantitative, subset_data$value_type, 2)

over_10_cfu <- cfu_threshold_cut_return(10, subset_data$MT_CH_Salmonella_Quantitative, subset_data$value_type, NA)[1]
over_10_cfu_pct <- cfu_threshold_cut_return(10, subset_data$MT_CH_Salmonella_Quantitative, subset_data$value_type, NA)[2]

over_1_cfu <- cfu_threshold_cut_return(1, subset_data$MT_CH_Salmonella_Quantitative, subset_data$value_type, NA)[1]
over_1_cfu_pct <- cfu_threshold_cut_return(1, subset_data$MT_CH_Salmonella_Quantitative, subset_data$value_type, NA)[2]

paste0("Positives: ", sum(subset_data$Salm_CH_Salmonella=="Positive"), " (", round(sum(subset_data$Salm_CH_Salmonella=="Positive")/length(subset_data$Salm_CH_Salmonella)*100,2), "%)")
paste0("Negatives: ", sum(subset_data$Salm_CH_Salmonella=="Negative"), " (", round(sum(subset_data$Salm_CH_Salmonella=="Negative")/length(subset_data$Salm_CH_Salmonella)*100,2), "%)")
paste0("Total: ", length(subset_data$Salm_CH_Salmonella))
total <- length(subset_data$Salm_CH_Salmonella)
positives <- sum(subset_data$Salm_CH_Salmonella=="Positive")
positives_pct <- sum(subset_data$Salm_CH_Salmonella=="Positive")/length(subset_data$Salm_CH_Salmonella)*100
negatives <- sum(subset_data$Salm_CH_Salmonella=="Negative")
negatives_pct <- sum(subset_data$Salm_CH_Salmonella=="Negative")/length(subset_data$Salm_CH_Salmonella)*100

subset_data <- subset(subset_data, select = c("Salm_CH_Salmonella", "MT_CH_Salmonella_Quantitative"))
fit_dist_carcass_exploratory_rehang_fitdistcens_short <- qpcr_fit(subset_data, 10^-1.48, 10^1, 10^4, 10^8, "qPCR", FALSE)
cat(paste0("\n Mean: ", fit_dist_carcass_exploratory_rehang_fitdistcens_short$estimate[1], " SD: ", fit_dist_carcass_exploratory_rehang_fitdistcens_short$estimate[2], "\n"))
fitted_count_parts(fit_dist_carcass_exploratory_rehang_fitdistcens_short$estimate[1], fit_dist_carcass_exploratory_rehang_fitdistcens_short$estimate[2])
new_row <- data.frame(
  file=input_list[2],
  scenario="carcass_exploratory_post_chill",
  fit_type="qpcr_fitdistcens_log10norm_short",
  total=total,
  positives=positives,
  positives_pct=positives_pct,
  negatives=negatives,
  negatives_pct=negatives_pct,
  product_type="carcass",
  positive_threshold=1/30,
  over_1_cfu=over_1_cfu,
  over_1_cfu_pct=over_1_cfu_pct,
  over_10_cfu=over_10_cfu,
  over_10_cfu_pct=over_10_cfu_pct,
  mean=as.numeric(fit_dist_carcass_exploratory_rehang_fitdistcens_short$estimate[1]),
  sd=as.numeric(fit_dist_carcass_exploratory_rehang_fitdistcens_short$estimate[2]),
  positives_pct_fit=fitted_count_parts_return(fit_dist_carcass_exploratory_rehang_fitdistcens_short$estimate[1], fit_dist_carcass_exploratory_rehang_fitdistcens_short$estimate[2])[3],
  negatives_pct_fit=fitted_count_parts_return(fit_dist_carcass_exploratory_rehang_fitdistcens_short$estimate[1], fit_dist_carcass_exploratory_rehang_fitdistcens_short$estimate[2])[4],
  over_1_cfu_pct_fit=fitted_count_parts_return(fit_dist_carcass_exploratory_rehang_fitdistcens_short$estimate[1], fit_dist_carcass_exploratory_rehang_fitdistcens_short$estimate[2])[2],
  over_10_cfu_pct_fit=fitted_count_parts_return(fit_dist_carcass_exploratory_rehang_fitdistcens_short$estimate[1], fit_dist_carcass_exploratory_rehang_fitdistcens_short$estimate[2])[1]
)
fit_row_carcass_exploratory_post_chill_fitdistcens_short <- new_row
```

```{r 2-Exploratory_Paired DI.csv fitdistcens_full, echo=FALSE}
paste0("2-Exploratory_Paired DI.csv")
paste0(path_raw_data, "/", input_list[2])
input_data <- read.csv(paste0(path_raw_data, "/", input_list[2]))
# Remove empty columns
clean_data <- dplyr::select(input_data, -c("X","X.1","X.2","X.3"))
# Format dates correctly
clean_data$collectdt <- as.Date(clean_data$collectdt, tryFormats = "%m/%d/%Y")
# Convert HACCPProcessingSize to factors
clean_data$HACCPProcessingSize <- as.factor(clean_data$HACCPProcessingSize)
# Convert ssNm to factors
clean_data$ssNm <- as.factor(clean_data$ssNm)
# Convert RH_DiscardCode to factors
clean_data$RH_DiscardCode <- as.factor(clean_data$RH_DiscardCode)
# Blank RH_Discard_Reason to NAs
clean_data$RH_Discard_Reason[clean_data$RH_Discard_Reason==""] <- NA
# Convert CH_DiscardCode to factors
clean_data$CH_DiscardCode <- as.factor(clean_data$CH_DiscardCode)
# Blank CH_Discard_Reason to NAs
clean_data$CH_Discard_Reason[clean_data$CH_Discard_Reason==""] <- NA
# Convert Salm_RH_Salmonella to factors
clean_data$Salm_RH_Salmonella[which(clean_data$Salm_RH_Salmonella=="")] <- NA
clean_data$Salm_RH_Salmonella <- as.factor(clean_data$Salm_RH_Salmonella)
# Convert Salm_CH_Salmonella to factors
clean_data$Salm_CH_Salmonella[which(clean_data$Salm_CH_Salmonella=="")] <- NA
clean_data$Salm_CH_Salmonella <- as.factor(clean_data$Salm_CH_Salmonella)
# Convert Salm_CH_Serotypes to factors
clean_data$Salm_CH_Serotypes <- as.factor(clean_data$Salm_CH_Serotypes)
# 
clean_data$MT_CH_Salmonella_Quantitative[which(clean_data$MT_CH_Salmonella_Quantitative=="")] <- NA
# 
clean_data$MT_RH_Salmonella_Quantitative[which(clean_data$MT_RH_Salmonella_Quantitative=="")] <- NA
clean_data <- clean_data[which(is.na(clean_data$RH_Discard_Reason)),]
clean_data <- clean_data[which(is.na(clean_data$CH_Discard_Reason)),]
# Rehang ----
paste0("Rehang")
subset_data <- subset(clean_data, select = c("Salm_RH_Salmonella", "MT_RH_Salmonella_Quantitative"))
subset_data <- subset_data[!is.na(subset_data$Salm_RH_Salmonella),]
subset_data$value_type <- NA
subset_data$value_type[grepl("<",subset_data$MT_RH_Salmonella_Quantitative)] <- ("cutoff_left")
subset_data$value_type[grepl(">",subset_data$MT_RH_Salmonella_Quantitative)] <- ("cutoff_right")
subset_data$value_type[which(!grepl("<",subset_data$MT_RH_Salmonella_Quantitative) & !grepl(">",subset_data$MT_RH_Salmonella_Quantitative) & !is.na(subset_data$MT_RH_Salmonella_Quantitative))] <- "value"
subset_data$value_type <- factor(subset_data$value_type)
subset_data <- subset_data[which(!is.na(subset_data$MT_RH_Salmonella_Quantitative) & subset_data$Salm_RH_Salmonella=="Positive" | subset_data$Salm_RH_Salmonella=="Negative"),] # PROBLEM: Positive Salm_RH_Salmonella values with NA MT_RH_Salmonella_Quantitative values; Removed NA rows
paste0("Left Cutoff")
summary(factor(subset_data$MT_RH_Salmonella_Quantitative[which(subset_data$value_type=="cutoff_left")]))
paste0("Right Cutoff")
summary(factor(subset_data$MT_RH_Salmonella_Quantitative[which(subset_data$value_type=="cutoff_right")]))
paste0("Values")
summary(factor(subset_data$MT_RH_Salmonella_Quantitative[which(subset_data$value_type=="value")]))

cfu_threshold_cut(10, subset_data$MT_RH_Salmonella_Quantitative, subset_data$value_type, 2)
cfu_threshold_cut(1, subset_data$MT_RH_Salmonella_Quantitative, subset_data$value_type, 2)
cfu_threshold_cut(1/10, subset_data$MT_RH_Salmonella_Quantitative, subset_data$value_type, 2)
cfu_threshold_cut(1/30, subset_data$MT_RH_Salmonella_Quantitative, subset_data$value_type, 2)
cfu_threshold_cut(1/325, subset_data$MT_RH_Salmonella_Quantitative, subset_data$value_type, 2)

over_10_cfu <- cfu_threshold_cut_return(10, subset_data$MT_RH_Salmonella_Quantitative, subset_data$value_type, NA)[1]
over_10_cfu_pct <- cfu_threshold_cut_return(10, subset_data$MT_RH_Salmonella_Quantitative, subset_data$value_type, NA)[2]

over_1_cfu <- cfu_threshold_cut_return(1, subset_data$MT_RH_Salmonella_Quantitative, subset_data$value_type, NA)[1]
over_1_cfu_pct <- cfu_threshold_cut_return(1, subset_data$MT_RH_Salmonella_Quantitative, subset_data$value_type, NA)[2]

paste0("Positives: ", sum(subset_data$Salm_RH_Salmonella=="Positive"), " (", round(sum(subset_data$Salm_RH_Salmonella=="Positive")/length(subset_data$Salm_RH_Salmonella)*100,2), "%)")
paste0("Negatives: ", sum(subset_data$Salm_RH_Salmonella=="Negative"), " (", round(sum(subset_data$Salm_RH_Salmonella=="Negative")/length(subset_data$Salm_RH_Salmonella)*100,2), "%)")
paste0("Total: ", length(subset_data$Salm_RH_Salmonella))
total <- length(subset_data$Salm_RH_Salmonella)
positives <- sum(subset_data$Salm_RH_Salmonella=="Positive")
positives_pct <- sum(subset_data$Salm_RH_Salmonella=="Positive")/length(subset_data$Salm_RH_Salmonella)*100
negatives <- sum(subset_data$Salm_RH_Salmonella=="Negative")
negatives_pct <- sum(subset_data$Salm_RH_Salmonella=="Negative")/length(subset_data$Salm_RH_Salmonella)*100

subset_data <- subset(subset_data, select = c("Salm_RH_Salmonella", "MT_RH_Salmonella_Quantitative"))
fit_fit_carcass_exploratory_rehang_fitdistcens_full <- qpcr_fit(subset_data, 10^-1.48, 10^1, 10^4, 10^8, "qPCR")
cat(paste0("\n Mean: ", rh_fit$estimate[1], " SD: ", rh_fit$estimate[2], "\n"))
fitted_count_parts(rh_fit$estimate[1], rh_fit$estimate[2])
new_row <- data.frame(
  file=input_list[2],
  scenario="carcass_exploratory_rehang",
  fit_type="qpcr_fitdistcens_log10norm_full",
  total=total,
  positives=positives,
  positives_pct=positives_pct,
  negatives=negatives,
  negatives_pct=negatives_pct,
  product_type="carcass",
  positive_threshold=1/30,
  over_1_cfu=over_1_cfu,
  over_1_cfu_pct=over_1_cfu_pct,
  over_10_cfu=over_10_cfu,
  over_10_cfu_pct=over_10_cfu_pct,
  mean=as.numeric(fit_fit_carcass_exploratory_rehang_fitdistcens_full$estimate[1]),
  sd=as.numeric(fit_fit_carcass_exploratory_rehang_fitdistcens_full$estimate[2]),
  positives_pct_fit=fitted_count_parts_return(fit_fit_carcass_exploratory_rehang_fitdistcens_full$estimate[1], fit_fit_carcass_exploratory_rehang_fitdistcens_full$estimate[2])[3],
  negatives_pct_fit=fitted_count_parts_return(fit_fit_carcass_exploratory_rehang_fitdistcens_full$estimate[1], fit_fit_carcass_exploratory_rehang_fitdistcens_full$estimate[2])[4],
  over_1_cfu_pct_fit=fitted_count_parts_return(fit_fit_carcass_exploratory_rehang_fitdistcens_full$estimate[1], fit_fit_carcass_exploratory_rehang_fitdistcens_full$estimate[2])[2],
  over_10_cfu_pct_fit=fitted_count_parts_return(fit_fit_carcass_exploratory_rehang_fitdistcens_full$estimate[1], fit_fit_carcass_exploratory_rehang_fitdistcens_full$estimate[2])[1]
)
fit_row_carcass_exploratory_rehang_fitdistcens_full <- new_row
# Post Chill ----
paste0("Post Chill")
subset_data <- subset(clean_data, select = c("Salm_CH_Salmonella", "MT_CH_Salmonella_Quantitative"))
subset_data <- subset_data[!is.na(subset_data$Salm_CH_Salmonella),]
subset_data$value_type <- NA
subset_data$value_type[grepl("<",subset_data$MT_CH_Salmonella_Quantitative)] <- ("cutoff_left")
subset_data$value_type[grepl(">",subset_data$MT_CH_Salmonella_Quantitative)] <- ("cutoff_right")
subset_data$value_type[which(!grepl("<",subset_data$MT_CH_Salmonella_Quantitative) & !grepl(">",subset_data$MT_CH_Salmonella_Quantitative) & !is.na(subset_data$MT_CH_Salmonella_Quantitative))] <- "value"
subset_data <- subset_data[which(!is.na(subset_data$MT_CH_Salmonella_Quantitative) & subset_data$Salm_CH_Salmonella=="Positive" | subset_data$Salm_CH_Salmonella=="Negative"),] # PROBLEM: Positive Salm_RH_Salmonella values with NA MT_CH_Salmonella_Quantitative values; Removed NA rows
paste0("Left Cutoff")
summary(factor(subset_data$MT_CH_Salmonella_Quantitative[which(subset_data$value_type=="cutoff_left")]))
paste0("Right Cutoff")
summary(factor(subset_data$MT_CH_Salmonella_Quantitative[which(subset_data$value_type=="cutoff_right")]))
paste0("Values")
summary(factor(subset_data$MT_CH_Salmonella_Quantitative[which(subset_data$value_type=="value")]))

cfu_threshold_cut(10, subset_data$MT_CH_Salmonella_Quantitative, subset_data$value_type, 2)
cfu_threshold_cut(1, subset_data$MT_CH_Salmonella_Quantitative, subset_data$value_type, 2)
cfu_threshold_cut(1/10, subset_data$MT_CH_Salmonella_Quantitative, subset_data$value_type, 2)
cfu_threshold_cut(1/30, subset_data$MT_CH_Salmonella_Quantitative, subset_data$value_type, 2)
cfu_threshold_cut(1/325, subset_data$MT_CH_Salmonella_Quantitative, subset_data$value_type, 2)

over_10_cfu <- cfu_threshold_cut_return(10, subset_data$MT_CH_Salmonella_Quantitative, subset_data$value_type, NA)[1]
over_10_cfu_pct <- cfu_threshold_cut_return(10, subset_data$MT_CH_Salmonella_Quantitative, subset_data$value_type, NA)[2]

over_1_cfu <- cfu_threshold_cut_return(1, subset_data$MT_CH_Salmonella_Quantitative, subset_data$value_type, NA)[1]
over_1_cfu_pct <- cfu_threshold_cut_return(1, subset_data$MT_CH_Salmonella_Quantitative, subset_data$value_type, NA)[2]

paste0("Positives: ", sum(subset_data$Salm_CH_Salmonella=="Positive"), " (", round(sum(subset_data$Salm_CH_Salmonella=="Positive")/length(subset_data$Salm_CH_Salmonella)*100,2), "%)")
paste0("Negatives: ", sum(subset_data$Salm_CH_Salmonella=="Negative"), " (", round(sum(subset_data$Salm_CH_Salmonella=="Negative")/length(subset_data$Salm_CH_Salmonella)*100,2), "%)")
paste0("Total: ", length(subset_data$Salm_CH_Salmonella))
total <- length(subset_data$Salm_CH_Salmonella)
positives <- sum(subset_data$Salm_CH_Salmonella=="Positive")
positives_pct <- sum(subset_data$Salm_CH_Salmonella=="Positive")/length(subset_data$Salm_CH_Salmonella)*100
negatives <- sum(subset_data$Salm_CH_Salmonella=="Negative")
negatives_pct <- sum(subset_data$Salm_CH_Salmonella=="Negative")/length(subset_data$Salm_CH_Salmonella)*100

subset_data <- subset(subset_data, select = c("Salm_CH_Salmonella", "MT_CH_Salmonella_Quantitative"))
fit_fit_carcass_exploratory_post_chill_fitdistcens_full <- qpcr_fit(subset_data, 10^-1.48, 10^1, 10^4, 10^8, "qPCR")
cat(paste0("\n Mean: ", fit_fit_carcass_exploratory_post_chill_fitdistcens_full$estimate[1], " SD: ", ch_fit$estimate[2], "\n"))
fitted_count_parts(fit_fit_carcass_exploratory_post_chill_fitdistcens_full$estimate[1], ch_fit$estimate[2])
new_row <- data.frame(
  file=input_list[2],
  scenario="carcass_exploratory_post_chill",
  fit_type="qpcr_fitdistcens_log10norm_full",
  total=total,
  positives=positives,
  positives_pct=positives_pct,
  negatives=negatives,
  negatives_pct=negatives_pct,
  product_type="carcass",
  positive_threshold=1/30,
  over_1_cfu=over_1_cfu,
  over_1_cfu_pct=over_1_cfu_pct,
  over_10_cfu=over_10_cfu,
  over_10_cfu_pct=over_10_cfu_pct,
  mean=as.numeric(fit_fit_carcass_exploratory_post_chill_fitdistcens_full$estimate[1]),
  sd=as.numeric(fit_fit_carcass_exploratory_post_chill_fitdistcens_full$estimate[2]),
  positives_pct_fit=fitted_count_parts_return(fit_fit_carcass_exploratory_post_chill_fitdistcens_full$estimate[1], fit_fit_carcass_exploratory_post_chill_fitdistcens_full$estimate[2])[3],
  negatives_pct_fit=fitted_count_parts_return(fit_fit_carcass_exploratory_post_chill_fitdistcens_full$estimate[1], fit_fit_carcass_exploratory_post_chill_fitdistcens_full$estimate[2])[4],
  over_1_cfu_pct_fit=fitted_count_parts_return(fit_fit_carcass_exploratory_post_chill_fitdistcens_full$estimate[1], fit_fit_carcass_exploratory_post_chill_fitdistcens_full$estimate[2])[2],
  over_10_cfu_pct_fit=fitted_count_parts_return(fit_fit_carcass_exploratory_post_chill_fitdistcens_full$estimate[1], fit_fit_carcass_exploratory_post_chill_fitdistcens_full$estimate[2])[1]
)
fit_row_carcass_exploratory_post_chill_fitdistcens_full <- new_row
```

```{r 3-2012_RCPBS_2496_samples DI.xlsx Ebel, echo=FALSE}
paste0("3-2012_RCPBS_2496_samples DI.xlsx")
paste0(path_raw_data, "/", input_list[3])
input_data <- readxl::read_xlsx(paste0(path_raw_data, "/", input_list[3]), sheet = "Sheet1")
# Remove empty columns
clean_data <- dplyr::select(input_data, c("projectid","date_collected","date_mailed","product_name","date_received","sal_bax","sal","sal_mpn_tubes","sal_mpn","sal_group","sal_type","sal_phage"))
# Convert projectid to factors
clean_data$projectid <- as.factor(clean_data$projectid)
# Format dates correctly
clean_data$date_collected <- as.Date(clean_data$date_collected, tryFormats = "%Y-%m-%d")
clean_data$date_mailed <- as.Date(clean_data$date_mailed, tryFormats = "%Y-%m-%d")
clean_data$date_received <- as.Date(clean_data$date_received, tryFormats = "%Y-%m-%d")
# Convert product_name to factors
clean_data$product_name <- as.factor(clean_data$product_name)
# Convert sal_bax to factors
clean_data$sal_bax <- as.factor(clean_data$sal_bax)
# Convert sal to factors
clean_data$sal <- as.factor(clean_data$sal)
# Convert sal_mpn_tubes to factors
clean_data$sal_mpn_tubes <- as.factor(clean_data$sal_mpn_tubes)
# Convert sal_group to factors
clean_data$sal_group <- as.factor(clean_data$sal_group)
# Convert sal_type to factors
clean_data$sal_type <- as.factor(clean_data$sal_type)
# Convert sal_phage to factors
clean_data$sal_phage <- as.factor(clean_data$sal_phage)
mpn_columns <- as.data.frame(str_split_fixed(as.character(clean_data$sal_mpn_tubes),"-",3))
colnames(mpn_columns) <- c("MPN_Tube_1","MPN_Tube_2","MPN_Tube_3")
mpn_columns[which(is.na(mpn_columns$MPN_Tube_1)),c(2:3)] <- NA
mpn_columns$MPN_Tube_1 <- as.numeric(mpn_columns$MPN_Tube_1)
mpn_columns$MPN_Tube_2 <- as.numeric(mpn_columns$MPN_Tube_2)
mpn_columns$MPN_Tube_3 <- as.numeric(mpn_columns$MPN_Tube_3)
clean_data <- cbind(clean_data, mpn_columns)
n_total <- dim(clean_data)[1]
n_pos_test <- as.numeric(summary(clean_data$sal_bax)[2])
n_pos_test_mpn <- sum(!is.na(clean_data$sal_mpn_tubes))
clean_data$value_type <- NA
clean_data$value_type[grepl("<",clean_data$sal_mpn)] <- ("cutoff_left")
clean_data$value_type[grepl(">",clean_data$sal_mpn)] <- ("cutoff_right")
clean_data$value_type[which(!grepl("<",clean_data$sal_mpn) & !grepl(">",clean_data$sal_mpn) & !is.na(clean_data$sal_mpn))] <- "value"
clean_data$value_actual <- as.numeric(str_replace_all(str_replace_all(clean_data$sal_mpn, "<", ""), ">", ""))
clean_data$value_actual_cfu_g <- clean_data$value_actual/0.221
clean_data$value_char_cfu_g <- as.character(clean_data$value_actual_cfu_g)
i <- 1
while (i <= length(clean_data$value_char_cfu_g)) {
  if (!is.na(clean_data$value_type[i])) {
    if (clean_data$value_type[i]=="cutoff_left") {
      clean_data$value_char_cfu_g[i] <- paste0("<",clean_data$value_char_cfu_g[i])
    } else if (clean_data$value_type[i]=="cutoff_right") {
      clean_data$value_char_cfu_g[i] <- paste0(">",clean_data$value_char_cfu_g[i])
    }
  }
  i <- i+1
}

over_10_cfu <- cfu_threshold_cut_return(10, clean_data$sal_mpn, clean_data$value_type, NA)[1]
over_10_cfu_pct <- cfu_threshold_cut_return(10, clean_data$sal_mpn, clean_data$value_type, NA)[2]

over_1_cfu <- cfu_threshold_cut_return(1, clean_data$sal_mpn, clean_data$value_type, NA)[1]
over_1_cfu_pct <- cfu_threshold_cut_return(1, clean_data$sal_mpn, clean_data$value_type, NA)[2]

over_1_cfu_g <- cfu_threshold_cut_return(0.221, clean_data$value_char_cfu_g, clean_data$value_type, NA)[1]
over_1_cfu_g_pct <- cfu_threshold_cut_return(0.221, clean_data$value_char_cfu_g, clean_data$value_type, NA)[2]
over_10_cfu_g <- cfu_threshold_cut_return(2.21, clean_data$value_char_cfu_g, clean_data$value_type, NA)[1]
over_10_cfu_g_pct <- cfu_threshold_cut_return(2.21, clean_data$value_char_cfu_g, clean_data$value_type, NA)[2]

paste0("Positives: ", sum(clean_data$sal_bax=="Positive"), " (", round(sum(clean_data$sal_bax=="Positive")/length(clean_data$sal_bax)*100,2), "%)")
paste0("Negatives: ", sum(clean_data$sal_bax=="Negative"), " (", round(sum(clean_data$sal_bax=="Negative")/length(clean_data$sal_bax)*100,2), "%)")
paste0("Total: ", length(clean_data$sal_bax))
total <- length(clean_data$sal_bax)
positives <- sum(clean_data$sal_bax=="Positive")
positives_pct <- sum(clean_data$sal_bax=="Positive")/length(clean_data$sal_bax)*100
negatives <- sum(clean_data$sal_bax=="Negative")
negatives_pct <- sum(clean_data$sal_bax=="Negative")/length(clean_data$sal_bax)*100
# Drop sal_mpn_tubes NAs for MPN fitting
subset_data <- clean_data[!is.na(clean_data$sal_mpn_tubes),]
# MPN
fit_dist_parts_baseline_mpn <- mpn_fit(subset(subset_data, select = c("MPN_Tube_1","MPN_Tube_2","MPN_Tube_3")), n_total, n_pos_test, n_pos_test_mpn, 3, "parts")
cat(paste0("\nMean: ", log10(exp(fit_dist_parts_baseline_mpn$mu[9])), " SD: ", log10(exp(fit_dist_parts_baseline_mpn$sigma[9])), "\n"))
fitted_count_parts(log10(exp(fit_dist_parts_baseline_mpn$mu[9])), log10(exp(fit_dist_parts_baseline_mpn$sigma[9])))
new_row <- data.frame(
  file=input_list[3],
  scenario="parts_baseline",
  fit_type="mpn_ebel_log10norm",
  total=total,
  positives=positives,
  positives_pct=positives_pct,
  negatives=negatives,
  negatives_pct=negatives_pct,
  product_type="parts",
  positive_threshold=0.0074,
  over_1_cfu=over_1_cfu_g,
  over_1_cfu_pct=over_1_cfu_g_pct,
  over_10_cfu=over_10_cfu_g,
  over_10_cfu_pct=over_10_cfu_g_pct,
  mean=log10(exp(fit_dist_parts_baseline_mpn$mu[9])),
  sd=log10(exp(fit_dist_parts_baseline_mpn$sigma[9])),
  positives_pct_fit=fitted_count_parts_return(log10(exp(fit_dist_parts_baseline_mpn$mu[9])), log10(exp(fit_dist_parts_baseline_mpn$sigma[9])),c(10, 1, 0.0074))[3],
  negatives_pct_fit=fitted_count_parts_return(log10(exp(fit_dist_parts_baseline_mpn$mu[9])), log10(exp(fit_dist_parts_baseline_mpn$sigma[9])),c(10, 1, 0.0074))[4],
  over_1_cfu_pct_fit=fitted_count_parts_return(log10(exp(fit_dist_parts_baseline_mpn$mu[9])), log10(exp(fit_dist_parts_baseline_mpn$sigma[9])),c(10, 1, 0.0074))[2],
  over_10_cfu_pct_fit=fitted_count_parts_return(log10(exp(fit_dist_parts_baseline_mpn$mu[9])), log10(exp(fit_dist_parts_baseline_mpn$sigma[9])),c(10, 1, 0.0074))[1]
)
fit_row_parts_baseline_ebel_2 <- new_row
# fit_row_parts_baseline_ebel <- new_row
```

```{r 3-2012_RCPBS_2496_samples DI.xlsx fitdistcens_short, echo=FALSE}
paste0("3-2012_RCPBS_2496_samples DI.xlsx")
paste0(path_raw_data, "/", input_list[3])
input_data <- readxl::read_xlsx(paste0(path_raw_data, "/", input_list[3]), sheet = "Sheet1")
# Remove empty columns
clean_data <- dplyr::select(input_data, c("projectid","date_collected","date_mailed","product_name","date_received","sal_bax","sal","sal_mpn_tubes","sal_mpn","sal_group","sal_type","sal_phage"))
# Convert projectid to factors
clean_data$projectid <- as.factor(clean_data$projectid)
# Format dates correctly
clean_data$date_collected <- as.Date(clean_data$date_collected, tryFormats = "%Y-%m-%d")
clean_data$date_mailed <- as.Date(clean_data$date_mailed, tryFormats = "%Y-%m-%d")
clean_data$date_received <- as.Date(clean_data$date_received, tryFormats = "%Y-%m-%d")
# Convert product_name to factors
clean_data$product_name <- as.factor(clean_data$product_name)
# Convert sal_bax to factors
clean_data$sal_bax <- as.factor(clean_data$sal_bax)
# Convert sal to factors
clean_data$sal <- as.factor(clean_data$sal)
# Convert sal_mpn_tubes to factors
clean_data$sal_mpn_tubes <- as.factor(clean_data$sal_mpn_tubes)
# Convert sal_group to factors
clean_data$sal_group <- as.factor(clean_data$sal_group)
# Convert sal_type to factors
clean_data$sal_type <- as.factor(clean_data$sal_type)
# Convert sal_phage to factors
clean_data$sal_phage <- as.factor(clean_data$sal_phage)
mpn_columns <- as.data.frame(str_split_fixed(as.character(clean_data$sal_mpn_tubes),"-",3))
colnames(mpn_columns) <- c("MPN_Tube_1","MPN_Tube_2","MPN_Tube_3")
mpn_columns[which(is.na(mpn_columns$MPN_Tube_1)),c(2:3)] <- NA
mpn_columns$MPN_Tube_1 <- as.numeric(mpn_columns$MPN_Tube_1)
mpn_columns$MPN_Tube_2 <- as.numeric(mpn_columns$MPN_Tube_2)
mpn_columns$MPN_Tube_3 <- as.numeric(mpn_columns$MPN_Tube_3)
clean_data <- cbind(clean_data, mpn_columns)
n_total <- dim(clean_data)[1]
n_pos_test <- as.numeric(summary(clean_data$sal_bax)[2])
n_pos_test_mpn <- sum(!is.na(clean_data$sal_mpn_tubes))
clean_data$value_type <- NA
clean_data$value_type[grepl("<",clean_data$sal_mpn)] <- ("cutoff_left")
clean_data$value_type[grepl(">",clean_data$sal_mpn)] <- ("cutoff_right")
clean_data$value_type[which(!grepl("<",clean_data$sal_mpn) & !grepl(">",clean_data$sal_mpn) & !is.na(clean_data$sal_mpn))] <- "value"
paste0("RCPBS")
paste0("Left Cutoff")
summary(factor(clean_data$sal_mpn[which(clean_data$value_type=="cutoff_left")]))
paste0("Right Cutoff")
summary(factor(clean_data$sal_mpn[which(clean_data$value_type=="cutoff_right")]))
paste0("Values")
summary(factor(clean_data$sal_mpn[which(clean_data$value_type=="value")]))

cfu_threshold_cut(10, clean_data$sal_mpn, clean_data$value_type, 2)
cfu_threshold_cut(1, clean_data$sal_mpn, clean_data$value_type, 2)
cfu_threshold_cut(1/10, clean_data$sal_mpn, clean_data$value_type, 2)
cfu_threshold_cut(1/30, clean_data$sal_mpn, clean_data$value_type, 2)
cfu_threshold_cut(1/325, clean_data$sal_mpn, clean_data$value_type, 2)

over_10_cfu <- cfu_threshold_cut_return(10, clean_data$sal_mpn, clean_data$value_type, NA)[1]
over_10_cfu_pct <- cfu_threshold_cut_return(10, clean_data$sal_mpn, clean_data$value_type, NA)[2]

over_1_cfu <- cfu_threshold_cut_return(1, clean_data$sal_mpn, clean_data$value_type, NA)[1]
over_1_cfu_pct <- cfu_threshold_cut_return(1, clean_data$sal_mpn, clean_data$value_type, NA)[2]

paste0("Positives: ", sum(clean_data$sal_bax=="Positive"), " (", round(sum(clean_data$sal_bax=="Positive")/length(clean_data$sal_bax)*100,2), "%)")
paste0("Negatives: ", sum(clean_data$sal_bax=="Negative"), " (", round(sum(clean_data$sal_bax=="Negative")/length(clean_data$sal_bax)*100,2), "%)")
paste0("Total: ", length(clean_data$sal_bax))
total <- length(clean_data$sal_bax)
positives <- sum(clean_data$sal_bax=="Positive")
positives_pct <- sum(clean_data$sal_bax=="Positive")/length(clean_data$sal_bax)*100
negatives <- sum(clean_data$sal_bax=="Negative")
negatives_pct <- sum(clean_data$sal_bax=="Negative")/length(clean_data$sal_bax)*100
# Drop sal_mpn_tubes NAs for MPN fitting

mpn_values <- clean_data[,c("sal_mpn","value_type")]
colnames(mpn_values) <- c("Salm_MPN", "value_type")
mpn_values$Salm_MPN <- as.character(mpn_values$Salm_MPN)
mpn_values$Salm_MPN <- str_replace_all(mpn_values$Salm_MPN,"<","")
mpn_values$Salm_MPN <- str_replace_all(mpn_values$Salm_MPN,">","")
mpn_values$Salm_MPN <- as.numeric(mpn_values$Salm_MPN)
mpn_values$left <- NA
mpn_values$right <- NA

i <- 1
while (i<=length(mpn_values$Salm_MPN)) {
  if (is.na(mpn_values$value_type[i])) {
    mpn_values$left[i] <- NA
    mpn_values$right[i] <- NA
  } else if (mpn_values$value_type[i]=="cutoff_left") {
    mpn_values$left[i] <- NA
    mpn_values$right[i] <- mpn_values$Salm_MPN[i]
  } else if (mpn_values$value_type[i]=="cutoff_right") {
    mpn_values$left[i] <- mpn_values$Salm_MPN[i]
    mpn_values$right[i] <- NA
  } else if (mpn_values$value_type[i]=="value") {
    mpn_values$left[i] <- mpn_values$Salm_MPN[i]
    mpn_values$right[i] <- mpn_values$Salm_MPN[i]
  }
  i <- i+1
}
left_right_table <- mpn_values[,c("left","right")]
left_right_table <- left_right_table[which(!is.na(left_right_table$left) & !is.na(left_right_table$right)),]
fit_dist_parts_baseline_fitdistcens_short <- fitdistrplus::fitdistcens(log10(left_right_table), "norm")

cat(paste0("\nMean: ", as.numeric(fit_dist_parts_baseline_fitdistcens_short$estimate[1]), " SD: ", as.numeric(fit_dist_parts_baseline_fitdistcens_short$estimate[2]), "\n"))
fitted_count_parts(as.numeric(fit_dist_parts_baseline_fitdistcens_short$estimate[1]), as.numeric(fit_dist_parts_baseline_fitdistcens_short$estimate[2]))
new_row <- data.frame(
  file=input_list[3],
  scenario="parts_baseline",
  fit_type="mpn_fitdistcens_log10norm_short",
  total=total,
  positives=positives,
  positives_pct=positives_pct,
  negatives=negatives,
  negatives_pct=negatives_pct,
  product_type="parts",
  positive_threshold=1/30,
  over_1_cfu=over_1_cfu,
  over_1_cfu_pct=over_1_cfu_pct,
  over_10_cfu=over_10_cfu,
  over_10_cfu_pct=over_10_cfu_pct,
  mean=as.numeric(fit_dist_parts_baseline_fitdistcens_short$estimate[1]),
  sd=as.numeric(fit_dist_parts_baseline_fitdistcens_short$estimate[2]),
  positives_pct_fit=fitted_count_parts_return(as.numeric(fit_dist_parts_baseline_fitdistcens_short$estimate[1]), as.numeric(fit_dist_parts_baseline_fitdistcens_short$estimate[2]))[3],
  negatives_pct_fit=fitted_count_parts_return(as.numeric(fit_dist_parts_baseline_fitdistcens_short$estimate[1]), as.numeric(fit_dist_parts_baseline_fitdistcens_short$estimate[2]))[4],
  over_1_cfu_pct_fit=fitted_count_parts_return(as.numeric(fit_dist_parts_baseline_fitdistcens_short$estimate[1]), as.numeric(fit_dist_parts_baseline_fitdistcens_short$estimate[2]))[2],
  over_10_cfu_pct_fit=fitted_count_parts_return(as.numeric(fit_dist_parts_baseline_fitdistcens_short$estimate[1]), as.numeric(fit_dist_parts_baseline_fitdistcens_short$estimate[2]))[1]
)
fit_row_parts_baseline_fitdistcens_short <- new_row
```

```{r 3-2012_RCPBS_2496_samples DI.xlsx fitdistcens_full, echo=FALSE}
paste0("3-2012_RCPBS_2496_samples DI.xlsx")
paste0(path_raw_data, "/", input_list[3])
input_data <- readxl::read_xlsx(paste0(path_raw_data, "/", input_list[3]), sheet = "Sheet1")
# Remove empty columns
clean_data <- dplyr::select(input_data, c("projectid","date_collected","date_mailed","product_name","date_received","sal_bax","sal","sal_mpn_tubes","sal_mpn","sal_group","sal_type","sal_phage"))
# Convert projectid to factors
clean_data$projectid <- as.factor(clean_data$projectid)
# Format dates correctly
clean_data$date_collected <- as.Date(clean_data$date_collected, tryFormats = "%Y-%m-%d")
clean_data$date_mailed <- as.Date(clean_data$date_mailed, tryFormats = "%Y-%m-%d")
clean_data$date_received <- as.Date(clean_data$date_received, tryFormats = "%Y-%m-%d")
# Convert product_name to factors
clean_data$product_name <- as.factor(clean_data$product_name)
# Convert sal_bax to factors
clean_data$sal_bax <- as.factor(clean_data$sal_bax)
# Convert sal to factors
clean_data$sal <- as.factor(clean_data$sal)
# Convert sal_mpn_tubes to factors
clean_data$sal_mpn_tubes <- as.factor(clean_data$sal_mpn_tubes)
# Convert sal_group to factors
clean_data$sal_group <- as.factor(clean_data$sal_group)
# Convert sal_type to factors
clean_data$sal_type <- as.factor(clean_data$sal_type)
# Convert sal_phage to factors
clean_data$sal_phage <- as.factor(clean_data$sal_phage)
mpn_columns <- as.data.frame(str_split_fixed(as.character(clean_data$sal_mpn_tubes),"-",3))
colnames(mpn_columns) <- c("MPN_Tube_1","MPN_Tube_2","MPN_Tube_3")
mpn_columns[which(is.na(mpn_columns$MPN_Tube_1)),c(2:3)] <- NA
mpn_columns$MPN_Tube_1 <- as.numeric(mpn_columns$MPN_Tube_1)
mpn_columns$MPN_Tube_2 <- as.numeric(mpn_columns$MPN_Tube_2)
mpn_columns$MPN_Tube_3 <- as.numeric(mpn_columns$MPN_Tube_3)
clean_data <- cbind(clean_data, mpn_columns)
n_total <- dim(clean_data)[1]
n_pos_test <- as.numeric(summary(clean_data$sal_bax)[2])
n_pos_test_mpn <- sum(!is.na(clean_data$sal_mpn_tubes))
clean_data$value_type <- NA
clean_data$value_type[grepl("<",clean_data$sal_mpn)] <- ("cutoff_left")
clean_data$value_type[grepl(">",clean_data$sal_mpn)] <- ("cutoff_right")
clean_data$value_type[which(!grepl("<",clean_data$sal_mpn) & !grepl(">",clean_data$sal_mpn) & !is.na(clean_data$sal_mpn))] <- "value"
paste0("RCPBS")
paste0("Left Cutoff")
summary(factor(clean_data$sal_mpn[which(clean_data$value_type=="cutoff_left")]))
paste0("Right Cutoff")
summary(factor(clean_data$sal_mpn[which(clean_data$value_type=="cutoff_right")]))
paste0("Values")
summary(factor(clean_data$sal_mpn[which(clean_data$value_type=="value")]))

cfu_threshold_cut(10, clean_data$sal_mpn, clean_data$value_type, 2)
cfu_threshold_cut(1, clean_data$sal_mpn, clean_data$value_type, 2)
cfu_threshold_cut(1/10, clean_data$sal_mpn, clean_data$value_type, 2)
cfu_threshold_cut(1/30, clean_data$sal_mpn, clean_data$value_type, 2)
cfu_threshold_cut(1/325, clean_data$sal_mpn, clean_data$value_type, 2)

over_10_cfu <- cfu_threshold_cut_return(10, clean_data$sal_mpn, clean_data$value_type, NA)[1]
over_10_cfu_pct <- cfu_threshold_cut_return(10, clean_data$sal_mpn, clean_data$value_type, NA)[2]

over_1_cfu <- cfu_threshold_cut_return(1, clean_data$sal_mpn, clean_data$value_type, NA)[1]
over_1_cfu_pct <- cfu_threshold_cut_return(1, clean_data$sal_mpn, clean_data$value_type, NA)[2]

paste0("Positives: ", sum(clean_data$sal_bax=="Positive"), " (", round(sum(clean_data$sal_bax=="Positive")/length(clean_data$sal_bax)*100,2), "%)")
paste0("Negatives: ", sum(clean_data$sal_bax=="Negative"), " (", round(sum(clean_data$sal_bax=="Negative")/length(clean_data$sal_bax)*100,2), "%)")
paste0("Total: ", length(clean_data$sal_bax))
total <- length(clean_data$sal_bax)
positives <- sum(clean_data$sal_bax=="Positive")
positives_pct <- sum(clean_data$sal_bax=="Positive")/length(clean_data$sal_bax)*100
negatives <- sum(clean_data$sal_bax=="Negative")
negatives_pct <- sum(clean_data$sal_bax=="Negative")/length(clean_data$sal_bax)*100
# Drop sal_mpn_tubes NAs for MPN fitting

mpn_values <- clean_data[,c("sal_mpn","value_type")]
colnames(mpn_values) <- c("Salm_MPN", "value_type")
mpn_values$Salm_MPN <- as.character(mpn_values$Salm_MPN)
mpn_values$Salm_MPN <- str_replace_all(mpn_values$Salm_MPN,"<","")
mpn_values$Salm_MPN <- str_replace_all(mpn_values$Salm_MPN,">","")
mpn_values$Salm_MPN <- as.numeric(mpn_values$Salm_MPN)
mpn_values$left <- NA
mpn_values$right <- NA

i <- 1
while (i<=length(mpn_values$Salm_MPN)) {
  if (is.na(mpn_values$value_type[i])) {
    mpn_values$left[i] <- NA
    mpn_values$right[i] <- min(mpn_values$Salm_MPN, na.rm = TRUE)
  } else if (mpn_values$value_type[i]=="cutoff_left") {
    mpn_values$left[i] <- NA
    mpn_values$right[i] <- mpn_values$Salm_MPN[i]
  } else if (mpn_values$value_type[i]=="cutoff_right") {
    mpn_values$left[i] <- mpn_values$Salm_MPN[i]
    mpn_values$right[i] <- NA
  } else if (mpn_values$value_type[i]=="value") {
    mpn_values$left[i] <- mpn_values$Salm_MPN[i]
    mpn_values$right[i] <- mpn_values$Salm_MPN[i]
  }
  i <- i+1
}
left_right_table <- mpn_values[,c("left","right")]
# left_right_table <- left_right_table[which(!is.na(left_right_table$left) & !is.na(left_right_table$right)),]
fit_dist_parts_baseline_fitdistcens_full <- fitdistrplus::fitdistcens(log10(left_right_table), "norm")

cat(paste0("\nMean: ", as.numeric(fit_dist_parts_baseline_fitdistcens_full$estimate[1]), " SD: ", as.numeric(fit_dist_parts_baseline_fitdistcens_full$estimate[2]), "\n"))
fitted_count_parts(as.numeric(fit_dist_parts_baseline_fitdistcens_full$estimate[1]), as.numeric(fit_dist_parts_baseline_fitdistcens_full$estimate[2]))
new_row <- data.frame(
  file=input_list[3],
  scenario="parts_baseline",
  fit_type="mpn_fitdistcens_log10norm_full",
  total=total,
  positives=positives,
  positives_pct=positives_pct,
  negatives=negatives,
  negatives_pct=negatives_pct,
  product_type="parts",
  positive_threshold=1/30,
  over_1_cfu=over_1_cfu,
  over_1_cfu_pct=over_1_cfu_pct,
  over_10_cfu=over_10_cfu,
  over_10_cfu_pct=over_10_cfu_pct,
  mean=as.numeric(fit_dist_parts_baseline_fitdistcens_full$estimate[1]),
  sd=as.numeric(fit_dist_parts_baseline_fitdistcens_full$estimate[2]),
  positives_pct_fit=fitted_count_parts_return(as.numeric(fit_dist_parts_baseline_fitdistcens_full$estimate[1]), as.numeric(fit_dist_parts_baseline_fitdistcens_full$estimate[2]))[3],
  negatives_pct_fit=fitted_count_parts_return(as.numeric(fit_dist_parts_baseline_fitdistcens_full$estimate[1]), as.numeric(fit_dist_parts_baseline_fitdistcens_full$estimate[2]))[4],
  over_1_cfu_pct_fit=fitted_count_parts_return(as.numeric(fit_dist_parts_baseline_fitdistcens_full$estimate[1]), as.numeric(fit_dist_parts_baseline_fitdistcens_full$estimate[2]))[2],
  over_10_cfu_pct_fit=fitted_count_parts_return(as.numeric(fit_dist_parts_baseline_fitdistcens_full$estimate[1]), as.numeric(fit_dist_parts_baseline_fitdistcens_full$estimate[2]))[1]
)
fit_row_parts_baseline_fitdistcens_full <- new_row
```

```{r 4-2007_08_YCBS_2008_6550_samples_DI.xls Ebel, echo=FALSE}
paste0("4-2007_08_YCBS_2008_6550_samples_DI.xls")
paste0(path_raw_data, "/", input_list[4])
input_data <- readxl::read_xls(paste0(path_raw_data, "/", input_list[4]), sheet = "4-2007_08_YCBS_2008_6550_sample")
#
clean_data <- input_data
# Convert projectid to factors
clean_data$projectid <- as.factor(clean_data$projectid)
# Format dates correctly
clean_data$date_collected <- as.Date(clean_data$date_collected, tryFormats = "%Y-%m-%d")
clean_data$date_mailed <- as.Date(clean_data$date_mailed, tryFormats = "%Y-%m-%d")
clean_data$date_received <- as.Date(clean_data$date_received, tryFormats = "%Y-%m-%d")
clean_data$date_approved <- as.Date(clean_data$date_approved, tryFormats = "%Y-%m-%d")
# Convert product_name to factors
clean_data$product_name <- as.factor(clean_data$product_name)
# Convert sal_bax to factors
clean_data$sal_bax <- as.factor(clean_data$sal_bax)
# Convert sal to factors
clean_data$sal <- as.factor(clean_data$sal)
# Convert sal_mpn_tubes to factors
clean_data$sal_mpn_tubes <- as.factor(clean_data$sal_mpn_tubes)
# Convert sal_group to factors
clean_data$sal_group <- as.factor(clean_data$sal_group)
# Convert sal_type to factors
clean_data$sal_type <- as.factor(clean_data$sal_type)
# Convert sal_phage to factors
clean_data$sal_phage <- as.factor(clean_data$sal_phage)
mpn_columns <- as.data.frame(str_split_fixed(as.character(clean_data$sal_mpn_tubes),"-",3))
colnames(mpn_columns) <- c("MPN_Tube_1","MPN_Tube_2","MPN_Tube_3")
mpn_columns[which(is.na(mpn_columns$MPN_Tube_1)),c(2:3)] <- NA
mpn_columns$MPN_Tube_1 <- as.numeric(mpn_columns$MPN_Tube_1)
mpn_columns$MPN_Tube_2 <- as.numeric(mpn_columns$MPN_Tube_2)
mpn_columns$MPN_Tube_3 <- as.numeric(mpn_columns$MPN_Tube_3)
clean_data <- cbind(clean_data, mpn_columns)
# Rehang ----
subset_data <- clean_data[which(clean_data$projectid=="B46REHG1" | clean_data$projectid=="B46REHG2"),]
n_total <- dim(subset_data)[1]
n_pos_test <- as.numeric(summary(subset_data$sal_bax)[2])
n_pos_test_mpn <- sum(!is.na(subset_data$sal_mpn_tubes))
subset_data$value_type <- NA
subset_data$value_type[grepl("<",subset_data$sal_mpn)] <- ("cutoff_left")
subset_data$value_type[grepl(">",subset_data$sal_mpn)] <- ("cutoff_right")
subset_data$value_type[which(!grepl("<",subset_data$sal_mpn) & !grepl(">",subset_data$sal_mpn) & !is.na(subset_data$sal_mpn))] <- "value"
paste0("Rehang")
paste0("Left Cutoff")
summary(factor(subset_data$sal_mpn[which(subset_data$value_type=="cutoff_left")]))
paste0("Right Cutoff")
subset_data$sal_mpn[which(subset_data$sal_mpn==">1100")] <- (">11") # Bad value correction
summary(factor(subset_data$sal_mpn[which(subset_data$value_type=="cutoff_right")]))
paste0("Values")
summary(factor(subset_data$sal_mpn[which(subset_data$value_type=="value")]))
cfu_threshold_cut(10, subset_data$sal_mpn, subset_data$value_type, 2)
cfu_threshold_cut(1, subset_data$sal_mpn, subset_data$value_type, 2)
cfu_threshold_cut(1/10, subset_data$sal_mpn, subset_data$value_type, 2)
cfu_threshold_cut(1/30, subset_data$sal_mpn, subset_data$value_type, 2)
cfu_threshold_cut(1/325, subset_data$sal_mpn, subset_data$value_type, 2)

over_10_cfu <- cfu_threshold_cut_return(10, subset_data$sal_mpn, subset_data$value_type, NA)[1]
over_10_cfu_pct <- cfu_threshold_cut_return(10, subset_data$sal_mpn, subset_data$value_type, NA)[2]

over_1_cfu <- cfu_threshold_cut_return(1, subset_data$sal_mpn, subset_data$value_type, NA)[1]
over_1_cfu_pct <- cfu_threshold_cut_return(1, subset_data$sal_mpn, subset_data$value_type, NA)[2]

paste0("Positives: ", sum(subset_data$sal_bax=="Positive"), " (", round(sum(subset_data$sal_bax=="Positive")/length(subset_data$sal_bax)*100,2), "%)")
paste0("Negatives: ", sum(subset_data$sal_bax=="Negative"), " (", round(sum(subset_data$sal_bax=="Negative")/length(subset_data$sal_bax)*100,2), "%)")
paste0("Total: ", length(subset_data$sal_bax))
total <- length(subset_data$sal_bax)
positives <- sum(subset_data$sal_bax=="Positive")
positives_pct <- sum(subset_data$sal_bax=="Positive")/length(subset_data$sal_bax)*100
negatives <- sum(subset_data$sal_bax=="Negative")
negatives_pct <- sum(subset_data$sal_bax=="Negative")/length(subset_data$sal_bax)*100
# Drop sal_mpn_tubes NAs for MPN fitting
subset_data <- subset_data[!is.na(subset_data$sal_mpn_tubes),]
# MPN
fit_dist_carcass_baseline_rehang_ebel <- mpn_fit(subset(subset_data, select = c("MPN_Tube_1","MPN_Tube_2","MPN_Tube_3")), n_total, n_pos_test, n_pos_test_mpn, 3, "parts")
cat(paste0("\nMean: ", log10(exp(fit_dist_carcass_baseline_rehang_ebel$mu[9])), " SD: ", log10(exp(fit_dist_carcass_baseline_rehang_ebel$sigma[9])), "\n"))
fitted_count_parts(log10(exp(fit_dist_carcass_baseline_rehang_ebel$mu[9])), log10(exp(fit_dist_carcass_baseline_rehang_ebel$sigma[9])))
new_row <- data.frame(
  file=input_list[4],
  scenario="carcass_baseline_rehang",
  fit_type="mpn_ebel_log10norm",
  total=total,
  positives=positives,
  positives_pct=positives_pct,
  negatives=negatives,
  negatives_pct=negatives_pct,
  product_type="carcass",
  positive_threshold=1/30,
  over_1_cfu=over_1_cfu,
  over_1_cfu_pct=over_1_cfu_pct,
  over_10_cfu=over_10_cfu,
  over_10_cfu_pct=over_10_cfu_pct,
  mean=log10(exp(fit_dist_carcass_baseline_rehang_ebel$mu[9])),
  sd=log10(exp(fit_dist_carcass_baseline_rehang_ebel$sigma[9])),
  positives_pct_fit=fitted_count_parts_return(log10(exp(fit_dist_carcass_baseline_rehang_ebel$mu[9])), log10(exp(fit_dist_carcass_baseline_rehang_ebel$sigma[9])))[3],
  negatives_pct_fit=fitted_count_parts_return(log10(exp(fit_dist_carcass_baseline_rehang_ebel$mu[9])), log10(exp(fit_dist_carcass_baseline_rehang_ebel$sigma[9])))[4],
  over_1_cfu_pct_fit=fitted_count_parts_return(log10(exp(fit_dist_carcass_baseline_rehang_ebel$mu[9])), log10(exp(fit_dist_carcass_baseline_rehang_ebel$sigma[9])))[2],
  over_10_cfu_pct_fit=fitted_count_parts_return(log10(exp(fit_dist_carcass_baseline_rehang_ebel$mu[9])), log10(exp(fit_dist_carcass_baseline_rehang_ebel$sigma[9])))[1]
)
fit_row_carcass_baseline_rehang_ebel <- new_row
# Post Chill----
subset_data <- clean_data[which(clean_data$projectid=="B46POST1" | clean_data$projectid=="B46POST2"),]
n_total <- dim(subset_data)[1]
n_pos_test <- as.numeric(summary(subset_data$sal_bax)[2])
n_pos_test_mpn <- sum(!is.na(subset_data$sal_mpn_tubes))
subset_data$value_type <- NA
subset_data$value_type[grepl("<",subset_data$sal_mpn)] <- ("cutoff_left")
subset_data$value_type[grepl(">",subset_data$sal_mpn)] <- ("cutoff_right")
subset_data$value_type[which(!grepl("<",subset_data$sal_mpn) & !grepl(">",subset_data$sal_mpn) & !is.na(subset_data$sal_mpn))] <- "value"
paste0("POST")
paste0("Left Cutoff")
summary(factor(subset_data$sal_mpn[which(subset_data$value_type=="cutoff_left")]))
paste0("Right Cutoff")
summary(factor(subset_data$sal_mpn[which(subset_data$value_type=="cutoff_right")]))
paste0("Values")
summary(factor(subset_data$sal_mpn[which(subset_data$value_type=="value")]))

cfu_threshold_cut(10, subset_data$sal_mpn, subset_data$value_type, 2)
cfu_threshold_cut(1, subset_data$sal_mpn, subset_data$value_type, 2)
cfu_threshold_cut(1/10, subset_data$sal_mpn, subset_data$value_type, 2)
cfu_threshold_cut(1/30, subset_data$sal_mpn, subset_data$value_type, 2)
cfu_threshold_cut(1/325, subset_data$sal_mpn, subset_data$value_type, 2)

over_10_cfu <- cfu_threshold_cut_return(10, subset_data$sal_mpn, subset_data$value_type, NA)[1]
over_10_cfu_pct <- cfu_threshold_cut_return(10, subset_data$sal_mpn, subset_data$value_type, NA)[2]

over_1_cfu <- cfu_threshold_cut_return(1, subset_data$sal_mpn, subset_data$value_type, NA)[1]
over_1_cfu_pct <- cfu_threshold_cut_return(1, subset_data$sal_mpn, subset_data$value_type, NA)[2]

paste0("Positives: ", sum(subset_data$sal_bax=="Positive"), " (", round(sum(subset_data$sal_bax=="Positive")/length(subset_data$sal_bax)*100,2), "%)")
paste0("Negatives: ", sum(subset_data$sal_bax=="Negative"), " (", round(sum(subset_data$sal_bax=="Negative")/length(subset_data$sal_bax)*100,2), "%)")
paste0("Total: ", length(subset_data$sal_bax))
total <- length(subset_data$sal_bax)
positives <- sum(subset_data$sal_bax=="Positive")
positives_pct <- sum(subset_data$sal_bax=="Positive")/length(subset_data$sal_bax)*100
negatives <- sum(subset_data$sal_bax=="Negative")
negatives_pct <- sum(subset_data$sal_bax=="Negative")/length(subset_data$sal_bax)*100
# Drop sal_mpn_tubes NAs for MPN fitting
subset_data <- subset_data[!is.na(subset_data$sal_mpn_tubes),]
# MPN
fit_dist_carcass_baseline_post_chill_ebel <- mpn_fit(subset(subset_data, select = c("MPN_Tube_1","MPN_Tube_2","MPN_Tube_3")), n_total, n_pos_test, n_pos_test_mpn, 3, "parts")
cat(paste0("\nMean: ", log10(exp(fit_dist_carcass_baseline_post_chill_ebel$mu[9])), " SD: ", log10(exp(fit_dist_carcass_baseline_post_chill_ebel$sigma[9])), "\n"))
fitted_count_parts(log10(exp(fit_dist_carcass_baseline_post_chill_ebel$mu[9])), log10(exp(fit_dist_carcass_baseline_post_chill_ebel$sigma[9])))
new_row <- data.frame(
  file=input_list[4],
  scenario="carcass_baseline_post_chill",
  fit_type="mpn_ebel_log10norm",
  total=total,
  positives=positives,
  positives_pct=positives_pct,
  negatives=negatives,
  negatives_pct=negatives_pct,
  product_type="carcass",
  positive_threshold=1/30,
  over_1_cfu=over_1_cfu,
  over_1_cfu_pct=over_1_cfu_pct,
  over_10_cfu=over_10_cfu,
  over_10_cfu_pct=over_10_cfu_pct,
  mean=log10(exp(fit_dist_carcass_baseline_post_chill_ebel$mu[9])),
  sd=log10(exp(fit_dist_carcass_baseline_post_chill_ebel$sigma[9])),
  positives_pct_fit=fitted_count_parts_return(log10(exp(fit_dist_carcass_baseline_post_chill_ebel$mu[9])), log10(exp(fit_dist_carcass_baseline_post_chill_ebel$sigma[9])))[3],
  negatives_pct_fit=fitted_count_parts_return(log10(exp(fit_dist_carcass_baseline_post_chill_ebel$mu[9])), log10(exp(fit_dist_carcass_baseline_post_chill_ebel$sigma[9])))[4],
  over_1_cfu_pct_fit=fitted_count_parts_return(log10(exp(fit_dist_carcass_baseline_post_chill_ebel$mu[9])), log10(exp(fit_dist_carcass_baseline_post_chill_ebel$sigma[9])))[2],
  over_10_cfu_pct_fit=fitted_count_parts_return(log10(exp(fit_dist_carcass_baseline_post_chill_ebel$mu[9])), log10(exp(fit_dist_carcass_baseline_post_chill_ebel$sigma[9])))[1]
)
fit_row_carcass_baseline_post_chill_ebel <- new_row
```

```{r 4-2007_08_YCBS_2008_6550_samples_DI.xls fitdistcens_short, echo=FALSE}
paste0("4-2007_08_YCBS_2008_6550_samples_DI.xls")
paste0(path_raw_data, "/", input_list[4])
input_data <- readxl::read_xls(paste0(path_raw_data, "/", input_list[4]), sheet = "4-2007_08_YCBS_2008_6550_sample")
#
clean_data <- input_data
# Convert projectid to factors
clean_data$projectid <- as.factor(clean_data$projectid)
# Format dates correctly
clean_data$date_collected <- as.Date(clean_data$date_collected, tryFormats = "%Y-%m-%d")
clean_data$date_mailed <- as.Date(clean_data$date_mailed, tryFormats = "%Y-%m-%d")
clean_data$date_received <- as.Date(clean_data$date_received, tryFormats = "%Y-%m-%d")
clean_data$date_approved <- as.Date(clean_data$date_approved, tryFormats = "%Y-%m-%d")
# Convert product_name to factors
clean_data$product_name <- as.factor(clean_data$product_name)
# Convert sal_bax to factors
clean_data$sal_bax <- as.factor(clean_data$sal_bax)
# Convert sal to factors
clean_data$sal <- as.factor(clean_data$sal)
# Convert sal_mpn_tubes to factors
clean_data$sal_mpn_tubes <- as.factor(clean_data$sal_mpn_tubes)
# Convert sal_group to factors
clean_data$sal_group <- as.factor(clean_data$sal_group)
# Convert sal_type to factors
clean_data$sal_type <- as.factor(clean_data$sal_type)
# Convert sal_phage to factors
clean_data$sal_phage <- as.factor(clean_data$sal_phage)
mpn_columns <- as.data.frame(str_split_fixed(as.character(clean_data$sal_mpn_tubes),"-",3))
colnames(mpn_columns) <- c("MPN_Tube_1","MPN_Tube_2","MPN_Tube_3")
mpn_columns[which(is.na(mpn_columns$MPN_Tube_1)),c(2:3)] <- NA
mpn_columns$MPN_Tube_1 <- as.numeric(mpn_columns$MPN_Tube_1)
mpn_columns$MPN_Tube_2 <- as.numeric(mpn_columns$MPN_Tube_2)
mpn_columns$MPN_Tube_3 <- as.numeric(mpn_columns$MPN_Tube_3)
clean_data <- cbind(clean_data, mpn_columns)
clean_data$sal_mpn_tubes <- as.factor(str_replace_all(clean_data$sal_mpn_tubes,"-",""))
clean_data$sal_mpn <- NA
i <- 1
while (i <= length(clean_data$sal_mpn_tubes)) {
  if (is.na(clean_data$sal_mpn_tubes[i])) {
    clean_data$sal_mpn[i] <- NA
  } else {
    T_1 <- substr(clean_data$sal_mpn_tubes[i],1,1)
    T_2 <- substr(clean_data$sal_mpn_tubes[i],2,2)
    T_3 <- substr(clean_data$sal_mpn_tubes[i],3,3)
    if ((T_1=="0" & T_2=="0" & T_3=="0")|(T_1=="3" & T_2=="3" & T_3=="3")) {
      clean_data$sal_mpn[i] <- MPN_Refence_LOD$MPN_Index[which(MPN_Refence_LOD$Tube_1==T_1 & MPN_Refence_LOD$Tube_2==T_2 & MPN_Refence_LOD$Tube_3==T_3)]
    } else {
      clean_data$sal_mpn[i] <- as.character(MPN_Refence$MPN_Index[which(MPN_Refence$Tube_1==T_1 & MPN_Refence$Tube_2==T_2 & MPN_Refence$Tube_3==T_3)])
    }
  }
  i <- i+1
}
clean_data$value_type <- NA
clean_data$value_type[grepl("<",clean_data$sal_mpn)] <- ("cutoff_left")
clean_data$value_type[grepl(">",clean_data$sal_mpn)] <- ("cutoff_right")
clean_data$value_type[which(!grepl("<",clean_data$sal_mpn) & !grepl(">",clean_data$sal_mpn) & !is.na(clean_data$sal_mpn))] <- "value"

# Rehang----
subset_data <- clean_data[which(clean_data$projectid=="B46REHG1" | clean_data$projectid=="B46REHG2"),]
n_total <- dim(subset_data)[1]
n_pos_test <- as.numeric(summary(subset_data$sal_bax)[2])
n_pos_test_mpn <- sum(!is.na(subset_data$sal_mpn_tubes))
paste0("Rehang")
paste0("Left Cutoff")
summary(factor(subset_data$sal_mpn[which(subset_data$value_type=="cutoff_left")]))
paste0("Right Cutoff")
subset_data$sal_mpn[which(subset_data$sal_mpn==">1100")] <- (">11") # Bad value correction
summary(factor(subset_data$sal_mpn[which(subset_data$value_type=="cutoff_right")]))
paste0("Values")
summary(factor(subset_data$sal_mpn[which(subset_data$value_type=="value")]))
cfu_threshold_cut(10, subset_data$sal_mpn, subset_data$value_type, 2)
cfu_threshold_cut(1, subset_data$sal_mpn, subset_data$value_type, 2)
cfu_threshold_cut(1/10, subset_data$sal_mpn, subset_data$value_type, 2)
cfu_threshold_cut(1/30, subset_data$sal_mpn, subset_data$value_type, 2)
cfu_threshold_cut(1/325, subset_data$sal_mpn, subset_data$value_type, 2)

over_10_cfu <- cfu_threshold_cut_return(10, subset_data$sal_mpn, subset_data$value_type, NA)[1]
over_10_cfu_pct <- cfu_threshold_cut_return(10, subset_data$sal_mpn, subset_data$value_type, NA)[2]

over_1_cfu <- cfu_threshold_cut_return(1, subset_data$sal_mpn, subset_data$value_type, NA)[1]
over_1_cfu_pct <- cfu_threshold_cut_return(1, subset_data$sal_mpn, subset_data$value_type, NA)[2]

paste0("Positives: ", sum(subset_data$sal_bax=="Positive"), " (", round(sum(subset_data$sal_bax=="Positive")/length(subset_data$sal_bax)*100,2), "%)")
paste0("Negatives: ", sum(subset_data$sal_bax=="Negative"), " (", round(sum(subset_data$sal_bax=="Negative")/length(subset_data$sal_bax)*100,2), "%)")
paste0("Total: ", length(subset_data$sal_bax))
total <- length(subset_data$sal_bax)
positives <- sum(subset_data$sal_bax=="Positive")
positives_pct <- sum(subset_data$sal_bax=="Positive")/length(subset_data$sal_bax)*100
negatives <- sum(subset_data$sal_bax=="Negative")
negatives_pct <- sum(subset_data$sal_bax=="Negative")/length(subset_data$sal_bax)*100

mpn_values <- subset_data[,c("sal_mpn","value_type")]
colnames(mpn_values) <- c("Salm_MPN", "value_type")
mpn_values$Salm_MPN <- as.character(mpn_values$Salm_MPN)
mpn_values$Salm_MPN <- str_replace_all(mpn_values$Salm_MPN,"<","")
mpn_values$Salm_MPN <- str_replace_all(mpn_values$Salm_MPN,">","")
mpn_values$Salm_MPN <- as.numeric(mpn_values$Salm_MPN)
mpn_values$left <- NA
mpn_values$right <- NA

i <- 1
while (i<=length(mpn_values$Salm_MPN)) {
  if (is.na(mpn_values$value_type[i])) {
    mpn_values$left[i] <- NA
    mpn_values$right[i] <- NA
  } else if (mpn_values$value_type[i]=="cutoff_left") {
    mpn_values$left[i] <- NA
    mpn_values$right[i] <- mpn_values$Salm_MPN[i]
  } else if (mpn_values$value_type[i]=="cutoff_right") {
    mpn_values$left[i] <- mpn_values$Salm_MPN[i]
    mpn_values$right[i] <- NA
  } else if (mpn_values$value_type[i]=="value") {
    mpn_values$left[i] <- mpn_values$Salm_MPN[i]
    mpn_values$right[i] <- mpn_values$Salm_MPN[i]
  }
  i <- i+1
}
left_right_table <- mpn_values[,c("left","right")]
left_right_table <- left_right_table[which(!is.na(left_right_table$left) & !is.na(left_right_table$right)),]
fit_dist_carcass_baseline_rehang_fitdistcens_short <- fitdistrplus::fitdistcens(log10(left_right_table), "norm")

cat(paste0("\nMean: ", as.numeric(fit_dist_carcass_baseline_rehang_fitdistcens_short$estimate[1]), " SD: ", as.numeric(fit_dist_carcass_baseline_rehang_fitdistcens_short$estimate[2]), "\n"))
fitted_count_parts(as.numeric(fit_dist_carcass_baseline_rehang_fitdistcens_short$estimate[1]), as.numeric(fit_dist_carcass_baseline_rehang_fitdistcens_short$estimate[2]))
new_row <- data.frame(
  file=input_list[4],
  scenario="carcass_baseline_rehang",
  fit_type="mpn_fitdistcens_log10_short",
  total=total,
  positives=positives,
  positives_pct=positives_pct,
  negatives=negatives,
  negatives_pct=negatives_pct,
  product_type="carcass",
  positive_threshold=1/30,
  over_1_cfu=over_1_cfu,
  over_1_cfu_pct=over_1_cfu_pct,
  over_10_cfu=over_10_cfu,
  over_10_cfu_pct=over_10_cfu_pct,
  mean=as.numeric(fit_dist_carcass_baseline_rehang_fitdistcens_short$estimate[1]),
  sd=as.numeric(fit_dist_carcass_baseline_rehang_fitdistcens_short$estimate[2]),
  positives_pct_fit=fitted_count_parts_return(as.numeric(fit_dist_carcass_baseline_rehang_fitdistcens_short$estimate[1]), as.numeric(fit_dist_carcass_baseline_rehang_fitdistcens_short$estimate[2]))[3],
  negatives_pct_fit=fitted_count_parts_return(as.numeric(fit_dist_carcass_baseline_rehang_fitdistcens_short$estimate[1]), as.numeric(fit_dist_carcass_baseline_rehang_fitdistcens_short$estimate[2]))[4],
  over_1_cfu_pct_fit=fitted_count_parts_return(as.numeric(fit_dist_carcass_baseline_rehang_fitdistcens_short$estimate[1]), as.numeric(fit_dist_carcass_baseline_rehang_fitdistcens_short$estimate[2]))[2],
  over_10_cfu_pct_fit=fitted_count_parts_return(as.numeric(fit_dist_carcass_baseline_rehang_fitdistcens_short$estimate[1]), as.numeric(fit_dist_carcass_baseline_rehang_fitdistcens_short$estimate[2]))[1]
)
fit_row_carcass_baseline_rehang_fitdistcens_short <- new_row
# Post Chill----
subset_data <- clean_data[which(clean_data$projectid=="B46POST1" | clean_data$projectid=="B46POST2"),]
n_total <- dim(subset_data)[1]
n_pos_test <- as.numeric(summary(subset_data$sal_bax)[2])
n_pos_test_mpn <- sum(!is.na(subset_data$sal_mpn_tubes))
paste0("Post Chill")
paste0("Left Cutoff")
summary(factor(subset_data$sal_mpn[which(subset_data$value_type=="cutoff_left")]))
paste0("Right Cutoff")
summary(factor(subset_data$sal_mpn[which(subset_data$value_type=="cutoff_right")]))
paste0("Values")
summary(factor(subset_data$sal_mpn[which(subset_data$value_type=="value")]))

cfu_threshold_cut(10, subset_data$sal_mpn, subset_data$value_type, 2)
cfu_threshold_cut(1, subset_data$sal_mpn, subset_data$value_type, 2)
cfu_threshold_cut(1/10, subset_data$sal_mpn, subset_data$value_type, 2)
cfu_threshold_cut(1/30, subset_data$sal_mpn, subset_data$value_type, 2)
cfu_threshold_cut(1/325, subset_data$sal_mpn, subset_data$value_type, 2)

over_10_cfu <- cfu_threshold_cut_return(10, subset_data$sal_mpn, subset_data$value_type, NA)[1]
over_10_cfu_pct <- cfu_threshold_cut_return(10, subset_data$sal_mpn, subset_data$value_type, NA)[2]

over_1_cfu <- cfu_threshold_cut_return(1, subset_data$sal_mpn, subset_data$value_type, NA)[1]
over_1_cfu_pct <- cfu_threshold_cut_return(1, subset_data$sal_mpn, subset_data$value_type, NA)[2]

paste0("Positives: ", sum(subset_data$sal_bax=="Positive"), " (", round(sum(subset_data$sal_bax=="Positive")/length(subset_data$sal_bax)*100,2), "%)")
paste0("Negatives: ", sum(subset_data$sal_bax=="Negative"), " (", round(sum(subset_data$sal_bax=="Negative")/length(subset_data$sal_bax)*100,2), "%)")
paste0("Total: ", length(subset_data$sal_bax))
total <- length(subset_data$sal_bax)
positives <- sum(subset_data$sal_bax=="Positive")
positives_pct <- sum(subset_data$sal_bax=="Positive")/length(subset_data$sal_bax)*100
negatives <- sum(subset_data$sal_bax=="Negative")
negatives_pct <- sum(subset_data$sal_bax=="Negative")/length(subset_data$sal_bax)*100

mpn_values <- subset_data[,c("sal_mpn","value_type")]
colnames(mpn_values) <- c("Salm_MPN", "value_type")
mpn_values$Salm_MPN <- as.character(mpn_values$Salm_MPN)
mpn_values$Salm_MPN <- str_replace_all(mpn_values$Salm_MPN,"<","")
mpn_values$Salm_MPN <- str_replace_all(mpn_values$Salm_MPN,">","")
mpn_values$Salm_MPN <- as.numeric(mpn_values$Salm_MPN)
mpn_values$left <- NA
mpn_values$right <- NA

i <- 1
while (i<=length(mpn_values$Salm_MPN)) {
  if (is.na(mpn_values$value_type[i])) {
    mpn_values$left[i] <- NA
    mpn_values$right[i] <- NA
  } else if (mpn_values$value_type[i]=="cutoff_left") {
    mpn_values$left[i] <- NA
    mpn_values$right[i] <- mpn_values$Salm_MPN[i]
  } else if (mpn_values$value_type[i]=="cutoff_right") {
    mpn_values$left[i] <- mpn_values$Salm_MPN[i]
    mpn_values$right[i] <- NA
  } else if (mpn_values$value_type[i]=="value") {
    mpn_values$left[i] <- mpn_values$Salm_MPN[i]
    mpn_values$right[i] <- mpn_values$Salm_MPN[i]
  }
  i <- i+1
}
left_right_table <- mpn_values[,c("left","right")]
left_right_table <- left_right_table[which(!is.na(left_right_table$left) & !is.na(left_right_table$right)),]
fit_dist_carcass_baseline_post_chill_fitdistcens_short <- fitdistrplus::fitdistcens(log10(left_right_table), "norm")

cat(paste0("\nMean: ", as.numeric(fit_dist_carcass_baseline_post_chill_fitdistcens_short$estimate[1]), " SD: ", as.numeric(fit_dist_carcass_baseline_post_chill_fitdistcens_short$estimate[2]), "\n"))
fitted_count_parts(as.numeric(fit_dist_carcass_baseline_post_chill_fitdistcens_short$estimate[1]), as.numeric(fit_dist_carcass_baseline_post_chill_fitdistcens_short$estimate[2]))
new_row <- data.frame(
  file=input_list[4],
  scenario="carcass_baseline_post_chill",
  fit_type="mpn_fitdistcens_log10_short",
  total=total,
  positives=positives,
  positives_pct=positives_pct,
  negatives=negatives,
  negatives_pct=negatives_pct,
  product_type="carcass",
  positive_threshold=1/30,
  over_1_cfu=over_1_cfu,
  over_1_cfu_pct=over_1_cfu_pct,
  over_10_cfu=over_10_cfu,
  over_10_cfu_pct=over_10_cfu_pct,
  mean=as.numeric(fit_dist_carcass_baseline_post_chill_fitdistcens_short$estimate[1]),
  sd=as.numeric(fit_dist_carcass_baseline_post_chill_fitdistcens_short$estimate[2]),
  positives_pct_fit=fitted_count_parts_return(as.numeric(fit_dist_carcass_baseline_post_chill_fitdistcens_short$estimate[1]), as.numeric(fit_dist_carcass_baseline_post_chill_fitdistcens_short$estimate[2]))[3],
  negatives_pct_fit=fitted_count_parts_return(as.numeric(fit_dist_carcass_baseline_post_chill_fitdistcens_short$estimate[1]), as.numeric(fit_dist_carcass_baseline_post_chill_fitdistcens_short$estimate[2]))[4],
  over_1_cfu_pct_fit=fitted_count_parts_return(as.numeric(fit_dist_carcass_baseline_post_chill_fitdistcens_short$estimate[1]), as.numeric(fit_dist_carcass_baseline_post_chill_fitdistcens_short$estimate[2]))[2],
  over_10_cfu_pct_fit=fitted_count_parts_return(as.numeric(fit_dist_carcass_baseline_post_chill_fitdistcens_short$estimate[1]), as.numeric(fit_dist_carcass_baseline_post_chill_fitdistcens_short$estimate[2]))[1]
)
fit_row_carcass_baseline_post_chill_fitdistcens_short <- new_row
```

```{r 4-2007_08_YCBS_2008_6550_samples_DI.xls fitdistcens_full, echo=FALSE}
paste0("4-2007_08_YCBS_2008_6550_samples_DI.xls")
paste0(path_raw_data, "/", input_list[4])
input_data <- readxl::read_xls(paste0(path_raw_data, "/", input_list[4]), sheet = "4-2007_08_YCBS_2008_6550_sample")
#
clean_data <- input_data
# Convert projectid to factors
clean_data$projectid <- as.factor(clean_data$projectid)
# Format dates correctly
clean_data$date_collected <- as.Date(clean_data$date_collected, tryFormats = "%Y-%m-%d")
clean_data$date_mailed <- as.Date(clean_data$date_mailed, tryFormats = "%Y-%m-%d")
clean_data$date_received <- as.Date(clean_data$date_received, tryFormats = "%Y-%m-%d")
clean_data$date_approved <- as.Date(clean_data$date_approved, tryFormats = "%Y-%m-%d")
# Convert product_name to factors
clean_data$product_name <- as.factor(clean_data$product_name)
# Convert sal_bax to factors
clean_data$sal_bax <- as.factor(clean_data$sal_bax)
# Convert sal to factors
clean_data$sal <- as.factor(clean_data$sal)
# Convert sal_mpn_tubes to factors
clean_data$sal_mpn_tubes <- as.factor(clean_data$sal_mpn_tubes)
# Convert sal_group to factors
clean_data$sal_group <- as.factor(clean_data$sal_group)
# Convert sal_type to factors
clean_data$sal_type <- as.factor(clean_data$sal_type)
# Convert sal_phage to factors
clean_data$sal_phage <- as.factor(clean_data$sal_phage)
mpn_columns <- as.data.frame(str_split_fixed(as.character(clean_data$sal_mpn_tubes),"-",3))
colnames(mpn_columns) <- c("MPN_Tube_1","MPN_Tube_2","MPN_Tube_3")
mpn_columns[which(is.na(mpn_columns$MPN_Tube_1)),c(2:3)] <- NA
mpn_columns$MPN_Tube_1 <- as.numeric(mpn_columns$MPN_Tube_1)
mpn_columns$MPN_Tube_2 <- as.numeric(mpn_columns$MPN_Tube_2)
mpn_columns$MPN_Tube_3 <- as.numeric(mpn_columns$MPN_Tube_3)
clean_data <- cbind(clean_data, mpn_columns)
clean_data$sal_mpn_tubes <- as.factor(str_replace_all(clean_data$sal_mpn_tubes,"-",""))
clean_data$sal_mpn <- NA
i <- 1
while (i <= length(clean_data$sal_mpn_tubes)) {
  if (is.na(clean_data$sal_mpn_tubes[i])) {
    clean_data$sal_mpn[i] <- NA
  } else {
    T_1 <- substr(clean_data$sal_mpn_tubes[i],1,1)
    T_2 <- substr(clean_data$sal_mpn_tubes[i],2,2)
    T_3 <- substr(clean_data$sal_mpn_tubes[i],3,3)
    if ((T_1=="0" & T_2=="0" & T_3=="0")|(T_1=="3" & T_2=="3" & T_3=="3")) {
      clean_data$sal_mpn[i] <- MPN_Refence_LOD$MPN_Index[which(MPN_Refence_LOD$Tube_1==T_1 & MPN_Refence_LOD$Tube_2==T_2 & MPN_Refence_LOD$Tube_3==T_3)]
    } else {
      clean_data$sal_mpn[i] <- as.character(MPN_Refence$MPN_Index[which(MPN_Refence$Tube_1==T_1 & MPN_Refence$Tube_2==T_2 & MPN_Refence$Tube_3==T_3)])
    }
  }
  i <- i+1
}
clean_data$value_type <- NA
clean_data$value_type[grepl("<",clean_data$sal_mpn)] <- ("cutoff_left")
clean_data$value_type[grepl(">",clean_data$sal_mpn)] <- ("cutoff_right")
clean_data$value_type[which(!grepl("<",clean_data$sal_mpn) & !grepl(">",clean_data$sal_mpn) & !is.na(clean_data$sal_mpn))] <- "value"
# Rehang----
subset_data <- clean_data[which(clean_data$projectid=="B46REHG1" | clean_data$projectid=="B46REHG2"),]
n_total <- dim(subset_data)[1]
n_pos_test <- as.numeric(summary(subset_data$sal_bax)[2])
n_pos_test_mpn <- sum(!is.na(subset_data$sal_mpn_tubes))
paste0("Rehang")
paste0("Left Cutoff")
summary(factor(subset_data$sal_mpn[which(subset_data$value_type=="cutoff_left")]))
paste0("Right Cutoff")
subset_data$sal_mpn[which(subset_data$sal_mpn==">1100")] <- (">11") # Bad value correction
summary(factor(subset_data$sal_mpn[which(subset_data$value_type=="cutoff_right")]))
paste0("Values")
summary(factor(subset_data$sal_mpn[which(subset_data$value_type=="value")]))
cfu_threshold_cut(10, subset_data$sal_mpn, subset_data$value_type, 2)
cfu_threshold_cut(1, subset_data$sal_mpn, subset_data$value_type, 2)
cfu_threshold_cut(1/10, subset_data$sal_mpn, subset_data$value_type, 2)
cfu_threshold_cut(1/30, subset_data$sal_mpn, subset_data$value_type, 2)
cfu_threshold_cut(1/325, subset_data$sal_mpn, subset_data$value_type, 2)

over_10_cfu <- cfu_threshold_cut_return(10, subset_data$sal_mpn, subset_data$value_type, NA)[1]
over_10_cfu_pct <- cfu_threshold_cut_return(10, subset_data$sal_mpn, subset_data$value_type, NA)[2]

over_1_cfu <- cfu_threshold_cut_return(1, subset_data$sal_mpn, subset_data$value_type, NA)[1]
over_1_cfu_pct <- cfu_threshold_cut_return(1, subset_data$sal_mpn, subset_data$value_type, NA)[2]

paste0("Positives: ", sum(subset_data$sal_bax=="Positive"), " (", round(sum(subset_data$sal_bax=="Positive")/length(subset_data$sal_bax)*100,2), "%)")
paste0("Negatives: ", sum(subset_data$sal_bax=="Negative"), " (", round(sum(subset_data$sal_bax=="Negative")/length(subset_data$sal_bax)*100,2), "%)")
paste0("Total: ", length(subset_data$sal_bax))
total <- length(subset_data$sal_bax)
positives <- sum(subset_data$sal_bax=="Positive")
positives_pct <- sum(subset_data$sal_bax=="Positive")/length(subset_data$sal_bax)*100
negatives <- sum(subset_data$sal_bax=="Negative")
negatives_pct <- sum(subset_data$sal_bax=="Negative")/length(subset_data$sal_bax)*100

mpn_values <- subset_data[,c("sal_mpn","value_type")]
colnames(mpn_values) <- c("Salm_MPN", "value_type")
mpn_values$Salm_MPN <- as.character(mpn_values$Salm_MPN)
mpn_values$Salm_MPN <- str_replace_all(mpn_values$Salm_MPN,"<","")
mpn_values$Salm_MPN <- str_replace_all(mpn_values$Salm_MPN,">","")
mpn_values$Salm_MPN <- as.numeric(mpn_values$Salm_MPN)
mpn_values$left <- NA
mpn_values$right <- NA

i <- 1
while (i<=length(mpn_values$Salm_MPN)) {
  if (is.na(mpn_values$value_type[i])) {
    mpn_values$left[i] <- NA
    mpn_values$right[i] <- min(mpn_values$Salm_MPN, na.rm = TRUE)
  } else if (mpn_values$value_type[i]=="cutoff_left") {
    mpn_values$left[i] <- NA
    mpn_values$right[i] <- mpn_values$Salm_MPN[i]
  } else if (mpn_values$value_type[i]=="cutoff_right") {
    mpn_values$left[i] <- mpn_values$Salm_MPN[i]
    mpn_values$right[i] <- NA
  } else if (mpn_values$value_type[i]=="value") {
    mpn_values$left[i] <- mpn_values$Salm_MPN[i]
    mpn_values$right[i] <- mpn_values$Salm_MPN[i]
  }
  i <- i+1
}
left_right_table <- mpn_values[,c("left","right")]
# left_right_table <- left_right_table[which(!is.na(left_right_table$left) & !is.na(left_right_table$right)),]
fit_dist_carcass_baseline_rehang_fitdistcens_full <- fitdistrplus::fitdistcens(log10(left_right_table), "norm")

cat(paste0("\nMean: ", as.numeric(fit_dist_carcass_baseline_rehang_fitdistcens_full$estimate[1]), " SD: ", as.numeric(fit_dist_carcass_baseline_rehang_fitdistcens_full$estimate[2]), "\n"))
fitted_count_parts(as.numeric(fit_dist_carcass_baseline_rehang_fitdistcens_full$estimate[1]), as.numeric(fit_dist_carcass_baseline_rehang_fitdistcens_full$estimate[2]))
new_row <- data.frame(
  file=input_list[4],
  scenario="carcass_baseline_rehang",
  fit_type="mpn_fitdistcens_log10_full",
  total=total,
  positives=positives,
  positives_pct=positives_pct,
  negatives=negatives,
  negatives_pct=negatives_pct,
  product_type="carcass",
  positive_threshold=1/30,
  over_1_cfu=over_1_cfu,
  over_1_cfu_pct=over_1_cfu_pct,
  over_10_cfu=over_10_cfu,
  over_10_cfu_pct=over_10_cfu_pct,
  mean=as.numeric(fit_dist_carcass_baseline_rehang_fitdistcens_full$estimate[1]),
  sd=as.numeric(fit_dist_carcass_baseline_rehang_fitdistcens_full$estimate[2]),
  positives_pct_fit=fitted_count_parts_return(as.numeric(fit_dist_carcass_baseline_rehang_fitdistcens_full$estimate[1]), as.numeric(fit_dist_carcass_baseline_rehang_fitdistcens_full$estimate[2]))[3],
  negatives_pct_fit=fitted_count_parts_return(as.numeric(fit_dist_carcass_baseline_rehang_fitdistcens_full$estimate[1]), as.numeric(fit_dist_carcass_baseline_rehang_fitdistcens_full$estimate[2]))[4],
  over_1_cfu_pct_fit=fitted_count_parts_return(as.numeric(fit_dist_carcass_baseline_rehang_fitdistcens_full$estimate[1]), as.numeric(fit_dist_carcass_baseline_rehang_fitdistcens_full$estimate[2]))[2],
  over_10_cfu_pct_fit=fitted_count_parts_return(as.numeric(fit_dist_carcass_baseline_rehang_fitdistcens_full$estimate[1]), as.numeric(fit_dist_carcass_baseline_rehang_fitdistcens_full$estimate[2]))[1]
)
fit_row_carcass_baseline_rehang_fitdistcens_full <- new_row
# Post Chill----
subset_data <- clean_data[which(clean_data$projectid=="B46POST1" | clean_data$projectid=="B46POST2"),]
n_total <- dim(subset_data)[1]
n_pos_test <- as.numeric(summary(subset_data$sal_bax)[2])
n_pos_test_mpn <- sum(!is.na(subset_data$sal_mpn_tubes))
paste0("Post Chill")
paste0("Left Cutoff")
summary(factor(subset_data$sal_mpn[which(subset_data$value_type=="cutoff_left")]))
paste0("Right Cutoff")
summary(factor(subset_data$sal_mpn[which(subset_data$value_type=="cutoff_right")]))
paste0("Values")
summary(factor(subset_data$sal_mpn[which(subset_data$value_type=="value")]))

cfu_threshold_cut(10, subset_data$sal_mpn, subset_data$value_type, 2)
cfu_threshold_cut(1, subset_data$sal_mpn, subset_data$value_type, 2)
cfu_threshold_cut(1/10, subset_data$sal_mpn, subset_data$value_type, 2)
cfu_threshold_cut(1/30, subset_data$sal_mpn, subset_data$value_type, 2)
cfu_threshold_cut(1/325, subset_data$sal_mpn, subset_data$value_type, 2)

over_10_cfu <- cfu_threshold_cut_return(10, subset_data$sal_mpn, subset_data$value_type, NA)[1]
over_10_cfu_pct <- cfu_threshold_cut_return(10, subset_data$sal_mpn, subset_data$value_type, NA)[2]

over_1_cfu <- cfu_threshold_cut_return(1, subset_data$sal_mpn, subset_data$value_type, NA)[1]
over_1_cfu_pct <- cfu_threshold_cut_return(1, subset_data$sal_mpn, subset_data$value_type, NA)[2]

paste0("Positives: ", sum(subset_data$sal_bax=="Positive"), " (", round(sum(subset_data$sal_bax=="Positive")/length(subset_data$sal_bax)*100,2), "%)")
paste0("Negatives: ", sum(subset_data$sal_bax=="Negative"), " (", round(sum(subset_data$sal_bax=="Negative")/length(subset_data$sal_bax)*100,2), "%)")
paste0("Total: ", length(subset_data$sal_bax))
total <- length(subset_data$sal_bax)
positives <- sum(subset_data$sal_bax=="Positive")
positives_pct <- sum(subset_data$sal_bax=="Positive")/length(subset_data$sal_bax)*100
negatives <- sum(subset_data$sal_bax=="Negative")
negatives_pct <- sum(subset_data$sal_bax=="Negative")/length(subset_data$sal_bax)*100

mpn_values <- subset_data[,c("sal_mpn","value_type")]
colnames(mpn_values) <- c("Salm_MPN", "value_type")
mpn_values$Salm_MPN <- as.character(mpn_values$Salm_MPN)
mpn_values$Salm_MPN <- str_replace_all(mpn_values$Salm_MPN,"<","")
mpn_values$Salm_MPN <- str_replace_all(mpn_values$Salm_MPN,">","")
mpn_values$Salm_MPN <- as.numeric(mpn_values$Salm_MPN)
mpn_values$left <- NA
mpn_values$right <- NA

i <- 1
while (i<=length(mpn_values$Salm_MPN)) {
  if (is.na(mpn_values$value_type[i])) {
    mpn_values$left[i] <- NA
    mpn_values$right[i] <- min(mpn_values$Salm_MPN, na.rm = TRUE)
  } else if (mpn_values$value_type[i]=="cutoff_left") {
    mpn_values$left[i] <- NA
    mpn_values$right[i] <- mpn_values$Salm_MPN[i]
  } else if (mpn_values$value_type[i]=="cutoff_right") {
    mpn_values$left[i] <- mpn_values$Salm_MPN[i]
    mpn_values$right[i] <- NA
  } else if (mpn_values$value_type[i]=="value") {
    mpn_values$left[i] <- mpn_values$Salm_MPN[i]
    mpn_values$right[i] <- mpn_values$Salm_MPN[i]
  }
  i <- i+1
}
left_right_table <- mpn_values[,c("left","right")]
# left_right_table <- left_right_table[which(!is.na(left_right_table$left) & !is.na(left_right_table$right)),]
fit_dist_carcass_baseline_post_chill_fitdistcens_full <- fitdistrplus::fitdistcens(log10(left_right_table), "norm")

cat(paste0("\nMean: ", as.numeric(fit_dist_carcass_baseline_post_chill_fitdistcens_full$estimate[1]), " SD: ", as.numeric(fit_dist_carcass_baseline_post_chill_fitdistcens_full$estimate[2]), "\n"))
fitted_count_parts(as.numeric(fit_dist_carcass_baseline_post_chill_fitdistcens_full$estimate[1]), as.numeric(fit_dist_carcass_baseline_post_chill_fitdistcens_full$estimate[2]))
new_row <- data.frame(
  file=input_list[4],
  scenario="carcass_baseline_post_chill",
  fit_type="mpn_fitdistcens_log10_full",
  total=total,
  positives=positives,
  positives_pct=positives_pct,
  negatives=negatives,
  negatives_pct=negatives_pct,
  product_type="carcass",
  positive_threshold=1/30,
  over_1_cfu=over_1_cfu,
  over_1_cfu_pct=over_1_cfu_pct,
  over_10_cfu=over_10_cfu,
  over_10_cfu_pct=over_10_cfu_pct,
  mean=as.numeric(fit_dist_carcass_baseline_post_chill_fitdistcens_full$estimate[1]),
  sd=as.numeric(fit_dist_carcass_baseline_post_chill_fitdistcens_full$estimate[2]),
  positives_pct_fit=fitted_count_parts_return(as.numeric(fit_dist_carcass_baseline_post_chill_fitdistcens_full$estimate[1]), as.numeric(fit_dist_carcass_baseline_post_chill_fitdistcens_full$estimate[2]))[3],
  negatives_pct_fit=fitted_count_parts_return(as.numeric(fit_dist_carcass_baseline_post_chill_fitdistcens_full$estimate[1]), as.numeric(fit_dist_carcass_baseline_post_chill_fitdistcens_full$estimate[2]))[4],
  over_1_cfu_pct_fit=fitted_count_parts_return(as.numeric(fit_dist_carcass_baseline_post_chill_fitdistcens_full$estimate[1]), as.numeric(fit_dist_carcass_baseline_post_chill_fitdistcens_full$estimate[2]))[2],
  over_10_cfu_pct_fit=fitted_count_parts_return(as.numeric(fit_dist_carcass_baseline_post_chill_fitdistcens_full$estimate[1]), as.numeric(fit_dist_carcass_baseline_post_chill_fitdistcens_full$estimate[2]))[1]
)
fit_row_carcass_baseline_post_chill_fitdistcens_full <- new_row
```

```{r Poultry Results, echo=FALSE}
poultry_results_table <- rbind(
  fit_row_comminuted_censor_ebel,
  fit_row_comminuted_censor_mpn_override,
  fit_row_comminuted_censor_fitdistcens_short,
  fit_row_comminuted_censor_fitdistcens_full,
  fit_row_carcass_exploratory_rehang_fitdistcens_short,
  fit_row_carcass_exploratory_post_chill_fitdistcens_short,
  fit_row_carcass_exploratory_rehang_fitdistcens_full,
  fit_row_carcass_exploratory_post_chill_fitdistcens_full,
  fit_row_parts_baseline_ebel,
  fit_row_parts_baseline_fitdistcens_short,
  fit_row_parts_baseline_fitdistcens_full,
  fit_row_carcass_baseline_rehang_ebel,
  fit_row_carcass_baseline_post_chill_ebel,
  fit_row_carcass_baseline_rehang_fitdistcens_short,
  fit_row_carcass_baseline_post_chill_fitdistcens_short,
  fit_row_carcass_baseline_rehang_fitdistcens_full,
  fit_row_carcass_baseline_post_chill_fitdistcens_full
)
file_path <- paste0(getwd(), "/outputs/", format(Sys.time(), "%Y-%m-%d-%H-%M-%S_"))
write.csv(poultry_results_table, paste0(file_path, "poultry_results_table", ".csv"), row.names = FALSE)
```


```{r Turkey Switch, echo=FALSE}
path_raw_data <- paste0(getwd(),"/raw data/data from FOIA/Turkey")
input_list <- list.files(path_raw_data)[grep(".csv",list.files(path_raw_data))]
paste0("Pulling data from ",paste0(path_raw_data))
```

```{r 5-Turkey_Baseline_Salmonella_Paired_2008_2009.csv Ebel, echo=FALSE}
paste0("5-Turkey_Baseline_Salmonella_Paired_2008_2009.csv")
paste0(path_raw_data, "/", input_list[1])
input_data <- read.csv(paste0(path_raw_data, "/", input_list[1]))
#
clean_data <- input_data
clean_data$RECD_DATE <- as.Date(clean_data$RECD_DATE, format="%m/%d/%Y")
clean_data$RH_PROJ <- as.factor(clean_data$RH_PROJ)
clean_data$PC_PROJ <- as.factor(clean_data$PC_PROJ)
clean_data$RH_Sal_Screen <- as.factor(clean_data$RH_Sal_Screen)
clean_data$PC_Sal_Screen <- as.factor(clean_data$PC_Sal_Screen)
clean_data$RH_Sal_Qual <- as.factor(clean_data$RH_Sal_Qual)
clean_data$PC_Sal_Qual <- as.factor(clean_data$PC_Sal_Qual)
clean_data$RH_Sal_Serogroup <- as.factor(clean_data$RH_Sal_Serogroup)
clean_data$PC_Sal_Serogroup <- as.factor(clean_data$PC_Sal_Serogroup)
clean_data$RH_Sal_Serotype <- as.factor(clean_data$RH_Sal_Serogroup)
clean_data$PC_Sal_Serotype <- as.factor(clean_data$PC_Sal_Serotype)

clean_data$RH_Sal_Tube_MPN <- as.character(clean_data$RH_Sal_Tube_MPN)
clean_data$RH_Sal_Tube_MPN <- str_pad(clean_data$RH_Sal_Tube_MPN, 5, pad = "0")
clean_data$RH_Sal_Tube_MPN <- as.factor(clean_data$RH_Sal_Tube_MPN)
clean_data$RH_Sal_Tube_MPN_Tube_1 <- as.numeric(substr(clean_data$RH_Sal_Tube_MPN,1,1))
clean_data$RH_Sal_Tube_MPN_Tube_2 <- as.numeric(substr(clean_data$RH_Sal_Tube_MPN,2,2))
clean_data$RH_Sal_Tube_MPN_Tube_3 <- as.numeric(substr(clean_data$RH_Sal_Tube_MPN,3,3))
clean_data$RH_Sal_Tube_MPN_Tube_4 <- as.numeric(substr(clean_data$RH_Sal_Tube_MPN,4,4))
clean_data$RH_Sal_Tube_MPN_Tube_5 <- as.numeric(substr(clean_data$RH_Sal_Tube_MPN,5,5))

clean_data$PC_Sal_Tube_MPN <- as.character(clean_data$PC_Sal_Tube_MPN)
clean_data$PC_Sal_Tube_MPN <- str_pad(clean_data$PC_Sal_Tube_MPN, 5, pad = "0")
clean_data$PC_Sal_Tube_MPN <- as.factor(clean_data$PC_Sal_Tube_MPN)
clean_data$PC_Sal_Tube_MPN_Tube_1 <- as.numeric(substr(clean_data$PC_Sal_Tube_MPN,1,1))
clean_data$PC_Sal_Tube_MPN_Tube_2 <- as.numeric(substr(clean_data$PC_Sal_Tube_MPN,2,2))
clean_data$PC_Sal_Tube_MPN_Tube_3 <- as.numeric(substr(clean_data$PC_Sal_Tube_MPN,3,3))
clean_data$PC_Sal_Tube_MPN_Tube_4 <- as.numeric(substr(clean_data$PC_Sal_Tube_MPN,4,4))
clean_data$PC_Sal_Tube_MPN_Tube_5 <- as.numeric(substr(clean_data$PC_Sal_Tube_MPN,5,5))

clean_data$RH_Sal_MPN_Quan[which(clean_data$RH_Sal_MPN_Quan==0)] <- "<0.075"
clean_data$RH_Sal_MPN_Quan[which(clean_data$PC_Sal_MPN_Quan==0)] <- "<0.075"

# Rehang ----
n_total <- dim(clean_data)[1]
n_pos_test <- as.numeric(summary(clean_data$RH_Sal_Screen)[2])
n_pos_test_mpn <- sum(!is.na(clean_data$RH_Sal_Tube_MPN))

clean_data$RH_Sal_value_type <- NA
clean_data$RH_Sal_value_type[grepl("<",clean_data$RH_Sal_MPN_Quan)] <- ("cutoff_left")
clean_data$RH_Sal_value_type[grepl(">",clean_data$RH_Sal_MPN_Quan)] <- ("cutoff_right")
clean_data$RH_Sal_value_type[which(!grepl("<",clean_data$RH_Sal_MPN_Quan) & !grepl(">",clean_data$RH_Sal_MPN_Quan) & !is.na(clean_data$RH_Sal_MPN_Quan))] <- "value"
paste0("Rehang")
paste0("Left Cutoff")
summary(factor(clean_data$RH_Sal_MPN_Quan[which(clean_data$RH_Sal_value_type=="cutoff_left")]))
paste0("Right Cutoff")
summary(factor(clean_data$RH_Sal_MPN_Quan[which(clean_data$RH_Sal_value_type=="cutoff_right")]))
paste0("Values")
summary(factor(clean_data$RH_Sal_MPN_Quan[which(clean_data$RH_Sal_value_type=="value")]))

cfu_threshold_cut(10, clean_data$RH_Sal_MPN_Quan, clean_data$RH_Sal_value_type, 2)
cfu_threshold_cut(1, clean_data$RH_Sal_MPN_Quan, clean_data$RH_Sal_value_type, 2)
cfu_threshold_cut(1/10, clean_data$RH_Sal_MPN_Quan, clean_data$RH_Sal_value_type, 2)
cfu_threshold_cut(1/30, clean_data$RH_Sal_MPN_Quan, clean_data$RH_Sal_value_type, 2)
cfu_threshold_cut(1/325, clean_data$RH_Sal_MPN_Quan, clean_data$RH_Sal_value_type, 2)

over_10_cfu <- cfu_threshold_cut_return(10, clean_data$RH_Sal_MPN_Quan, clean_data$RH_Sal_value_type, NA)[1]
over_10_cfu_pct <- cfu_threshold_cut_return(10, clean_data$RH_Sal_MPN_Quan, clean_data$RH_Sal_value_type, NA)[2]

over_1_cfu <- cfu_threshold_cut_return(1, clean_data$RH_Sal_MPN_Quan, clean_data$RH_Sal_value_type, NA)[1]
over_1_cfu_pct <- cfu_threshold_cut_return(1, clean_data$RH_Sal_MPN_Quan, clean_data$RH_Sal_value_type, NA)[2]

paste0("Positives: ", sum(clean_data$RH_Sal_Screen=="Positive"), " (", round(sum(clean_data$RH_Sal_Screen=="Positive")/length(clean_data$RH_Sal_Screen)*100,2), "%)")
paste0("Negatives: ", sum(clean_data$RH_Sal_Screen=="Negative"), " (", round(sum(clean_data$RH_Sal_Screen=="Negative")/length(clean_data$RH_Sal_Screen)*100,2), "%)")
paste0("Total: ", length(clean_data$RH_Sal_Screen))
total <- length(clean_data$RH_Sal_Screen)
positives <- sum(clean_data$RH_Sal_Screen=="Positive")
positives_pct <- sum(clean_data$RH_Sal_Screen=="Positive")/length(clean_data$RH_Sal_Screen)*100
negatives <- sum(clean_data$RH_Sal_Screen=="Negative")
negatives_pct <- sum(clean_data$RH_Sal_Screen=="Negative")/length(clean_data$RH_Sal_Screen)*100
# Drop sal_mpn_tubes NAs for MPN fitting
subset_data <- clean_data[!is.na(clean_data$RH_Sal_Tube_MPN),]
# MPN
fit_dist_Turkey_Baseline_Salmonella_Paired_2008_2009_RH_ebel <- mpn_fit(subset(subset_data, select = c("RH_Sal_Tube_MPN_Tube_1","RH_Sal_Tube_MPN_Tube_2","RH_Sal_Tube_MPN_Tube_3","RH_Sal_Tube_MPN_Tube_4","RH_Sal_Tube_MPN_Tube_5")), n_total, n_pos_test, n_pos_test_mpn, 5, "parts")
cat(paste0("\nMean: ", log10(exp(fit_dist_Turkey_Baseline_Salmonella_Paired_2008_2009_RH_ebel$mu[9])), " SD: ", log10(exp(fit_dist_Turkey_Baseline_Salmonella_Paired_2008_2009_RH_ebel$sigma[9])), "\n"))
fitted_count_parts(log10(exp(fit_dist_Turkey_Baseline_Salmonella_Paired_2008_2009_RH_ebel$mu[9])), log10(exp(fit_dist_Turkey_Baseline_Salmonella_Paired_2008_2009_RH_ebel$sigma[9])))
new_row <- data.frame(
  file=input_list[1],
  scenario="Turkey_Baseline_Salmonella_Paired_2008_2009_RH",
  fit_type="mpn_ebel_log10norm",
  total=total,
  positives=positives,
  positives_pct=positives_pct,
  negatives=negatives,
  negatives_pct=negatives_pct,
  product_type="carcass",
  positive_threshold=1/30,
  over_1_cfu=over_1_cfu,
  over_1_cfu_pct=over_1_cfu_pct,
  over_10_cfu=over_10_cfu,
  over_10_cfu_pct=over_10_cfu_pct,
  mean=log10(exp(fit_dist_Turkey_Baseline_Salmonella_Paired_2008_2009_RH_ebel$mu[9])),
  sd=log10(exp(fit_dist_Turkey_Baseline_Salmonella_Paired_2008_2009_RH_ebel$sigma[9])),
  positives_pct_fit=fitted_count_parts_return(log10(exp(fit_dist_Turkey_Baseline_Salmonella_Paired_2008_2009_RH_ebel$mu[9])), log10(exp(fit_dist_Turkey_Baseline_Salmonella_Paired_2008_2009_RH_ebel$sigma[9])))[3],
  negatives_pct_fit=fitted_count_parts_return(log10(exp(fit_dist_Turkey_Baseline_Salmonella_Paired_2008_2009_RH_ebel$mu[9])), log10(exp(fit_dist_Turkey_Baseline_Salmonella_Paired_2008_2009_RH_ebel$sigma[9])))[4],
  over_1_cfu_pct_fit=fitted_count_parts_return(log10(exp(fit_dist_Turkey_Baseline_Salmonella_Paired_2008_2009_RH_ebel$mu[9])), log10(exp(fit_dist_Turkey_Baseline_Salmonella_Paired_2008_2009_RH_ebel$sigma[9])))[2],
  over_10_cfu_pct_fit=fitted_count_parts_return(log10(exp(fit_dist_Turkey_Baseline_Salmonella_Paired_2008_2009_RH_ebel$mu[9])), log10(exp(fit_dist_Turkey_Baseline_Salmonella_Paired_2008_2009_RH_ebel$sigma[9])))[1]
)
fit_row_Turkey_Baseline_Salmonella_Paired_2008_2009_RH_ebel <- new_row
# Post Chill ----
n_total <- dim(clean_data)[1]
n_pos_test <- as.numeric(summary(clean_data$PC_Sal_Screen)[2])
n_pos_test_mpn <- sum(!is.na(clean_data$PC_Sal_Tube_MPN))

clean_data$PC_Sal_value_type <- NA
clean_data$PC_Sal_value_type[grepl("<",clean_data$PC_Sal_MPN_Quan)] <- ("cutoff_left")
clean_data$PC_Sal_value_type[grepl(">",clean_data$PC_Sal_MPN_Quan)] <- ("cutoff_right")
clean_data$PC_Sal_value_type[which(!grepl("<",clean_data$PC_Sal_MPN_Quan) & !grepl(">",clean_data$PC_Sal_MPN_Quan) & !is.na(clean_data$PC_Sal_MPN_Quan))] <- "value"
paste0("POST")
paste0("Left Cutoff")
summary(factor(clean_data$PC_Sal_MPN_Quan[which(clean_data$PC_Sal_value_type=="cutoff_left")]))
paste0("Right Cutoff")
summary(factor(clean_data$PC_Sal_MPN_Quan[which(clean_data$PC_Sal_value_type=="cutoff_right")]))
paste0("Values")
summary(factor(clean_data$PC_Sal_MPN_Quan[which(clean_data$PC_Sal_value_type=="value")]))

cfu_threshold_cut(10, clean_data$PC_Sal_MPN_Quan, clean_data$PC_Sal_value_type, 2)
cfu_threshold_cut(1, clean_data$PC_Sal_MPN_Quan, clean_data$PC_Sal_value_type, 2)
cfu_threshold_cut(1/10, clean_data$PC_Sal_MPN_Quan, clean_data$PC_Sal_value_type, 2)
cfu_threshold_cut(1/30, clean_data$PC_Sal_MPN_Quan, clean_data$PC_Sal_value_type, 2)
cfu_threshold_cut(1/325, clean_data$PC_Sal_MPN_Quan, clean_data$PC_Sal_value_type, 2)

over_10_cfu <- cfu_threshold_cut_return(10, clean_data$PC_Sal_MPN_Quan, clean_data$PC_Sal_value_type, NA)[1]
over_10_cfu_pct <- cfu_threshold_cut_return(10, clean_data$PC_Sal_MPN_Quan, clean_data$PC_Sal_value_type, NA)[2]

over_1_cfu <- cfu_threshold_cut_return(1, clean_data$PC_Sal_MPN_Quan, clean_data$PC_Sal_value_type, NA)[1]
over_1_cfu_pct <- cfu_threshold_cut_return(1, clean_data$PC_Sal_MPN_Quan, clean_data$PC_Sal_value_type, NA)[2]

paste0("Positives: ", sum(clean_data$PC_Sal_Screen=="Positive"), " (", round(sum(clean_data$PC_Sal_Screen=="Positive")/length(clean_data$PC_Sal_Screen)*100,2), "%)")
paste0("Negatives: ", sum(clean_data$PC_Sal_Screen=="Negative"), " (", round(sum(clean_data$PC_Sal_Screen=="Negative")/length(clean_data$PC_Sal_Screen)*100,2), "%)")
paste0("Total: ", length(clean_data$PC_Sal_Screen))
total <- length(clean_data$PC_Sal_Screen)
positives <- sum(clean_data$PC_Sal_Screen=="Positive")
positives_pct <- sum(clean_data$PC_Sal_Screen=="Positive")/length(clean_data$PC_Sal_Screen)*100
negatives <- sum(clean_data$PC_Sal_Screen=="Negative")
negatives_pct <- sum(clean_data$PC_Sal_Screen=="Negative")/length(clean_data$PC_Sal_Screen)*100
# Drop sal_mpn_tubes NAs for MPN fitting
subset_data <- clean_data[!is.na(clean_data$PC_Sal_Tube_MPN),]
# MPN
fit_dist_Turkey_Baseline_Salmonella_Paired_2008_2009_PC_ebel <- mpn_fit(subset(subset_data, select = c("PC_Sal_Tube_MPN_Tube_1","PC_Sal_Tube_MPN_Tube_2","PC_Sal_Tube_MPN_Tube_3","PC_Sal_Tube_MPN_Tube_4","PC_Sal_Tube_MPN_Tube_5")), n_total, n_pos_test, n_pos_test_mpn, 5, "parts")
cat(paste0("\nMean: ", log10(exp(fit_dist_Turkey_Baseline_Salmonella_Paired_2008_2009_PC_ebel$mu[9])), " SD: ", log10(exp(fit_dist_Turkey_Baseline_Salmonella_Paired_2008_2009_PC_ebel$sigma[9])), "\n"))
fitted_count_parts(log10(exp(fit_dist_Turkey_Baseline_Salmonella_Paired_2008_2009_PC_ebel$mu[9])), log10(exp(fit_dist_Turkey_Baseline_Salmonella_Paired_2008_2009_PC_ebel$sigma[9])))
new_row <- data.frame(
  file=input_list[1],
  scenario="Turkey_Baseline_Salmonella_Paired_2008_2009_PC",
  fit_type="mpn_ebel_log10norm",
  total=total,
  positives=positives,
  positives_pct=positives_pct,
  negatives=negatives,
  negatives_pct=negatives_pct,
  product_type="carcass",
  positive_threshold=1/30,
  over_1_cfu=over_1_cfu,
  over_1_cfu_pct=over_1_cfu_pct,
  over_10_cfu=over_10_cfu,
  over_10_cfu_pct=over_10_cfu_pct,
  mean=log10(exp(fit_dist_Turkey_Baseline_Salmonella_Paired_2008_2009_PC_ebel$mu[9])),
  sd=log10(exp(fit_dist_Turkey_Baseline_Salmonella_Paired_2008_2009_PC_ebel$sigma[9])),
  positives_pct_fit=fitted_count_parts_return(log10(exp(fit_dist_Turkey_Baseline_Salmonella_Paired_2008_2009_PC_ebel$mu[9])), log10(exp(fit_dist_Turkey_Baseline_Salmonella_Paired_2008_2009_PC_ebel$sigma[9])))[3],
  negatives_pct_fit=fitted_count_parts_return(log10(exp(fit_dist_Turkey_Baseline_Salmonella_Paired_2008_2009_PC_ebel$mu[9])), log10(exp(fit_dist_Turkey_Baseline_Salmonella_Paired_2008_2009_PC_ebel$sigma[9])))[4],
  over_1_cfu_pct_fit=fitted_count_parts_return(log10(exp(fit_dist_Turkey_Baseline_Salmonella_Paired_2008_2009_PC_ebel$mu[9])), log10(exp(fit_dist_Turkey_Baseline_Salmonella_Paired_2008_2009_PC_ebel$sigma[9])))[2],
  over_10_cfu_pct_fit=fitted_count_parts_return(log10(exp(fit_dist_Turkey_Baseline_Salmonella_Paired_2008_2009_PC_ebel$mu[9])), log10(exp(fit_dist_Turkey_Baseline_Salmonella_Paired_2008_2009_PC_ebel$sigma[9])))[1]
)
fit_row_Turkey_Baseline_Salmonella_Paired_2008_2009_PC_ebel <- new_row
```

```{r 5-Turkey_Baseline_Salmonella_Paired_2008_2009.csv fitdistcens_short, echo=FALSE}
paste0("5-Turkey_Baseline_Salmonella_Paired_2008_2009.csv")
paste0(path_raw_data, "/", input_list[1])
input_data <- read.csv(paste0(path_raw_data, "/", input_list[1]))
#
clean_data <- input_data
clean_data$RECD_DATE <- as.Date(clean_data$RECD_DATE, format="%m/%d/%Y")
clean_data$RH_PROJ <- as.factor(clean_data$RH_PROJ)
clean_data$PC_PROJ <- as.factor(clean_data$PC_PROJ)
clean_data$RH_Sal_Screen <- as.factor(clean_data$RH_Sal_Screen)
clean_data$PC_Sal_Screen <- as.factor(clean_data$PC_Sal_Screen)
clean_data$RH_Sal_Qual <- as.factor(clean_data$RH_Sal_Qual)
clean_data$PC_Sal_Qual <- as.factor(clean_data$PC_Sal_Qual)
clean_data$RH_Sal_Serogroup <- as.factor(clean_data$RH_Sal_Serogroup)
clean_data$PC_Sal_Serogroup <- as.factor(clean_data$PC_Sal_Serogroup)
clean_data$RH_Sal_Serotype <- as.factor(clean_data$RH_Sal_Serogroup)
clean_data$PC_Sal_Serotype <- as.factor(clean_data$PC_Sal_Serotype)

clean_data$RH_Sal_Tube_MPN <- as.character(clean_data$RH_Sal_Tube_MPN)
clean_data$RH_Sal_Tube_MPN <- str_pad(clean_data$RH_Sal_Tube_MPN, 5, pad = "0")
clean_data$RH_Sal_Tube_MPN <- as.factor(clean_data$RH_Sal_Tube_MPN)
clean_data$RH_Sal_Tube_MPN_Tube_1 <- as.numeric(substr(clean_data$RH_Sal_Tube_MPN,1,1))
clean_data$RH_Sal_Tube_MPN_Tube_2 <- as.numeric(substr(clean_data$RH_Sal_Tube_MPN,2,2))
clean_data$RH_Sal_Tube_MPN_Tube_3 <- as.numeric(substr(clean_data$RH_Sal_Tube_MPN,3,3))
clean_data$RH_Sal_Tube_MPN_Tube_4 <- as.numeric(substr(clean_data$RH_Sal_Tube_MPN,4,4))
clean_data$RH_Sal_Tube_MPN_Tube_5 <- as.numeric(substr(clean_data$RH_Sal_Tube_MPN,5,5))

clean_data$PC_Sal_Tube_MPN <- as.character(clean_data$PC_Sal_Tube_MPN)
clean_data$PC_Sal_Tube_MPN <- str_pad(clean_data$PC_Sal_Tube_MPN, 5, pad = "0")
clean_data$PC_Sal_Tube_MPN <- as.factor(clean_data$PC_Sal_Tube_MPN)
clean_data$PC_Sal_Tube_MPN_Tube_1 <- as.numeric(substr(clean_data$PC_Sal_Tube_MPN,1,1))
clean_data$PC_Sal_Tube_MPN_Tube_2 <- as.numeric(substr(clean_data$PC_Sal_Tube_MPN,2,2))
clean_data$PC_Sal_Tube_MPN_Tube_3 <- as.numeric(substr(clean_data$PC_Sal_Tube_MPN,3,3))
clean_data$PC_Sal_Tube_MPN_Tube_4 <- as.numeric(substr(clean_data$PC_Sal_Tube_MPN,4,4))
clean_data$PC_Sal_Tube_MPN_Tube_5 <- as.numeric(substr(clean_data$PC_Sal_Tube_MPN,5,5))

clean_data$RH_Sal_MPN_Quan[which(clean_data$RH_Sal_MPN_Quan==0)] <- "<0.075"
clean_data$PC_Sal_MPN_Quan[which(clean_data$PC_Sal_MPN_Quan==0)] <- "<0.075"
# Rehang ----
n_total <- dim(clean_data)[1]
n_pos_test <- as.numeric(summary(clean_data$RH_Sal_Screen)[2])
n_pos_test_mpn <- sum(!is.na(clean_data$RH_Sal_Tube_MPN))

clean_data$RH_Sal_value_type <- NA
clean_data$RH_Sal_value_type[grepl("<",clean_data$RH_Sal_MPN_Quan)] <- ("cutoff_left")
clean_data$RH_Sal_value_type[grepl(">",clean_data$RH_Sal_MPN_Quan)] <- ("cutoff_right")
clean_data$RH_Sal_value_type[which(!grepl("<",clean_data$RH_Sal_MPN_Quan) & !grepl(">",clean_data$RH_Sal_MPN_Quan) & !is.na(clean_data$RH_Sal_MPN_Quan))] <- "value"
paste0("Rehang")
paste0("Left Cutoff")
summary(factor(clean_data$RH_Sal_MPN_Quan[which(clean_data$RH_Sal_value_type=="cutoff_left")]))
paste0("Right Cutoff")
summary(factor(clean_data$RH_Sal_MPN_Quan[which(clean_data$RH_Sal_value_type=="cutoff_right")]))
paste0("Values")
summary(factor(clean_data$RH_Sal_MPN_Quan[which(clean_data$RH_Sal_value_type=="value")]))

cfu_threshold_cut(10, clean_data$RH_Sal_MPN_Quan, clean_data$RH_Sal_value_type, 2)
cfu_threshold_cut(1, clean_data$RH_Sal_MPN_Quan, clean_data$RH_Sal_value_type, 2)
cfu_threshold_cut(1/10, clean_data$RH_Sal_MPN_Quan, clean_data$RH_Sal_value_type, 2)
cfu_threshold_cut(1/30, clean_data$RH_Sal_MPN_Quan, clean_data$RH_Sal_value_type, 2)
cfu_threshold_cut(1/325, clean_data$RH_Sal_MPN_Quan, clean_data$RH_Sal_value_type, 2)

over_10_cfu <- cfu_threshold_cut_return(10, clean_data$RH_Sal_MPN_Quan, clean_data$RH_Sal_value_type, NA)[1]
over_10_cfu_pct <- cfu_threshold_cut_return(10, clean_data$RH_Sal_MPN_Quan, clean_data$RH_Sal_value_type, NA)[2]

over_1_cfu <- cfu_threshold_cut_return(1, clean_data$RH_Sal_MPN_Quan, clean_data$RH_Sal_value_type, NA)[1]
over_1_cfu_pct <- cfu_threshold_cut_return(1, clean_data$RH_Sal_MPN_Quan, clean_data$RH_Sal_value_type, NA)[2]

paste0("Positives: ", sum(clean_data$RH_Sal_Screen=="Positive"), " (", round(sum(clean_data$RH_Sal_Screen=="Positive")/length(clean_data$RH_Sal_Screen)*100,2), "%)")
paste0("Negatives: ", sum(clean_data$RH_Sal_Screen=="Negative"), " (", round(sum(clean_data$RH_Sal_Screen=="Negative")/length(clean_data$RH_Sal_Screen)*100,2), "%)")
paste0("Total: ", length(clean_data$RH_Sal_Screen))
total <- length(clean_data$RH_Sal_Screen)
positives <- sum(clean_data$RH_Sal_Screen=="Positive")
positives_pct <- sum(clean_data$RH_Sal_Screen=="Positive")/length(clean_data$RH_Sal_Screen)*100
negatives <- sum(clean_data$RH_Sal_Screen=="Negative")
negatives_pct <- sum(clean_data$RH_Sal_Screen=="Negative")/length(clean_data$RH_Sal_Screen)*100
subset_data <- clean_data

mpn_values <- subset_data[,c("RH_Sal_MPN_Quan","RH_Sal_value_type")]
colnames(mpn_values) <- c("Salm_MPN", "value_type")
mpn_values$Salm_MPN <- as.character(mpn_values$Salm_MPN)
mpn_values$Salm_MPN <- str_replace_all(mpn_values$Salm_MPN,"<","")
mpn_values$Salm_MPN <- str_replace_all(mpn_values$Salm_MPN,">","")
mpn_values$Salm_MPN <- as.numeric(mpn_values$Salm_MPN)
mpn_values$left <- NA
mpn_values$right <- NA

i <- 1
while (i<=length(mpn_values$Salm_MPN)) {
  if (is.na(mpn_values$value_type[i])) {
    mpn_values$left[i] <- NA
    mpn_values$right[i] <- NA
  } else if (mpn_values$value_type[i]=="cutoff_left") {
    mpn_values$left[i] <- NA
    mpn_values$right[i] <- mpn_values$Salm_MPN[i]
  } else if (mpn_values$value_type[i]=="cutoff_right") {
    mpn_values$left[i] <- mpn_values$Salm_MPN[i]
    mpn_values$right[i] <- NA
  } else if (mpn_values$value_type[i]=="value") {
    mpn_values$left[i] <- mpn_values$Salm_MPN[i]
    mpn_values$right[i] <- mpn_values$Salm_MPN[i]
  }
  i <- i+1
}
left_right_table <- mpn_values[,c("left","right")]
left_right_table <- left_right_table[which(!is.na(left_right_table$left) & !is.na(left_right_table$right)),]
fit_dist_Turkey_Baseline_Salmonella_Paired_2008_2009_RH_fitdistcens_short <- fitdistrplus::fitdistcens(log10(left_right_table), "norm")
cat(paste0("\nMean: ", as.numeric(fit_dist_Turkey_Baseline_Salmonella_Paired_2008_2009_RH_fitdistcens_short$estimate[1]), " SD: ", as.numeric(fit_dist_Turkey_Baseline_Salmonella_Paired_2008_2009_RH_fitdistcens_short$estimate[2]), "\n"))
fitted_count_parts(as.numeric(fit_dist_Turkey_Baseline_Salmonella_Paired_2008_2009_RH_fitdistcens_short$estimate[1]), as.numeric(fit_dist_Turkey_Baseline_Salmonella_Paired_2008_2009_RH_fitdistcens_short$estimate[2]))
new_row <- data.frame(
  file=input_list[1],
  scenario="Turkey_Baseline_Salmonella_Paired_2008_2009_RH",
  fit_type="mpn_fitdistcens_log10_short",
  total=total,
  positives=positives,
  positives_pct=positives_pct,
  negatives=negatives,
  negatives_pct=negatives_pct,
  product_type="carcass",
  positive_threshold=1/30,
  over_1_cfu=over_1_cfu,
  over_1_cfu_pct=over_1_cfu_pct,
  over_10_cfu=over_10_cfu,
  over_10_cfu_pct=over_10_cfu_pct,
  mean=as.numeric(fit_dist_Turkey_Baseline_Salmonella_Paired_2008_2009_RH_fitdistcens_short$estimate[1]),
  sd=as.numeric(fit_dist_Turkey_Baseline_Salmonella_Paired_2008_2009_RH_fitdistcens_short$estimate[2]),
  positives_pct_fit=fitted_count_parts_return(as.numeric(fit_dist_Turkey_Baseline_Salmonella_Paired_2008_2009_RH_fitdistcens_short$estimate[1]), as.numeric(fit_dist_Turkey_Baseline_Salmonella_Paired_2008_2009_RH_fitdistcens_short$estimate[2]))[3],
  negatives_pct_fit=fitted_count_parts_return(as.numeric(fit_dist_Turkey_Baseline_Salmonella_Paired_2008_2009_RH_fitdistcens_short$estimate[1]), as.numeric(fit_dist_Turkey_Baseline_Salmonella_Paired_2008_2009_RH_fitdistcens_short$estimate[2]))[4],
  over_1_cfu_pct_fit=fitted_count_parts_return(as.numeric(fit_dist_Turkey_Baseline_Salmonella_Paired_2008_2009_RH_fitdistcens_short$estimate[1]), as.numeric(fit_dist_Turkey_Baseline_Salmonella_Paired_2008_2009_RH_fitdistcens_short$estimate[2]))[2],
  over_10_cfu_pct_fit=fitted_count_parts_return(as.numeric(fit_dist_Turkey_Baseline_Salmonella_Paired_2008_2009_RH_fitdistcens_short$estimate[1]), as.numeric(fit_dist_Turkey_Baseline_Salmonella_Paired_2008_2009_RH_fitdistcens_short$estimate[2]))[1]
)
fit_row_Turkey_Baseline_Salmonella_Paired_2008_2009_RH_fitdistcens_short <- new_row
# Post Chill ----
n_total <- dim(clean_data)[1]
n_pos_test <- as.numeric(summary(clean_data$PC_Sal_Screen)[2])
n_pos_test_mpn <- sum(!is.na(clean_data$PC_Sal_Tube_MPN))

clean_data$PC_Sal_value_type <- NA
clean_data$PC_Sal_value_type[grepl("<",clean_data$PC_Sal_MPN_Quan)] <- ("cutoff_left")
clean_data$PC_Sal_value_type[grepl(">",clean_data$PC_Sal_MPN_Quan)] <- ("cutoff_right")
clean_data$PC_Sal_value_type[which(!grepl("<",clean_data$PC_Sal_MPN_Quan) & !grepl(">",clean_data$PC_Sal_MPN_Quan) & !is.na(clean_data$PC_Sal_MPN_Quan))] <- "value"
paste0("Post Chill")
paste0("Left Cutoff")
summary(factor(clean_data$PC_Sal_MPN_Quan[which(clean_data$PC_Sal_value_type=="cutoff_left")]))
paste0("Right Cutoff")
summary(factor(clean_data$PC_Sal_MPN_Quan[which(clean_data$PC_Sal_value_type=="cutoff_right")]))
paste0("Values")
summary(factor(clean_data$PC_Sal_MPN_Quan[which(clean_data$PC_Sal_value_type=="value")]))

cfu_threshold_cut(10, clean_data$PC_Sal_MPN_Quan, clean_data$PC_Sal_value_type, 2)
cfu_threshold_cut(1, clean_data$PC_Sal_MPN_Quan, clean_data$PC_Sal_value_type, 2)
cfu_threshold_cut(1/10, clean_data$PC_Sal_MPN_Quan, clean_data$PC_Sal_value_type, 2)
cfu_threshold_cut(1/30, clean_data$PC_Sal_MPN_Quan, clean_data$PC_Sal_value_type, 2)
cfu_threshold_cut(1/325, clean_data$PC_Sal_MPN_Quan, clean_data$PC_Sal_value_type, 2)

over_10_cfu <- cfu_threshold_cut_return(10, clean_data$PC_Sal_MPN_Quan, clean_data$PC_Sal_value_type, NA)[1]
over_10_cfu_pct <- cfu_threshold_cut_return(10, clean_data$PC_Sal_MPN_Quan, clean_data$PC_Sal_value_type, NA)[2]

over_1_cfu <- cfu_threshold_cut_return(1, clean_data$PC_Sal_MPN_Quan, clean_data$PC_Sal_value_type, NA)[1]
over_1_cfu_pct <- cfu_threshold_cut_return(1, clean_data$PC_Sal_MPN_Quan, clean_data$PC_Sal_value_type, NA)[2]

paste0("Positives: ", sum(clean_data$PC_Sal_Screen=="Positive"), " (", round(sum(clean_data$PC_Sal_Screen=="Positive")/length(clean_data$PC_Sal_Screen)*100,2), "%)")
paste0("Negatives: ", sum(clean_data$PC_Sal_Screen=="Negative"), " (", round(sum(clean_data$PC_Sal_Screen=="Negative")/length(clean_data$PC_Sal_Screen)*100,2), "%)")
paste0("Total: ", length(clean_data$PC_Sal_Screen))
total <- length(clean_data$PC_Sal_Screen)
positives <- sum(clean_data$PC_Sal_Screen=="Positive")
positives_pct <- sum(clean_data$PC_Sal_Screen=="Positive")/length(clean_data$PC_Sal_Screen)*100
negatives <- sum(clean_data$PC_Sal_Screen=="Negative")
negatives_pct <- sum(clean_data$PC_Sal_Screen=="Negative")/length(clean_data$PC_Sal_Screen)*100
# Drop sal_mpn_tubes NAs for MPN fitting
subset_data <- clean_data

mpn_values <- subset_data[,c("PC_Sal_MPN_Quan","PC_Sal_value_type")]
colnames(mpn_values) <- c("Salm_MPN", "value_type")
mpn_values$Salm_MPN <- as.character(mpn_values$Salm_MPN)
mpn_values$Salm_MPN <- str_replace_all(mpn_values$Salm_MPN,"<","")
mpn_values$Salm_MPN <- str_replace_all(mpn_values$Salm_MPN,">","")
mpn_values$Salm_MPN <- as.numeric(mpn_values$Salm_MPN)
mpn_values$left <- NA
mpn_values$right <- NA

i <- 1
while (i<=length(mpn_values$Salm_MPN)) {
  if (is.na(mpn_values$value_type[i])) {
    mpn_values$left[i] <- NA
    mpn_values$right[i] <- NA
  } else if (mpn_values$value_type[i]=="cutoff_left") {
    mpn_values$left[i] <- NA
    mpn_values$right[i] <- mpn_values$Salm_MPN[i]
  } else if (mpn_values$value_type[i]=="cutoff_right") {
    mpn_values$left[i] <- mpn_values$Salm_MPN[i]
    mpn_values$right[i] <- NA
  } else if (mpn_values$value_type[i]=="value") {
    mpn_values$left[i] <- mpn_values$Salm_MPN[i]
    mpn_values$right[i] <- mpn_values$Salm_MPN[i]
  }
  i <- i+1
}
left_right_table <- mpn_values[,c("left","right")]
left_right_table <- left_right_table[which(!is.na(left_right_table$left) & !is.na(left_right_table$right)),]
fit_dist_Turkey_Baseline_Salmonella_Paired_2008_2009_PC_fitdistcens_short <- fitdistrplus::fitdistcens(log10(left_right_table), "norm")

cat(paste0("\nMean: ", as.numeric(fit_dist_Turkey_Baseline_Salmonella_Paired_2008_2009_PC_fitdistcens_short$estimate[1]), " SD: ", as.numeric(fit_dist_Turkey_Baseline_Salmonella_Paired_2008_2009_PC_fitdistcens_short$estimate[2]), "\n"))
fitted_count_parts(as.numeric(fit_dist_Turkey_Baseline_Salmonella_Paired_2008_2009_PC_fitdistcens_short$estimate[1]), as.numeric(fit_dist_Turkey_Baseline_Salmonella_Paired_2008_2009_PC_fitdistcens_short$estimate[2]))
new_row <- data.frame(
  file=input_list[1],
  scenario="Turkey_Baseline_Salmonella_Paired_2008_2009_PC",
  fit_type="mpn_fitdistcens_log10_short",
  total=total,
  positives=positives,
  positives_pct=positives_pct,
  negatives=negatives,
  negatives_pct=negatives_pct,
  product_type="carcass",
  positive_threshold=1/30,
  over_1_cfu=over_1_cfu,
  over_1_cfu_pct=over_1_cfu_pct,
  over_10_cfu=over_10_cfu,
  over_10_cfu_pct=over_10_cfu_pct,
  mean=as.numeric(fit_dist_Turkey_Baseline_Salmonella_Paired_2008_2009_PC_fitdistcens_short$estimate[1]),
  sd=as.numeric(fit_dist_Turkey_Baseline_Salmonella_Paired_2008_2009_PC_fitdistcens_short$estimate[2]),
  positives_pct_fit=fitted_count_parts_return(as.numeric(fit_dist_Turkey_Baseline_Salmonella_Paired_2008_2009_PC_fitdistcens_short$estimate[1]), as.numeric(fit_dist_Turkey_Baseline_Salmonella_Paired_2008_2009_PC_fitdistcens_short$estimate[2]))[3],
  negatives_pct_fit=fitted_count_parts_return(as.numeric(fit_dist_Turkey_Baseline_Salmonella_Paired_2008_2009_PC_fitdistcens_short$estimate[1]), as.numeric(fit_dist_Turkey_Baseline_Salmonella_Paired_2008_2009_PC_fitdistcens_short$estimate[2]))[4],
  over_1_cfu_pct_fit=fitted_count_parts_return(as.numeric(fit_dist_Turkey_Baseline_Salmonella_Paired_2008_2009_PC_fitdistcens_short$estimate[1]), as.numeric(fit_dist_Turkey_Baseline_Salmonella_Paired_2008_2009_PC_fitdistcens_short$estimate[2]))[2],
  over_10_cfu_pct_fit=fitted_count_parts_return(as.numeric(fit_dist_Turkey_Baseline_Salmonella_Paired_2008_2009_PC_fitdistcens_short$estimate[1]), as.numeric(fit_dist_Turkey_Baseline_Salmonella_Paired_2008_2009_PC_fitdistcens_short$estimate[2]))[1]
)
fit_row_Turkey_Baseline_Salmonella_Paired_2008_2009_PC_fitdistcens_short <- new_row
```

```{r 5-Turkey_Baseline_Salmonella_Paired_2008_2009.csv fitdistcens_full, echo=FALSE}
paste0("5-Turkey_Baseline_Salmonella_Paired_2008_2009.csv")
paste0(path_raw_data, "/", input_list[1])
input_data <- read.csv(paste0(path_raw_data, "/", input_list[1]))
#
clean_data <- input_data
clean_data$RECD_DATE <- as.Date(clean_data$RECD_DATE, format="%m/%d/%Y")
clean_data$RH_PROJ <- as.factor(clean_data$RH_PROJ)
clean_data$PC_PROJ <- as.factor(clean_data$PC_PROJ)
clean_data$RH_Sal_Screen <- as.factor(clean_data$RH_Sal_Screen)
clean_data$PC_Sal_Screen <- as.factor(clean_data$PC_Sal_Screen)
clean_data$RH_Sal_Qual <- as.factor(clean_data$RH_Sal_Qual)
clean_data$PC_Sal_Qual <- as.factor(clean_data$PC_Sal_Qual)
clean_data$RH_Sal_Serogroup <- as.factor(clean_data$RH_Sal_Serogroup)
clean_data$PC_Sal_Serogroup <- as.factor(clean_data$PC_Sal_Serogroup)
clean_data$RH_Sal_Serotype <- as.factor(clean_data$RH_Sal_Serogroup)
clean_data$PC_Sal_Serotype <- as.factor(clean_data$PC_Sal_Serotype)

clean_data$RH_Sal_Tube_MPN <- as.character(clean_data$RH_Sal_Tube_MPN)
clean_data$RH_Sal_Tube_MPN <- str_pad(clean_data$RH_Sal_Tube_MPN, 5, pad = "0")
clean_data$RH_Sal_Tube_MPN <- as.factor(clean_data$RH_Sal_Tube_MPN)
clean_data$RH_Sal_Tube_MPN_Tube_1 <- as.numeric(substr(clean_data$RH_Sal_Tube_MPN,1,1))
clean_data$RH_Sal_Tube_MPN_Tube_2 <- as.numeric(substr(clean_data$RH_Sal_Tube_MPN,2,2))
clean_data$RH_Sal_Tube_MPN_Tube_3 <- as.numeric(substr(clean_data$RH_Sal_Tube_MPN,3,3))
clean_data$RH_Sal_Tube_MPN_Tube_4 <- as.numeric(substr(clean_data$RH_Sal_Tube_MPN,4,4))
clean_data$RH_Sal_Tube_MPN_Tube_5 <- as.numeric(substr(clean_data$RH_Sal_Tube_MPN,5,5))

clean_data$PC_Sal_Tube_MPN <- as.character(clean_data$PC_Sal_Tube_MPN)
clean_data$PC_Sal_Tube_MPN <- str_pad(clean_data$PC_Sal_Tube_MPN, 5, pad = "0")
clean_data$PC_Sal_Tube_MPN <- as.factor(clean_data$PC_Sal_Tube_MPN)
clean_data$PC_Sal_Tube_MPN_Tube_1 <- as.numeric(substr(clean_data$PC_Sal_Tube_MPN,1,1))
clean_data$PC_Sal_Tube_MPN_Tube_2 <- as.numeric(substr(clean_data$PC_Sal_Tube_MPN,2,2))
clean_data$PC_Sal_Tube_MPN_Tube_3 <- as.numeric(substr(clean_data$PC_Sal_Tube_MPN,3,3))
clean_data$PC_Sal_Tube_MPN_Tube_4 <- as.numeric(substr(clean_data$PC_Sal_Tube_MPN,4,4))
clean_data$PC_Sal_Tube_MPN_Tube_5 <- as.numeric(substr(clean_data$PC_Sal_Tube_MPN,5,5))

clean_data$RH_Sal_MPN_Quan[which(clean_data$RH_Sal_MPN_Quan==0)] <- "<0.075"
clean_data$PC_Sal_MPN_Quan[which(clean_data$PC_Sal_MPN_Quan==0)] <- "<0.075"
# Rehang ----
n_total <- dim(clean_data)[1]
n_pos_test <- as.numeric(summary(clean_data$RH_Sal_Screen)[2])
n_pos_test_mpn <- sum(!is.na(clean_data$RH_Sal_Tube_MPN))

clean_data$RH_Sal_value_type <- NA
clean_data$RH_Sal_value_type[grepl("<",clean_data$RH_Sal_MPN_Quan)] <- ("cutoff_left")
clean_data$RH_Sal_value_type[grepl(">",clean_data$RH_Sal_MPN_Quan)] <- ("cutoff_right")
clean_data$RH_Sal_value_type[which(!grepl("<",clean_data$RH_Sal_MPN_Quan) & !grepl(">",clean_data$RH_Sal_MPN_Quan) & !is.na(clean_data$RH_Sal_MPN_Quan))] <- "value"
paste0("Rehang")
paste0("Left Cutoff")
summary(factor(clean_data$RH_Sal_MPN_Quan[which(clean_data$RH_Sal_value_type=="cutoff_left")]))
paste0("Right Cutoff")
summary(factor(clean_data$RH_Sal_MPN_Quan[which(clean_data$RH_Sal_value_type=="cutoff_right")]))
paste0("Values")
summary(factor(clean_data$RH_Sal_MPN_Quan[which(clean_data$RH_Sal_value_type=="value")]))

cfu_threshold_cut(10, clean_data$RH_Sal_MPN_Quan, clean_data$RH_Sal_value_type, 2)
cfu_threshold_cut(1, clean_data$RH_Sal_MPN_Quan, clean_data$RH_Sal_value_type, 2)
cfu_threshold_cut(1/10, clean_data$RH_Sal_MPN_Quan, clean_data$RH_Sal_value_type, 2)
cfu_threshold_cut(1/30, clean_data$RH_Sal_MPN_Quan, clean_data$RH_Sal_value_type, 2)
cfu_threshold_cut(1/325, clean_data$RH_Sal_MPN_Quan, clean_data$RH_Sal_value_type, 2)

over_10_cfu <- cfu_threshold_cut_return(10, clean_data$RH_Sal_MPN_Quan, clean_data$RH_Sal_value_type, NA)[1]
over_10_cfu_pct <- cfu_threshold_cut_return(10, clean_data$RH_Sal_MPN_Quan, clean_data$RH_Sal_value_type, NA)[2]

over_1_cfu <- cfu_threshold_cut_return(1, clean_data$RH_Sal_MPN_Quan, clean_data$RH_Sal_value_type, NA)[1]
over_1_cfu_pct <- cfu_threshold_cut_return(1, clean_data$RH_Sal_MPN_Quan, clean_data$RH_Sal_value_type, NA)[2]

paste0("Positives: ", sum(clean_data$RH_Sal_Screen=="Positive"), " (", round(sum(clean_data$RH_Sal_Screen=="Positive")/length(clean_data$RH_Sal_Screen)*100,2), "%)")
paste0("Negatives: ", sum(clean_data$RH_Sal_Screen=="Negative"), " (", round(sum(clean_data$RH_Sal_Screen=="Negative")/length(clean_data$RH_Sal_Screen)*100,2), "%)")
paste0("Total: ", length(clean_data$RH_Sal_Screen))
total <- length(clean_data$RH_Sal_Screen)
positives <- sum(clean_data$RH_Sal_Screen=="Positive")
positives_pct <- sum(clean_data$RH_Sal_Screen=="Positive")/length(clean_data$RH_Sal_Screen)*100
negatives <- sum(clean_data$RH_Sal_Screen=="Negative")
negatives_pct <- sum(clean_data$RH_Sal_Screen=="Negative")/length(clean_data$RH_Sal_Screen)*100
subset_data <- clean_data

mpn_values <- subset_data[,c("RH_Sal_MPN_Quan","RH_Sal_value_type")]
colnames(mpn_values) <- c("Salm_MPN", "value_type")
mpn_values$Salm_MPN <- as.character(mpn_values$Salm_MPN)
mpn_values$Salm_MPN <- str_replace_all(mpn_values$Salm_MPN,"<","")
mpn_values$Salm_MPN <- str_replace_all(mpn_values$Salm_MPN,">","")
mpn_values$Salm_MPN <- as.numeric(mpn_values$Salm_MPN)
mpn_values$left <- NA
mpn_values$right <- NA

i <- 1
while (i<=length(mpn_values$Salm_MPN)) {
  if (is.na(mpn_values$value_type[i])) {
    mpn_values$left[i] <- NA
    mpn_values$right[i] <- NA
  } else if (mpn_values$value_type[i]=="cutoff_left") {
    mpn_values$left[i] <- NA
    mpn_values$right[i] <- mpn_values$Salm_MPN[i]
  } else if (mpn_values$value_type[i]=="cutoff_right") {
    mpn_values$left[i] <- mpn_values$Salm_MPN[i]
    mpn_values$right[i] <- NA
  } else if (mpn_values$value_type[i]=="value") {
    mpn_values$left[i] <- mpn_values$Salm_MPN[i]
    mpn_values$right[i] <- mpn_values$Salm_MPN[i]
  }
  i <- i+1
}
left_right_table <- mpn_values[,c("left","right")]
left_right_table <- left_right_table[which(!is.na(left_right_table$left) & !is.na(left_right_table$right)),]
fit_dist_Turkey_Baseline_Salmonella_Paired_2008_2009_RH_fitdistcens_full <- fitdistrplus::fitdistcens(log10(left_right_table), "norm")
cat(paste0("\nMean: ", as.numeric(fit_dist_Turkey_Baseline_Salmonella_Paired_2008_2009_RH_fitdistcens_full$estimate[1]), " SD: ", as.numeric(fit_dist_Turkey_Baseline_Salmonella_Paired_2008_2009_RH_fitdistcens_full$estimate[2]), "\n"))
fitted_count_parts(as.numeric(fit_dist_Turkey_Baseline_Salmonella_Paired_2008_2009_RH_fitdistcens_full$estimate[1]), as.numeric(fit_dist_Turkey_Baseline_Salmonella_Paired_2008_2009_RH_fitdistcens_full$estimate[2]))
new_row <- data.frame(
  file=input_list[1],
  scenario="Turkey_Baseline_Salmonella_Paired_2008_2009_RH",
  fit_type="mpn_fitdistcens_log10_short",
  total=total,
  positives=positives,
  positives_pct=positives_pct,
  negatives=negatives,
  negatives_pct=negatives_pct,
  product_type="carcass",
  positive_threshold=1/30,
  over_1_cfu=over_1_cfu,
  over_1_cfu_pct=over_1_cfu_pct,
  over_10_cfu=over_10_cfu,
  over_10_cfu_pct=over_10_cfu_pct,
  mean=as.numeric(fit_dist_Turkey_Baseline_Salmonella_Paired_2008_2009_RH_fitdistcens_full$estimate[1]),
  sd=as.numeric(fit_dist_Turkey_Baseline_Salmonella_Paired_2008_2009_RH_fitdistcens_full$estimate[2]),
  positives_pct_fit=fitted_count_parts_return(as.numeric(fit_dist_Turkey_Baseline_Salmonella_Paired_2008_2009_RH_fitdistcens_full$estimate[1]), as.numeric(fit_dist_Turkey_Baseline_Salmonella_Paired_2008_2009_RH_fitdistcens_full$estimate[2]))[3],
  negatives_pct_fit=fitted_count_parts_return(as.numeric(fit_dist_Turkey_Baseline_Salmonella_Paired_2008_2009_RH_fitdistcens_full$estimate[1]), as.numeric(fit_dist_Turkey_Baseline_Salmonella_Paired_2008_2009_RH_fitdistcens_full$estimate[2]))[4],
  over_1_cfu_pct_fit=fitted_count_parts_return(as.numeric(fit_dist_Turkey_Baseline_Salmonella_Paired_2008_2009_RH_fitdistcens_full$estimate[1]), as.numeric(fit_dist_Turkey_Baseline_Salmonella_Paired_2008_2009_RH_fitdistcens_full$estimate[2]))[2],
  over_10_cfu_pct_fit=fitted_count_parts_return(as.numeric(fit_dist_Turkey_Baseline_Salmonella_Paired_2008_2009_RH_fitdistcens_full$estimate[1]), as.numeric(fit_dist_Turkey_Baseline_Salmonella_Paired_2008_2009_RH_fitdistcens_full$estimate[2]))[1]
)
fit_row_Turkey_Baseline_Salmonella_Paired_2008_2009_RH_fitdistcens_full <- new_row
# Post Chill ----
n_total <- dim(clean_data)[1]
n_pos_test <- as.numeric(summary(clean_data$PC_Sal_Screen)[2])
n_pos_test_mpn <- sum(!is.na(clean_data$PC_Sal_Tube_MPN))

clean_data$PC_Sal_value_type <- NA
clean_data$PC_Sal_value_type[grepl("<",clean_data$PC_Sal_MPN_Quan)] <- ("cutoff_left")
clean_data$PC_Sal_value_type[grepl(">",clean_data$PC_Sal_MPN_Quan)] <- ("cutoff_right")
clean_data$PC_Sal_value_type[which(!grepl("<",clean_data$PC_Sal_MPN_Quan) & !grepl(">",clean_data$PC_Sal_MPN_Quan) & !is.na(clean_data$PC_Sal_MPN_Quan))] <- "value"
paste0("Post Chill")
paste0("Left Cutoff")
summary(factor(clean_data$PC_Sal_MPN_Quan[which(clean_data$PC_Sal_value_type=="cutoff_left")]))
paste0("Right Cutoff")
summary(factor(clean_data$PC_Sal_MPN_Quan[which(clean_data$PC_Sal_value_type=="cutoff_right")]))
paste0("Values")
summary(factor(clean_data$PC_Sal_MPN_Quan[which(clean_data$PC_Sal_value_type=="value")]))

cfu_threshold_cut(10, clean_data$PC_Sal_MPN_Quan, clean_data$PC_Sal_value_type, 2)
cfu_threshold_cut(1, clean_data$PC_Sal_MPN_Quan, clean_data$PC_Sal_value_type, 2)
cfu_threshold_cut(1/10, clean_data$PC_Sal_MPN_Quan, clean_data$PC_Sal_value_type, 2)
cfu_threshold_cut(1/30, clean_data$PC_Sal_MPN_Quan, clean_data$PC_Sal_value_type, 2)
cfu_threshold_cut(1/325, clean_data$PC_Sal_MPN_Quan, clean_data$PC_Sal_value_type, 2)

over_10_cfu <- cfu_threshold_cut_return(10, clean_data$PC_Sal_MPN_Quan, clean_data$PC_Sal_value_type, NA)[1]
over_10_cfu_pct <- cfu_threshold_cut_return(10, clean_data$PC_Sal_MPN_Quan, clean_data$PC_Sal_value_type, NA)[2]

over_1_cfu <- cfu_threshold_cut_return(1, clean_data$PC_Sal_MPN_Quan, clean_data$PC_Sal_value_type, NA)[1]
over_1_cfu_pct <- cfu_threshold_cut_return(1, clean_data$PC_Sal_MPN_Quan, clean_data$PC_Sal_value_type, NA)[2]

paste0("Positives: ", sum(clean_data$PC_Sal_Screen=="Positive"), " (", round(sum(clean_data$PC_Sal_Screen=="Positive")/length(clean_data$PC_Sal_Screen)*100,2), "%)")
paste0("Negatives: ", sum(clean_data$PC_Sal_Screen=="Negative"), " (", round(sum(clean_data$PC_Sal_Screen=="Negative")/length(clean_data$PC_Sal_Screen)*100,2), "%)")
paste0("Total: ", length(clean_data$PC_Sal_Screen))
total <- length(clean_data$PC_Sal_Screen)
positives <- sum(clean_data$PC_Sal_Screen=="Positive")
positives_pct <- sum(clean_data$PC_Sal_Screen=="Positive")/length(clean_data$PC_Sal_Screen)*100
negatives <- sum(clean_data$PC_Sal_Screen=="Negative")
negatives_pct <- sum(clean_data$PC_Sal_Screen=="Negative")/length(clean_data$PC_Sal_Screen)*100
# Drop sal_mpn_tubes NAs for MPN fitting
subset_data <- clean_data

mpn_values <- subset_data[,c("PC_Sal_MPN_Quan","PC_Sal_value_type")]
colnames(mpn_values) <- c("Salm_MPN", "value_type")
mpn_values$Salm_MPN <- as.character(mpn_values$Salm_MPN)
mpn_values$Salm_MPN <- str_replace_all(mpn_values$Salm_MPN,"<","")
mpn_values$Salm_MPN <- str_replace_all(mpn_values$Salm_MPN,">","")
mpn_values$Salm_MPN <- as.numeric(mpn_values$Salm_MPN)
mpn_values$left <- NA
mpn_values$right <- NA

i <- 1
while (i<=length(mpn_values$Salm_MPN)) {
  if (is.na(mpn_values$value_type[i])) {
    mpn_values$left[i] <- NA
    mpn_values$right[i] <- NA
  } else if (mpn_values$value_type[i]=="cutoff_left") {
    mpn_values$left[i] <- NA
    mpn_values$right[i] <- mpn_values$Salm_MPN[i]
  } else if (mpn_values$value_type[i]=="cutoff_right") {
    mpn_values$left[i] <- mpn_values$Salm_MPN[i]
    mpn_values$right[i] <- NA
  } else if (mpn_values$value_type[i]=="value") {
    mpn_values$left[i] <- mpn_values$Salm_MPN[i]
    mpn_values$right[i] <- mpn_values$Salm_MPN[i]
  }
  i <- i+1
}
left_right_table <- mpn_values[,c("left","right")]
left_right_table <- left_right_table[which(!is.na(left_right_table$left) & !is.na(left_right_table$right)),]
fit_dist_Turkey_Baseline_Salmonella_Paired_2008_2009_PC_fitdistcens_full <- fitdistrplus::fitdistcens(log10(left_right_table), "norm")

cat(paste0("\nMean: ", as.numeric(fit_dist_Turkey_Baseline_Salmonella_Paired_2008_2009_PC_fitdistcens_full$estimate[1]), " SD: ", as.numeric(fit_dist_Turkey_Baseline_Salmonella_Paired_2008_2009_PC_fitdistcens_full$estimate[2]), "\n"))
fitted_count_parts(as.numeric(fit_dist_Turkey_Baseline_Salmonella_Paired_2008_2009_PC_fitdistcens_full$estimate[1]), as.numeric(fit_dist_Turkey_Baseline_Salmonella_Paired_2008_2009_PC_fitdistcens_full$estimate[2]))
new_row <- data.frame(
  file=input_list[1],
  scenario="Turkey_Baseline_Salmonella_Paired_2008_2009_PC",
  fit_type="mpn_fitdistcens_log10_short",
  total=total,
  positives=positives,
  positives_pct=positives_pct,
  negatives=negatives,
  negatives_pct=negatives_pct,
  product_type="carcass",
  positive_threshold=1/30,
  over_1_cfu=over_1_cfu,
  over_1_cfu_pct=over_1_cfu_pct,
  over_10_cfu=over_10_cfu,
  over_10_cfu_pct=over_10_cfu_pct,
  mean=as.numeric(fit_dist_Turkey_Baseline_Salmonella_Paired_2008_2009_PC_fitdistcens_full$estimate[1]),
  sd=as.numeric(fit_dist_Turkey_Baseline_Salmonella_Paired_2008_2009_PC_fitdistcens_full$estimate[2]),
  positives_pct_fit=fitted_count_parts_return(as.numeric(fit_dist_Turkey_Baseline_Salmonella_Paired_2008_2009_PC_fitdistcens_full$estimate[1]), as.numeric(fit_dist_Turkey_Baseline_Salmonella_Paired_2008_2009_PC_fitdistcens_full$estimate[2]))[3],
  negatives_pct_fit=fitted_count_parts_return(as.numeric(fit_dist_Turkey_Baseline_Salmonella_Paired_2008_2009_PC_fitdistcens_full$estimate[1]), as.numeric(fit_dist_Turkey_Baseline_Salmonella_Paired_2008_2009_PC_fitdistcens_full$estimate[2]))[4],
  over_1_cfu_pct_fit=fitted_count_parts_return(as.numeric(fit_dist_Turkey_Baseline_Salmonella_Paired_2008_2009_PC_fitdistcens_full$estimate[1]), as.numeric(fit_dist_Turkey_Baseline_Salmonella_Paired_2008_2009_PC_fitdistcens_full$estimate[2]))[2],
  over_10_cfu_pct_fit=fitted_count_parts_return(as.numeric(fit_dist_Turkey_Baseline_Salmonella_Paired_2008_2009_PC_fitdistcens_full$estimate[1]), as.numeric(fit_dist_Turkey_Baseline_Salmonella_Paired_2008_2009_PC_fitdistcens_full$estimate[2]))[1]
)
fit_row_Turkey_Baseline_Salmonella_Paired_2008_2009_PC_fitdistcens_full <- new_row
```

```{r 6-Turkey_Verification_Salmonella_2016_2021_final.csv Ebel, echo=FALSE}
paste0("6-Turkey_Verification_Salmonella_2016_2021_final.csv")
paste0(path_raw_data, "/", input_list[2])
input_data <- read.csv(paste0(path_raw_data, "/", input_list[2]))
#
clean_data <- input_data
clean_data$HACCPProcessingSize <- as.factor(clean_data$HACCPProcessingSize)
clean_data$ProjectCode <- as.factor(clean_data$ProjectCode)
clean_data <- clean_data[which(clean_data$ProjectCode=="HC_TU_COM01"),]
clean_data$ProjectName <- as.factor(clean_data$ProjectName)
clean_data$CollectDate <- as.Date(clean_data$CollectDate, format="%m/%d/%Y")
clean_data$ProjectName <- as.factor(clean_data$ProjectName)
clean_data$SALM_Result_3651 <- as.factor(clean_data$SALM_Result_3651)
clean_data$SEROTYPE <- as.factor(clean_data$SEROTYPE)
clean_data$SEROTYPE[which(clean_data$SEROTYPE=="")] <- NA
clean_data$Salm_MPN <- as.factor(clean_data$Salm_MPN)
clean_data$Salm_MPN[which(clean_data$Salm_MPN=="")] <- NA
clean_data$Salm_MPN_Comb <- as.character(clean_data$Salm_MPN_Comb)
clean_data$Salm_MPN_Comb <- str_pad(clean_data$Salm_MPN_Comb, 5, pad = "0")
clean_data$Salm_Qualit_MPN <- as.factor(clean_data$Salm_Qualit_MPN)
clean_data$Salm_Qualit_MPN[which(clean_data$Salm_Qualit_MPN=="")] <- NA
clean_data$Salm_MPN_Comb_Tube_1 <- as.numeric(substr(clean_data$Salm_MPN_Comb,1,1))
clean_data$Salm_MPN_Comb_Tube_2 <- as.numeric(substr(clean_data$Salm_MPN_Comb,2,2))
clean_data$Salm_MPN_Comb_Tube_3 <- as.numeric(substr(clean_data$Salm_MPN_Comb,3,3))
clean_data$Salm_MPN_Comb_Tube_4 <- as.numeric(substr(clean_data$Salm_MPN_Comb,4,4))
clean_data$Salm_MPN_Comb_Tube_5 <- as.numeric(substr(clean_data$Salm_MPN_Comb,5,5))

clean_data <- clean_data[-which(clean_data$SALM_Result_3651=="25-20  Other - (Describe on form in up to 54 characters)"),]
clean_data <- clean_data[-which(clean_data$SALM_Result_3651=="26 Lab closed"),]
clean_data <- clean_data[-which(clean_data$Salm_MPN=="25-24 Lab Problem - Resources or Personnel not available due to emergency response"),]
clean_data$SALM_Result_3651 <- factor(clean_data$SALM_Result_3651)
clean_data$Salm_MPN <- factor(clean_data$Salm_MPN)

n_total <- dim(clean_data)[1]
n_pos_test <- as.numeric(summary(clean_data$SALM_Result_3651)[2])
n_pos_test_mpn <- sum(!is.na(clean_data$Salm_MPN_Comb))

clean_data$Salm_value_type <- NA
clean_data$Salm_value_type[grepl("<",clean_data$Salm_MPN)] <- ("cutoff_left")
clean_data$Salm_value_type[grepl(">",clean_data$Salm_MPN)] <- ("cutoff_right")
clean_data$Salm_value_type[which(!grepl("<",clean_data$Salm_MPN) & !grepl(">",clean_data$Salm_MPN) & !is.na(clean_data$Salm_MPN))] <- "value"
paste0("Post Chill")
paste0("Left Cutoff")
summary(factor(clean_data$Salm_MPN[which(clean_data$Salm_value_type=="cutoff_left")]))
paste0("Right Cutoff")
summary(factor(clean_data$Salm_MPN[which(clean_data$Salm_value_type=="cutoff_right")]))
paste0("Values")
summary(factor(clean_data$Salm_MPN[which(clean_data$Salm_value_type=="value")]))

cfu_threshold_cut(10, clean_data$Salm_MPN, clean_data$Salm_value_type, 2)
cfu_threshold_cut(1, clean_data$Salm_MPN, clean_data$Salm_value_type, 2)
cfu_threshold_cut(1/10, clean_data$Salm_MPN, clean_data$Salm_value_type, 2)
cfu_threshold_cut(1/30, clean_data$Salm_MPN, clean_data$Salm_value_type, 2)
cfu_threshold_cut(1/325, clean_data$Salm_MPN, clean_data$Salm_value_type, 2)

over_10_cfu <- cfu_threshold_cut_return(10, clean_data$Salm_MPN, clean_data$Salm_value_type, NA)[1]
over_10_cfu_pct <- cfu_threshold_cut_return(10, clean_data$Salm_MPN, clean_data$Salm_value_type, NA)[2]

over_1_cfu <- cfu_threshold_cut_return(1, clean_data$Salm_MPN, clean_data$Salm_value_type, NA)[1]
over_1_cfu_pct <- cfu_threshold_cut_return(1, clean_data$Salm_MPN, clean_data$Salm_value_type, NA)[2]

paste0("Positives: ", sum(clean_data$SALM_Result_3651=="Positive"), " (", round(sum(clean_data$SALM_Result_3651=="Positive")/length(clean_data$SALM_Result_3651)*100,2), "%)")
paste0("Negatives: ", sum(clean_data$SALM_Result_3651=="Negative"), " (", round(sum(clean_data$SALM_Result_3651=="Negative")/length(clean_data$SALM_Result_3651)*100,2), "%)")
paste0("Total: ", length(clean_data$SALM_Result_3651))
total <- length(clean_data$SALM_Result_3651)
positives <- sum(clean_data$SALM_Result_3651=="Positive")
positives_pct <- sum(clean_data$SALM_Result_3651=="Positive")/length(clean_data$SALM_Result_3651)*100
negatives <- sum(clean_data$SALM_Result_3651=="Negative")
negatives_pct <- sum(clean_data$SALM_Result_3651=="Negative")/length(clean_data$SALM_Result_3651)*100

# Drop sal_mpn_tubes NAs for MPN fitting
subset_data <- clean_data[!is.na(clean_data$Salm_MPN_Comb),]
# MPN
fit_dist_Turkey_Verification_Salmonella_2016_2021_final_ebel <- mpn_fit(subset(subset_data, select = c("Salm_MPN_Comb_Tube_1","Salm_MPN_Comb_Tube_2","Salm_MPN_Comb_Tube_3","Salm_MPN_Comb_Tube_4","Salm_MPN_Comb_Tube_5")), n_total, n_pos_test, n_pos_test_mpn, 5, "ground")
cat(paste0("\nMean: ", log10(exp(fit_dist_Turkey_Verification_Salmonella_2016_2021_final_ebel$mu[9])), " SD: ", log10(exp(fit_dist_Turkey_Verification_Salmonella_2016_2021_final_ebel$sigma[9])), "\n"))
fitted_count_parts(log10(exp(fit_dist_Turkey_Verification_Salmonella_2016_2021_final_ebel$mu[9])), log10(exp(fit_dist_Turkey_Verification_Salmonella_2016_2021_final_ebel$sigma[9])))
new_row <- data.frame(
  file=input_list[2],
  scenario="Turkey_Verification_Salmonella_2016_2021_final.csv",
  fit_type="mpn_ebel_log10norm",
  total=total,
  positives=positives,
  positives_pct=positives_pct,
  negatives=negatives,
  negatives_pct=negatives_pct,
  product_type="ground",
  positive_threshold=1/325,
  over_1_cfu=over_1_cfu,
  over_1_cfu_pct=over_1_cfu_pct,
  over_10_cfu=over_10_cfu,
  over_10_cfu_pct=over_10_cfu_pct,
  mean=log10(exp(fit_dist_Turkey_Verification_Salmonella_2016_2021_final_ebel$mu[9])),
  sd=log10(exp(fit_dist_Turkey_Verification_Salmonella_2016_2021_final_ebel$sigma[9])),
  positives_pct_fit=fitted_count_parts_return(log10(exp(fit_dist_Turkey_Verification_Salmonella_2016_2021_final_ebel$mu[9])), log10(exp(fit_dist_Turkey_Verification_Salmonella_2016_2021_final_ebel$sigma[9])))[3],
  negatives_pct_fit=fitted_count_parts_return(log10(exp(fit_dist_Turkey_Verification_Salmonella_2016_2021_final_ebel$mu[9])), log10(exp(fit_dist_Turkey_Verification_Salmonella_2016_2021_final_ebel$sigma[9])))[4],
  over_1_cfu_pct_fit=fitted_count_parts_return(log10(exp(fit_dist_Turkey_Verification_Salmonella_2016_2021_final_ebel$mu[9])), log10(exp(fit_dist_Turkey_Verification_Salmonella_2016_2021_final_ebel$sigma[9])))[2],
  over_10_cfu_pct_fit=fitted_count_parts_return(log10(exp(fit_dist_Turkey_Verification_Salmonella_2016_2021_final_ebel$mu[9])), log10(exp(fit_dist_Turkey_Verification_Salmonella_2016_2021_final_ebel$sigma[9])))[1]
)
fit_row_Turkey_Verification_Salmonella_2016_2021_final_ebel <- new_row
```

```{r 6-Turkey_Verification_Salmonella_2016_2021_final.csv Ebel_override, echo=FALSE}
paste0("6-Turkey_Verification_Salmonella_2016_2021_final.csv")
paste0(path_raw_data, "/", input_list[2])
input_data <- read.csv(paste0(path_raw_data, "/", input_list[2]))
#
clean_data <- input_data
clean_data$HACCPProcessingSize <- as.factor(clean_data$HACCPProcessingSize)
clean_data$ProjectCode <- as.factor(clean_data$ProjectCode)
clean_data <- clean_data[which(clean_data$ProjectCode=="HC_TU_COM01"),]
clean_data$ProjectName <- as.factor(clean_data$ProjectName)
clean_data$CollectDate <- as.Date(clean_data$CollectDate, format="%m/%d/%Y")
clean_data$ProjectName <- as.factor(clean_data$ProjectName)
clean_data$SALM_Result_3651 <- as.factor(clean_data$SALM_Result_3651)
clean_data$SEROTYPE <- as.factor(clean_data$SEROTYPE)
clean_data$SEROTYPE[which(clean_data$SEROTYPE=="")] <- NA
clean_data$Salm_MPN <- as.factor(clean_data$Salm_MPN)
clean_data$Salm_MPN[which(clean_data$Salm_MPN=="")] <- NA
clean_data$Salm_MPN_Comb <- as.character(clean_data$Salm_MPN_Comb)
clean_data$Salm_MPN_Comb <- str_pad(clean_data$Salm_MPN_Comb, 5, pad = "0")
clean_data$Salm_Qualit_MPN <- as.factor(clean_data$Salm_Qualit_MPN)
clean_data$Salm_Qualit_MPN[which(clean_data$Salm_Qualit_MPN=="")] <- NA
clean_data$Salm_MPN_Comb_Tube_1 <- as.numeric(substr(clean_data$Salm_MPN_Comb,1,1))
clean_data$Salm_MPN_Comb_Tube_2 <- as.numeric(substr(clean_data$Salm_MPN_Comb,2,2))
clean_data$Salm_MPN_Comb_Tube_3 <- as.numeric(substr(clean_data$Salm_MPN_Comb,3,3))
clean_data$Salm_MPN_Comb_Tube_4 <- as.numeric(substr(clean_data$Salm_MPN_Comb,4,4))
clean_data$Salm_MPN_Comb_Tube_5 <- as.numeric(substr(clean_data$Salm_MPN_Comb,5,5))

clean_data <- clean_data[-which(clean_data$SALM_Result_3651=="25-20  Other - (Describe on form in up to 54 characters)"),]
clean_data <- clean_data[-which(clean_data$SALM_Result_3651=="26 Lab closed"),]
clean_data <- clean_data[-which(clean_data$Salm_MPN=="25-24 Lab Problem - Resources or Personnel not available due to emergency response"),]
clean_data$SALM_Result_3651 <- factor(clean_data$SALM_Result_3651)
clean_data$Salm_MPN <- factor(clean_data$Salm_MPN)

# n_total <- dim(clean_data)[1]
# n_pos_test <- as.numeric(summary(clean_data$SALM_Result_3651)[2])
# n_pos_test_mpn <- sum(!is.na(clean_data$Salm_MPN_Comb))

n_total <- 1051 # Override by Minho
n_pos_test <- 164
n_pos_test_mpn <- 164

clean_data$Salm_value_type <- NA
clean_data$Salm_value_type[grepl("<",clean_data$Salm_MPN)] <- ("cutoff_left")
clean_data$Salm_value_type[grepl(">",clean_data$Salm_MPN)] <- ("cutoff_right")
clean_data$Salm_value_type[which(!grepl("<",clean_data$Salm_MPN) & !grepl(">",clean_data$Salm_MPN) & !is.na(clean_data$Salm_MPN))] <- "value"
paste0("Left Cutoff")
summary(factor(clean_data$Salm_MPN[which(clean_data$Salm_value_type=="cutoff_left")]))
paste0("Right Cutoff")
summary(factor(clean_data$Salm_MPN[which(clean_data$Salm_value_type=="cutoff_right")]))
paste0("Values")
summary(factor(clean_data$Salm_MPN[which(clean_data$Salm_value_type=="value")]))

cfu_threshold_cut(10, clean_data$Salm_MPN, clean_data$Salm_value_type, 2)
cfu_threshold_cut(1, clean_data$Salm_MPN, clean_data$Salm_value_type, 2)
cfu_threshold_cut(1/10, clean_data$Salm_MPN, clean_data$Salm_value_type, 2)
cfu_threshold_cut(1/30, clean_data$Salm_MPN, clean_data$Salm_value_type, 2)
cfu_threshold_cut(1/325, clean_data$Salm_MPN, clean_data$Salm_value_type, 2)

over_10_cfu <- cfu_threshold_cut_return(10, clean_data$Salm_MPN, clean_data$Salm_value_type, NA)[1]
over_10_cfu_pct <- cfu_threshold_cut_return(10, clean_data$Salm_MPN, clean_data$Salm_value_type, NA)[2]

over_1_cfu <- cfu_threshold_cut_return(1, clean_data$Salm_MPN, clean_data$Salm_value_type, NA)[1]
over_1_cfu_pct <- cfu_threshold_cut_return(1, clean_data$Salm_MPN, clean_data$Salm_value_type, NA)[2]

paste0("Positives: ", sum(clean_data$SALM_Result_3651=="Positive"), " (", round(sum(clean_data$SALM_Result_3651=="Positive")/length(clean_data$SALM_Result_3651)*100,2), "%)")
paste0("Negatives: ", sum(clean_data$SALM_Result_3651=="Negative"), " (", round(sum(clean_data$SALM_Result_3651=="Negative")/length(clean_data$SALM_Result_3651)*100,2), "%)")
paste0("Total: ", length(clean_data$SALM_Result_3651))
total <- length(clean_data$SALM_Result_3651)
positives <- sum(clean_data$SALM_Result_3651=="Positive")
positives_pct <- sum(clean_data$SALM_Result_3651=="Positive")/length(clean_data$SALM_Result_3651)*100
negatives <- sum(clean_data$SALM_Result_3651=="Negative")
negatives_pct <- sum(clean_data$SALM_Result_3651=="Negative")/length(clean_data$SALM_Result_3651)*100

# Drop sal_mpn_tubes NAs for MPN fitting
subset_data <- clean_data[!is.na(clean_data$Salm_MPN_Comb),]
# MPN
fit_dist_Turkey_Verification_Salmonella_2016_2021_final_ebel_override <- mpn_fit(subset(subset_data, select = c("Salm_MPN_Comb_Tube_1","Salm_MPN_Comb_Tube_2","Salm_MPN_Comb_Tube_3","Salm_MPN_Comb_Tube_4","Salm_MPN_Comb_Tube_5")), n_total, n_pos_test, n_pos_test_mpn, 5, "ground")
cat(paste0("\nMean: ", log10(exp(fit_dist_Turkey_Verification_Salmonella_2016_2021_final_ebel_override$mu[9])), " SD: ", log10(exp(fit_dist_Turkey_Verification_Salmonella_2016_2021_final_ebel_override$sigma[9])), "\n"))
fitted_count_parts(log10(exp(fit_dist_Turkey_Verification_Salmonella_2016_2021_final_ebel_override$mu[9])), log10(exp(fit_dist_Turkey_Verification_Salmonella_2016_2021_final_ebel_override$sigma[9])))
new_row <- data.frame(
  file=input_list[2],
  scenario="Turkey_Verification_Salmonella_2016_2021_final.csv",
  fit_type="mpn_ebel_log10norm_override",
  total=total,
  positives=positives,
  positives_pct=positives_pct,
  negatives=negatives,
  negatives_pct=negatives_pct,
  product_type="ground",
  positive_threshold=1/325,
  over_1_cfu=over_1_cfu,
  over_1_cfu_pct=over_1_cfu_pct,
  over_10_cfu=over_10_cfu,
  over_10_cfu_pct=over_10_cfu_pct,
  mean=log10(exp(fit_dist_Turkey_Verification_Salmonella_2016_2021_final_ebel_override$mu[9])),
  sd=log10(exp(fit_dist_Turkey_Verification_Salmonella_2016_2021_final_ebel_override$sigma[9])),
  positives_pct_fit=fitted_count_parts_return(log10(exp(fit_dist_Turkey_Verification_Salmonella_2016_2021_final_ebel_override$mu[9])), log10(exp(fit_dist_Turkey_Verification_Salmonella_2016_2021_final_ebel_override$sigma[9])))[3],
  negatives_pct_fit=fitted_count_parts_return(log10(exp(fit_dist_Turkey_Verification_Salmonella_2016_2021_final_ebel_override$mu[9])), log10(exp(fit_dist_Turkey_Verification_Salmonella_2016_2021_final_ebel_override$sigma[9])))[4],
  over_1_cfu_pct_fit=fitted_count_parts_return(log10(exp(fit_dist_Turkey_Verification_Salmonella_2016_2021_final_ebel_override$mu[9])), log10(exp(fit_dist_Turkey_Verification_Salmonella_2016_2021_final_ebel_override$sigma[9])))[2],
  over_10_cfu_pct_fit=fitted_count_parts_return(log10(exp(fit_dist_Turkey_Verification_Salmonella_2016_2021_final_ebel_override$mu[9])), log10(exp(fit_dist_Turkey_Verification_Salmonella_2016_2021_final_ebel_override$sigma[9])))[1]
)
fit_row_Turkey_Verification_Salmonella_2016_2021_final_ebel_override <- new_row
```

```{r 6-Turkey_Verification_Salmonella_2016_2021_final.csv fitdistcens_short, echo=FALSE}
paste0("6-Turkey_Verification_Salmonella_2016_2021_final.csv")
paste0(path_raw_data, "/", input_list[2])
input_data <- read.csv(paste0(path_raw_data, "/", input_list[2]))
#
clean_data <- input_data
clean_data$HACCPProcessingSize <- as.factor(clean_data$HACCPProcessingSize)
clean_data$ProjectCode <- as.factor(clean_data$ProjectCode)
clean_data <- clean_data[which(clean_data$ProjectCode=="HC_TU_COM01"),]
clean_data$ProjectName <- as.factor(clean_data$ProjectName)
clean_data$CollectDate <- as.Date(clean_data$CollectDate, format="%m/%d/%Y")
clean_data$ProjectName <- as.factor(clean_data$ProjectName)
clean_data$SALM_Result_3651 <- as.factor(clean_data$SALM_Result_3651)
clean_data$SEROTYPE <- as.factor(clean_data$SEROTYPE)
clean_data$SEROTYPE[which(clean_data$SEROTYPE=="")] <- NA
clean_data$Salm_MPN <- as.factor(clean_data$Salm_MPN)
clean_data$Salm_MPN[which(clean_data$Salm_MPN=="")] <- NA
clean_data$Salm_MPN_Comb <- as.character(clean_data$Salm_MPN_Comb)
clean_data$Salm_MPN_Comb <- str_pad(clean_data$Salm_MPN_Comb, 5, pad = "0")
clean_data$Salm_Qualit_MPN <- as.factor(clean_data$Salm_Qualit_MPN)
clean_data$Salm_Qualit_MPN[which(clean_data$Salm_Qualit_MPN=="")] <- NA
clean_data$Salm_MPN_Comb_Tube_1 <- as.numeric(substr(clean_data$Salm_MPN_Comb,1,1))
clean_data$Salm_MPN_Comb_Tube_2 <- as.numeric(substr(clean_data$Salm_MPN_Comb,2,2))
clean_data$Salm_MPN_Comb_Tube_3 <- as.numeric(substr(clean_data$Salm_MPN_Comb,3,3))
clean_data$Salm_MPN_Comb_Tube_4 <- as.numeric(substr(clean_data$Salm_MPN_Comb,4,4))
clean_data$Salm_MPN_Comb_Tube_5 <- as.numeric(substr(clean_data$Salm_MPN_Comb,5,5))

clean_data <- clean_data[-which(clean_data$SALM_Result_3651=="25-20  Other - (Describe on form in up to 54 characters)"),]
clean_data <- clean_data[-which(clean_data$SALM_Result_3651=="26 Lab closed"),]
clean_data <- clean_data[-which(clean_data$Salm_MPN=="25-24 Lab Problem - Resources or Personnel not available due to emergency response"),]
clean_data$SALM_Result_3651 <- factor(clean_data$SALM_Result_3651)
clean_data$Salm_MPN <- factor(clean_data$Salm_MPN)

n_total <- dim(clean_data)[1]
n_pos_test <- as.numeric(summary(clean_data$SALM_Result_3651)[2])
n_pos_test_mpn <- sum(!is.na(clean_data$Salm_MPN_Comb))

clean_data$Salm_value_type <- NA
clean_data$Salm_value_type[grepl("<",clean_data$Salm_MPN)] <- ("cutoff_left")
clean_data$Salm_value_type[grepl(">",clean_data$Salm_MPN)] <- ("cutoff_right")
clean_data$Salm_value_type[which(!grepl("<",clean_data$Salm_MPN) & !grepl(">",clean_data$Salm_MPN) & !is.na(clean_data$Salm_MPN))] <- "value"
paste0("Left Cutoff")
summary(factor(clean_data$Salm_MPN[which(clean_data$Salm_value_type=="cutoff_left")]))
paste0("Right Cutoff")
summary(factor(clean_data$Salm_MPN[which(clean_data$Salm_value_type=="cutoff_right")]))
paste0("Values")
summary(factor(clean_data$Salm_MPN[which(clean_data$Salm_value_type=="value")]))

cfu_threshold_cut(10, clean_data$Salm_MPN, clean_data$Salm_value_type, 2)
cfu_threshold_cut(1, clean_data$Salm_MPN, clean_data$Salm_value_type, 2)
cfu_threshold_cut(1/10, clean_data$Salm_MPN, clean_data$Salm_value_type, 2)
cfu_threshold_cut(1/30, clean_data$Salm_MPN, clean_data$Salm_value_type, 2)
cfu_threshold_cut(1/325, clean_data$Salm_MPN, clean_data$Salm_value_type, 2)

over_10_cfu <- cfu_threshold_cut_return(10, clean_data$Salm_MPN, clean_data$Salm_value_type, NA)[1]
over_10_cfu_pct <- cfu_threshold_cut_return(10, clean_data$Salm_MPN, clean_data$Salm_value_type, NA)[2]

over_1_cfu <- cfu_threshold_cut_return(1, clean_data$Salm_MPN, clean_data$Salm_value_type, NA)[1]
over_1_cfu_pct <- cfu_threshold_cut_return(1, clean_data$Salm_MPN, clean_data$Salm_value_type, NA)[2]

paste0("Positives: ", sum(clean_data$SALM_Result_3651=="Positive"), " (", round(sum(clean_data$SALM_Result_3651=="Positive")/length(clean_data$SALM_Result_3651)*100,2), "%)")
paste0("Negatives: ", sum(clean_data$SALM_Result_3651=="Negative"), " (", round(sum(clean_data$SALM_Result_3651=="Negative")/length(clean_data$SALM_Result_3651)*100,2), "%)")
paste0("Total: ", length(clean_data$SALM_Result_3651))
total <- length(clean_data$SALM_Result_3651)
positives <- sum(clean_data$SALM_Result_3651=="Positive")
positives_pct <- sum(clean_data$SALM_Result_3651=="Positive")/length(clean_data$SALM_Result_3651)*100
negatives <- sum(clean_data$SALM_Result_3651=="Negative")
negatives_pct <- sum(clean_data$SALM_Result_3651=="Negative")/length(clean_data$SALM_Result_3651)*100

mpn_values <- clean_data[,c("Salm_MPN","Salm_value_type")]
colnames(mpn_values) <- c("Salm_MPN", "value_type")
mpn_values$Salm_MPN <- as.character(mpn_values$Salm_MPN)
mpn_values$Salm_MPN <- str_replace_all(mpn_values$Salm_MPN,"<","")
mpn_values$Salm_MPN <- str_replace_all(mpn_values$Salm_MPN,">","")
mpn_values$Salm_MPN <- as.numeric(mpn_values$Salm_MPN)
mpn_values$left <- NA
mpn_values$right <- NA

i <- 1
while (i<=length(mpn_values$Salm_MPN)) {
  if (is.na(mpn_values$value_type[i])) {
    mpn_values$left[i] <- NA
    mpn_values$right[i] <- NA
  } else if (mpn_values$value_type[i]=="cutoff_left") {
    mpn_values$left[i] <- NA
    mpn_values$right[i] <- mpn_values$Salm_MPN[i]
  } else if (mpn_values$value_type[i]=="cutoff_right") {
    mpn_values$left[i] <- mpn_values$Salm_MPN[i]
    mpn_values$right[i] <- NA
  } else if (mpn_values$value_type[i]=="value") {
    mpn_values$left[i] <- mpn_values$Salm_MPN[i]
    mpn_values$right[i] <- mpn_values$Salm_MPN[i]
  }
  i <- i+1
}
left_right_table <- mpn_values[,c("left","right")]
left_right_table <- left_right_table[which(!is.na(left_right_table$left) & !is.na(left_right_table$right)),]
fit_dist_Turkey_Verification_Salmonella_2016_2021_final_fitdistcens_log10_short <- fitdistrplus::fitdistcens(log10(left_right_table), "norm")

cat(paste0("\nMean: ", as.numeric(fit_dist_Turkey_Verification_Salmonella_2016_2021_final_fitdistcens_log10_short$estimate[1]), " SD: ", as.numeric(fit_dist_Turkey_Verification_Salmonella_2016_2021_final_fitdistcens_log10_short$estimate[2]), "\n"))
fitted_count_parts(as.numeric(fit_dist_Turkey_Verification_Salmonella_2016_2021_final_fitdistcens_log10_short$estimate[1]), as.numeric(fit_dist_Turkey_Verification_Salmonella_2016_2021_final_fitdistcens_log10_short$estimate[2]))
new_row <- data.frame(
  file=input_list[2],
  scenario="Turkey_Verification_Salmonella_2016_2021_final.csv",
  fit_type="mpn_fitdistcens_log10_short",
  total=total,
  positives=positives,
  positives_pct=positives_pct,
  negatives=negatives,
  negatives_pct=negatives_pct,
  product_type="ground",
  positive_threshold=1/325,
  over_1_cfu=over_1_cfu,
  over_1_cfu_pct=over_1_cfu_pct,
  over_10_cfu=over_10_cfu,
  over_10_cfu_pct=over_10_cfu_pct,
  mean=as.numeric(fit_dist_Turkey_Verification_Salmonella_2016_2021_final_fitdistcens_log10_short$estimate[1]),
  sd=as.numeric(fit_dist_Turkey_Verification_Salmonella_2016_2021_final_fitdistcens_log10_short$estimate[2]),
  positives_pct_fit=fitted_count_parts_return(as.numeric(fit_dist_Turkey_Verification_Salmonella_2016_2021_final_fitdistcens_log10_short$estimate[1]), as.numeric(fit_dist_Turkey_Verification_Salmonella_2016_2021_final_fitdistcens_log10_short$estimate[2]))[3],
  negatives_pct_fit=fitted_count_parts_return(as.numeric(fit_dist_Turkey_Verification_Salmonella_2016_2021_final_fitdistcens_log10_short$estimate[1]), as.numeric(fit_dist_Turkey_Verification_Salmonella_2016_2021_final_fitdistcens_log10_short$estimate[2]))[4],
  over_1_cfu_pct_fit=fitted_count_parts_return(as.numeric(fit_dist_Turkey_Verification_Salmonella_2016_2021_final_fitdistcens_log10_short$estimate[1]), as.numeric(fit_dist_Turkey_Verification_Salmonella_2016_2021_final_fitdistcens_log10_short$estimate[2]))[2],
  over_10_cfu_pct_fit=fitted_count_parts_return(as.numeric(fit_dist_Turkey_Verification_Salmonella_2016_2021_final_fitdistcens_log10_short$estimate[1]), as.numeric(fit_dist_Turkey_Verification_Salmonella_2016_2021_final_fitdistcens_log10_short$estimate[2]))[1]
)
fit_row_Turkey_Verification_Salmonella_2016_2021_final_fitdistcens_log10_short <- new_row
```

```{r 6-Turkey_Verification_Salmonella_2016_2021_final.csv fitdistcens_full, echo=FALSE}
paste0("6-Turkey_Verification_Salmonella_2016_2021_final.csv")
paste0(path_raw_data, "/", input_list[2])
input_data <- read.csv(paste0(path_raw_data, "/", input_list[2]))
#
clean_data <- input_data
clean_data$HACCPProcessingSize <- as.factor(clean_data$HACCPProcessingSize)
clean_data$ProjectCode <- as.factor(clean_data$ProjectCode)
clean_data <- clean_data[which(clean_data$ProjectCode=="HC_TU_COM01"),]
clean_data$ProjectName <- as.factor(clean_data$ProjectName)
clean_data$CollectDate <- as.Date(clean_data$CollectDate, format="%m/%d/%Y")
clean_data$ProjectName <- as.factor(clean_data$ProjectName)
clean_data$SALM_Result_3651 <- as.factor(clean_data$SALM_Result_3651)
clean_data$SEROTYPE <- as.factor(clean_data$SEROTYPE)
clean_data$SEROTYPE[which(clean_data$SEROTYPE=="")] <- NA
clean_data$Salm_MPN <- as.factor(clean_data$Salm_MPN)
clean_data$Salm_MPN[which(clean_data$Salm_MPN=="")] <- NA
clean_data$Salm_MPN_Comb <- as.character(clean_data$Salm_MPN_Comb)
clean_data$Salm_MPN_Comb <- str_pad(clean_data$Salm_MPN_Comb, 5, pad = "0")
clean_data$Salm_Qualit_MPN <- as.factor(clean_data$Salm_Qualit_MPN)
clean_data$Salm_Qualit_MPN[which(clean_data$Salm_Qualit_MPN=="")] <- NA
clean_data$Salm_MPN_Comb_Tube_1 <- as.numeric(substr(clean_data$Salm_MPN_Comb,1,1))
clean_data$Salm_MPN_Comb_Tube_2 <- as.numeric(substr(clean_data$Salm_MPN_Comb,2,2))
clean_data$Salm_MPN_Comb_Tube_3 <- as.numeric(substr(clean_data$Salm_MPN_Comb,3,3))
clean_data$Salm_MPN_Comb_Tube_4 <- as.numeric(substr(clean_data$Salm_MPN_Comb,4,4))
clean_data$Salm_MPN_Comb_Tube_5 <- as.numeric(substr(clean_data$Salm_MPN_Comb,5,5))

clean_data <- clean_data[-which(clean_data$SALM_Result_3651=="25-20  Other - (Describe on form in up to 54 characters)"),]
clean_data <- clean_data[-which(clean_data$SALM_Result_3651=="26 Lab closed"),]
clean_data <- clean_data[-which(clean_data$Salm_MPN=="25-24 Lab Problem - Resources or Personnel not available due to emergency response"),]
clean_data$SALM_Result_3651 <- factor(clean_data$SALM_Result_3651)
clean_data$Salm_MPN <- factor(clean_data$Salm_MPN)

n_total <- dim(clean_data)[1]
n_pos_test <- as.numeric(summary(clean_data$SALM_Result_3651)[2])
n_pos_test_mpn <- sum(!is.na(clean_data$Salm_MPN_Comb))

clean_data$Salm_value_type <- NA
clean_data$Salm_value_type[grepl("<",clean_data$Salm_MPN)] <- ("cutoff_left")
clean_data$Salm_value_type[grepl(">",clean_data$Salm_MPN)] <- ("cutoff_right")
clean_data$Salm_value_type[which(!grepl("<",clean_data$Salm_MPN) & !grepl(">",clean_data$Salm_MPN) & !is.na(clean_data$Salm_MPN))] <- "value"
paste0("POST")
paste0("Left Cutoff")
summary(factor(clean_data$Salm_MPN[which(clean_data$Salm_value_type=="cutoff_left")]))
paste0("Right Cutoff")
summary(factor(clean_data$Salm_MPN[which(clean_data$Salm_value_type=="cutoff_right")]))
paste0("Values")
summary(factor(clean_data$Salm_MPN[which(clean_data$Salm_value_type=="value")]))

cfu_threshold_cut(10, clean_data$Salm_MPN, clean_data$Salm_value_type, 2)
cfu_threshold_cut(1, clean_data$Salm_MPN, clean_data$Salm_value_type, 2)
cfu_threshold_cut(1/10, clean_data$Salm_MPN, clean_data$Salm_value_type, 2)
cfu_threshold_cut(1/30, clean_data$Salm_MPN, clean_data$Salm_value_type, 2)
cfu_threshold_cut(1/325, clean_data$Salm_MPN, clean_data$Salm_value_type, 2)

over_10_cfu <- cfu_threshold_cut_return(10, clean_data$Salm_MPN, clean_data$Salm_value_type, NA)[1]
over_10_cfu_pct <- cfu_threshold_cut_return(10, clean_data$Salm_MPN, clean_data$Salm_value_type, NA)[2]

over_1_cfu <- cfu_threshold_cut_return(1, clean_data$Salm_MPN, clean_data$Salm_value_type, NA)[1]
over_1_cfu_pct <- cfu_threshold_cut_return(1, clean_data$Salm_MPN, clean_data$Salm_value_type, NA)[2]

paste0("Positives: ", sum(clean_data$SALM_Result_3651=="Positive"), " (", round(sum(clean_data$SALM_Result_3651=="Positive")/length(clean_data$SALM_Result_3651)*100,2), "%)")
paste0("Negatives: ", sum(clean_data$SALM_Result_3651=="Negative"), " (", round(sum(clean_data$SALM_Result_3651=="Negative")/length(clean_data$SALM_Result_3651)*100,2), "%)")
paste0("Total: ", length(clean_data$SALM_Result_3651))
total <- length(clean_data$SALM_Result_3651)
positives <- sum(clean_data$SALM_Result_3651=="Positive")
positives_pct <- sum(clean_data$SALM_Result_3651=="Positive")/length(clean_data$SALM_Result_3651)*100
negatives <- sum(clean_data$SALM_Result_3651=="Negative")
negatives_pct <- sum(clean_data$SALM_Result_3651=="Negative")/length(clean_data$SALM_Result_3651)*100

mpn_values <- clean_data[,c("Salm_MPN","Salm_value_type")]
colnames(mpn_values) <- c("Salm_MPN", "value_type")
mpn_values$Salm_MPN <- as.character(mpn_values$Salm_MPN)
mpn_values$Salm_MPN <- str_replace_all(mpn_values$Salm_MPN,"<","")
mpn_values$Salm_MPN <- str_replace_all(mpn_values$Salm_MPN,">","")
mpn_values$Salm_MPN <- as.numeric(mpn_values$Salm_MPN)
mpn_values$left <- NA
mpn_values$right <- NA

i <- 1
while (i<=length(mpn_values$Salm_MPN)) {
  if (is.na(mpn_values$value_type[i])) {
    mpn_values$left[i] <- NA
    mpn_values$right[i] <- min(mpn_values$Salm_MPN, na.rm = TRUE)
  } else if (mpn_values$value_type[i]=="cutoff_left") {
    mpn_values$left[i] <- NA
    mpn_values$right[i] <- mpn_values$Salm_MPN[i]
  } else if (mpn_values$value_type[i]=="cutoff_right") {
    mpn_values$left[i] <- mpn_values$Salm_MPN[i]
    mpn_values$right[i] <- NA
  } else if (mpn_values$value_type[i]=="value") {
    mpn_values$left[i] <- mpn_values$Salm_MPN[i]
    mpn_values$right[i] <- mpn_values$Salm_MPN[i]
  }
  i <- i+1
}
left_right_table <- mpn_values[,c("left","right")]
# left_right_table <- left_right_table[which(!is.na(left_right_table$left) & !is.na(left_right_table$right)),]
fit_dist_Turkey_Verification_Salmonella_2016_2021_final_fitdistcens_log10_full <- fitdistrplus::fitdistcens(log10(left_right_table), "norm")

cat(paste0("\nMean: ", as.numeric(fit_dist_Turkey_Verification_Salmonella_2016_2021_final_fitdistcens_log10_full$estimate[1]), " SD: ", as.numeric(fit_dist_Turkey_Verification_Salmonella_2016_2021_final_fitdistcens_log10_full$estimate[2]), "\n"))
fitted_count_parts(as.numeric(fit_dist_Turkey_Verification_Salmonella_2016_2021_final_fitdistcens_log10_full$estimate[1]), as.numeric(fit_dist_Turkey_Verification_Salmonella_2016_2021_final_fitdistcens_log10_full$estimate[2]))
new_row <- data.frame(
  file=input_list[2],
  scenario="Turkey_Verification_Salmonella_2016_2021_final.csv",
  fit_type="mpn_fitdistcens_log10_full",
  total=total,
  positives=positives,
  positives_pct=positives_pct,
  negatives=negatives,
  negatives_pct=negatives_pct,
  product_type="ground",
  positive_threshold=1/325,
  over_1_cfu=over_1_cfu,
  over_1_cfu_pct=over_1_cfu_pct,
  over_10_cfu=over_10_cfu,
  over_10_cfu_pct=over_10_cfu_pct,
  mean=as.numeric(fit_dist_Turkey_Verification_Salmonella_2016_2021_final_fitdistcens_log10_full$estimate[1]),
  sd=as.numeric(fit_dist_Turkey_Verification_Salmonella_2016_2021_final_fitdistcens_log10_full$estimate[2]),
  positives_pct_fit=fitted_count_parts_return(as.numeric(fit_dist_Turkey_Verification_Salmonella_2016_2021_final_fitdistcens_log10_full$estimate[1]), as.numeric(fit_dist_Turkey_Verification_Salmonella_2016_2021_final_fitdistcens_log10_full$estimate[2]))[3],
  negatives_pct_fit=fitted_count_parts_return(as.numeric(fit_dist_Turkey_Verification_Salmonella_2016_2021_final_fitdistcens_log10_full$estimate[1]), as.numeric(fit_dist_Turkey_Verification_Salmonella_2016_2021_final_fitdistcens_log10_full$estimate[2]))[4],
  over_1_cfu_pct_fit=fitted_count_parts_return(as.numeric(fit_dist_Turkey_Verification_Salmonella_2016_2021_final_fitdistcens_log10_full$estimate[1]), as.numeric(fit_dist_Turkey_Verification_Salmonella_2016_2021_final_fitdistcens_log10_full$estimate[2]))[2],
  over_10_cfu_pct_fit=fitted_count_parts_return(as.numeric(fit_dist_Turkey_Verification_Salmonella_2016_2021_final_fitdistcens_log10_full$estimate[1]), as.numeric(fit_dist_Turkey_Verification_Salmonella_2016_2021_final_fitdistcens_log10_full$estimate[2]))[1]
)
fit_row_Turkey_Verification_Salmonella_2016_2021_final_fitdistcens_log10_full <- new_row
```

```{r Turkey Results, echo=FALSE}
poultry_results_table <- rbind(
  fit_row_Turkey_Baseline_Salmonella_Paired_2008_2009_RH_ebel,
  fit_row_Turkey_Baseline_Salmonella_Paired_2008_2009_PC_ebel,
  fit_row_Turkey_Baseline_Salmonella_Paired_2008_2009_RH_fitdistcens_short,
  fit_row_Turkey_Baseline_Salmonella_Paired_2008_2009_PC_fitdistcens_short,
  fit_row_Turkey_Baseline_Salmonella_Paired_2008_2009_RH_fitdistcens_full,
  fit_row_Turkey_Baseline_Salmonella_Paired_2008_2009_PC_fitdistcens_full,
  fit_row_Turkey_Verification_Salmonella_2016_2021_final_ebel,
  fit_row_Turkey_Verification_Salmonella_2016_2021_final_ebel_override,
  fit_row_Turkey_Verification_Salmonella_2016_2021_final_fitdistcens_log10_short,
  fit_row_Turkey_Verification_Salmonella_2016_2021_final_fitdistcens_log10_full
)
file_path <- paste0(getwd(), "/outputs/", format(Sys.time(), "%Y-%m-%d-%H-%M-%S_"))
write.csv(poultry_results_table, paste0(file_path, "turkey_results_table", ".csv"), row.names = FALSE)
```

```{r, echo=FALSE, eval=FALSE}
output_table <- read.csv(paste0(getwd(),"/outputs/2023-08-24-12-04-35_output_table.csv"))
fitting_table <- output_table[,c("scenario","positives_pct","negatives_pct","over_1_cfu_pct","over_10_cfu_pct","mean","sd","positives_pct_fit","negatives_pct_fit","over_1_cfu_pct_fit","over_10_cfu_pct_fit")]
fitting_table$positive_pct_deviation <- fitting_table$positives_pct_fit-fitting_table$positives_pct
```




```{r Ebel Model log test, echo=FALSE, eval=FALSE}
mpn_test_data <- data.frame(
  MPN_Tube_1 = (rep(1,100)),
  MPN_Tube_2 = (rep(0,100)),
  MPN_Tube_3 = (rep(0,100))
)

i <- 1
while(i <= dim(mpn_test_data)[1]) {
  value <- (MPN_Refence$MPN_Index[which(MPN_Refence$Tube_1==mpn_test_data$MPN_Tube_1[i] & MPN_Refence$Tube_2==mpn_test_data$MPN_Tube_2[i] & MPN_Refence$Tube_3==mpn_test_data$MPN_Tube_3[i])])
  
  if (identical(value,numeric(0))) {
    value <- MPN_Refence_LOD$MPN_Index[which(MPN_Refence_LOD$Tube_1==mpn_test_data$MPN_Tube_1[i] & MPN_Refence_LOD$Tube_2==mpn_test_data$MPN_Tube_2[i] & MPN_Refence_LOD$Tube_3==mpn_test_data$MPN_Tube_3[i])]
    value <- sub('.', '', value)
    mpn_test_data$number[i] <- as.numeric(value)
    if (as.numeric(value)==0.03) {
      mpn_test_data$type[i] <- "left_cutoff"
    } else {
      mpn_test_data$type[i] <- "right_cutoff"
    }
  } else {
    mpn_test_data$number[i] <- value
    mpn_test_data$type[i] <- "value"
  }
  i <- i+1
}

mpn_test <- mpn_fit(subset(mpn_test_data, select = c("MPN_Tube_1","MPN_Tube_2","MPN_Tube_3")), 4284, 766, 100, 3, "parts")
mean(mpn_test$mu)
mean(mpn_test$sigma)
```


```{r Double Distribution fitting, echo=FALSE, eval=FALSE}
mu_1 <- parts_mpn$mu[9]
sigma_1 <- parts_mpn$sigma[9]
mu_2 <- 0.1
sigma_2 <- 0.1
p_mix <- 0.1
print("negative")
negatives_pct
(pnormMix(log10(1/30), mean1 = mu_1, sd1 = sigma_1, mean2 = mu_2, sd2 = sigma_2, p.mix = p_mix))*100
print("positive")
positives_pct
(1-pnormMix(log10(1/30), mean1 = mu_1, sd1 = sigma_1, mean2 = mu_2, sd2 = sigma_2, p.mix = p_mix))*100
print("1 cfu")
over_1_cfu_pct
(1-pnormMix(log10(1), mean1 = mu_1, sd1 = sigma_1, mean2 = mu_2, sd2 = sigma_2, p.mix = p_mix))*100
print("10 cfu")
over_10_cfu_pct
(1-pnormMix(log10(10), mean1 = mu_1, sd1 = sigma_1, mean2 = mu_2, sd2 = sigma_2, p.mix = p_mix))*100
```

```{r}
paste0("FSIS_Raw_Poultry_Current_Extracted_2023-10-06.csv")
input_data <- read.csv(paste0(getwd(),"/raw data/FSIS lab data/Chicken/FSIS_Raw_Poultry_Current_Extracted_2023-10-06.csv"))
#
clean_data <- input_data
clean_data$ProjectCode <- factor(clean_data$ProjectCode)
clean_data <- clean_data[which(clean_data$ProjectCode=="HC_CPT_LBW01"),]
clean_data$EstablishmentID <- factor(clean_data$EstablishmentID)
clean_data$EstablishmentNumber <- factor(clean_data$EstablishmentNumber)
clean_data$EstablishmentName <- factor(clean_data$EstablishmentName)
clean_data$State <- factor(clean_data$State)
clean_data$ProjectName <- factor(clean_data$ProjectName)
clean_data$ProductType[which(clean_data$ProductType=="NULL")] <- NA
clean_data$ProductType <- factor(clean_data$ProductType)
clean_data$CollectionDate <- as.Date.character(clean_data$CollectionDate, tryFormats = "%m/%d/%Y")
clean_data$SampleSource <- factor(clean_data$SampleSource)
clean_data$SalmonellaSpAnalysis[which(clean_data$SalmonellaSpAnalysis=="NULL")] <- NA
clean_data$SalmonellaSpAnalysis <- factor(clean_data$SalmonellaSpAnalysis)
clean_data$SalmonellaSerotype[which(clean_data$SalmonellaSerotype=="NULL")] <- NA
clean_data$SalmonellaSerotype <- factor(clean_data$SalmonellaSerotype)
clean_data$SalmonellaPFGEPrimaryPattern[which(clean_data$SalmonellaPFGEPrimaryPattern=="NULL")] <- NA
clean_data$SalmonellaPFGEPrimaryPattern <- factor(clean_data$SalmonellaPFGEPrimaryPattern)
clean_data$SalmonellaPFGESecondaryPattern[which(clean_data$SalmonellaPFGESecondaryPattern=="NULL")] <- NA
clean_data$SalmonellaPFGESecondaryPattern <- factor(clean_data$SalmonellaPFGESecondaryPattern)
clean_data$SalmonellaAlleleCode[which(clean_data$SalmonellaAlleleCode=="NULL")] <- NA
clean_data$SalmonellaAlleleCode <- factor(clean_data$SalmonellaAlleleCode)
clean_data$SalmonellaFSISNumber[which(clean_data$SalmonellaFSISNumber=="NULL")] <- NA
clean_data$SalmonellaFSISNumber <- factor(clean_data$SalmonellaFSISNumber)
clean_data$SalmonellaAMRResistanceProfile[which(clean_data$SalmonellaAMRResistanceProfile=="NULL")] <- NA
clean_data$SalmonellaAMRResistanceProfile <- factor(clean_data$SalmonellaAMRResistanceProfile)
clean_data$SalmonellaMPNg[which(clean_data$SalmonellaMPNg=="NULL")] <- NA
clean_data$SalmonellaMPNg <- factor(clean_data$SalmonellaMPNg)
clean_data$SalmonellaMPNcombo[which(clean_data$SalmonellaMPNcombo=="NULL")] <- NA
clean_data$SalmonellaMPNcombo <- factor(clean_data$SalmonellaMPNcombo)
clean_data$SalmonellaMPNqual[which(clean_data$SalmonellaMPNqual=="NULL")] <- NA
clean_data$SalmonellaMPNqual <- factor(clean_data$SalmonellaMPNqual)
clean_data$SalmonellaQPCRg[which(clean_data$SalmonellaQPCRg=="NULL")] <- NA
clean_data$SalmonellaQPCRg <- factor(clean_data$SalmonellaQPCRg)
clean_data$SalmonellaQPCRml[which(clean_data$SalmonellaQPCRml=="NULL")] <- NA
clean_data$CampylobacterAnalysis1ml[which(clean_data$CampylobacterAnalysis1ml=="NULL")] <- NA
clean_data$CampylobacterAnalysis30ml[which(clean_data$CampylobacterAnalysis30ml=="NULL")] <- NA
clean_data$CampylobacterAnalysis30ml <- factor(clean_data$CampylobacterAnalysis30ml)
clean_data$CampylobacterColi[which(clean_data$CampylobacterColi=="NULL")] <- NA
clean_data$CampylobacterColi <- factor(clean_data$CampylobacterColi)
clean_data$CampylobacterJejuni[which(clean_data$CampylobacterJejuni=="NULL")] <- NA
clean_data$CampylobacterJejuni <- factor(clean_data$CampylobacterJejuni)
clean_data$CampylobacterLari[which(clean_data$CampylobacterLari=="NULL")] <- NA
clean_data$CampylobacterLari <- factor(clean_data$CampylobacterLari)
clean_data$CampylobacterPFGEPrimaryPattern[which(clean_data$CampylobacterPFGEPrimaryPattern=="NULL")] <- NA
clean_data$CampylobacterPFGEPrimaryPattern <- factor(clean_data$CampylobacterPFGEPrimaryPattern)
clean_data$CampylobacterPFGESecondaryPattern[which(clean_data$CampylobacterPFGESecondaryPattern=="NULL")] <- NA
clean_data$CampylobacterPFGESecondaryPattern <- factor(clean_data$CampylobacterPFGESecondaryPattern)
clean_data$CampylobacterAlleleCode[which(clean_data$CampylobacterAlleleCode=="NULL")] <- NA
clean_data$CampylobacterAlleleCode <- factor(clean_data$CampylobacterAlleleCode)
clean_data$CampyFSISNumber[which(clean_data$CampyFSISNumber=="NULL")] <- NA
clean_data$CampyFSISNumber <- factor(clean_data$CampyFSISNumber)
clean_data$CampyAMRResistanceProfile[which(clean_data$CampyAMRResistanceProfile=="NULL")] <- NA
clean_data$CampyAMRResistanceProfile <- factor(clean_data$CampyAMRResistanceProfile)
clean_data$AerobicCountMPNml[which(clean_data$AerobicCountMPNml=="NULL")] <- NA
clean_data$AerobicCountMPNg[which(clean_data$AerobicCountMPNg=="NULL")] <- NA
clean_data$EBMPNml[which(clean_data$EBMPNml=="NULL")] <- NA

clean_data <- clean_data[which(clean_data$CollectionDate>="2023-01-30"),]
subset_data <- subset(clean_data, select = c(CollectionDate, SalmonellaSpAnalysis, SalmonellaQPCRml))
subset_data <- subset_data[which(!is.na(subset_data$SalmonellaSpAnalysis)),]
subset_data <- subset_data[-c(which(subset_data$SalmonellaSpAnalysis=="Positive" & is.na(subset_data$SalmonellaQPCRml))),]

subset_data$SalmonellaQPCRml_number <- as.numeric(stringr::str_remove_all(stringr::str_remove_all(stringr::str_remove_all(subset_data$SalmonellaQPCRml,"<"),">"),"~"))
subset_data$SalmonellaQPCRml_type <- as.factor(NA)
levels(subset_data$SalmonellaQPCRml_type) <- c("Left Cutoff", "Right Cutoff", "Interval", "Value")
subset_data$SalmonellaQPCRml_type[grepl("<",subset_data$SalmonellaQPCRml)] <- as.factor("Left Cutoff")
subset_data$SalmonellaQPCRml_type[grepl(">",subset_data$SalmonellaQPCRml)] <- as.factor("Right Cutoff")
subset_data$SalmonellaQPCRml_type[grepl("~",subset_data$SalmonellaQPCRml)] <- as.factor("Interval")
subset_data$SalmonellaQPCRml_type[!is.na(subset_data$SalmonellaQPCRml) & !grepl("<",subset_data$SalmonellaQPCRml) & !grepl(">",subset_data$SalmonellaQPCRml) & !grepl("~",subset_data$SalmonellaQPCRml)] <- as.factor("Value")

subset_data$sal_enum_type <- NA
subset_data$sal_enum_type[which(subset_data$SalmonellaSpAnalysis=="Negative")] <- "Negative"
subset_data$sal_enum_type[which(subset_data$SalmonellaQPCRml_type=="Left Cutoff")] <- "Positive (Count Below LoQ)"
subset_data$sal_enum_type[which(subset_data$SalmonellaQPCRml_type=="Value")] <- "Positive (Count Within LoQ)"

subset_data$sal_enum_type <- factor(subset_data$sal_enum_type)

subset_data$SalmonellaQPCRml_number[which(subset_data$sal_enum_type=="Negative")] <- (1/30)
subset_data$SalmonellaQPCRml_number_log10 <- log10(subset_data$SalmonellaQPCRml_number)

ggplot(subset_data, aes(x = CollectionDate, y = SalmonellaQPCRml_number_log10, color = sal_enum_type, shape = sal_enum_type)) +
  geom_point() +
  labs(shape = "Screening Result", colour = "Screening Result") +
  scale_color_manual(values=c("#009E73", "#56B4E9", "#D55E00")) +
  scale_shape_manual(values=c(21, 21, 16), labels = c("Negative", "Positive (Count Below LoQ)", "Positive (Count Within LoQ)")) +
  # Positive; Positive (Below Enumeration LoD); Negative
  ggtitle("FSIS Data HC_CPT_LBW01") +
  xlab("Collection Date") +
  ylab("Sal. Level (Log10(CFU/ml))") +
  geom_hline(yintercept = log10(1/30)) +
  geom_hline(yintercept = log10(10)) +
  geom_hline(yintercept = log10(10000000)) +
  ylim(-2.5,7) +
  theme_bw() +
  theme(legend.position = "bottom") +
  theme(axis.text.x=element_text(angle = 45, hjust = 1))
```

```{r}
paste0("3-2012_RCPBS_2496_samples DI.xlsx")
# 
input_data <- readxl::read_xlsx(paste0(getwd(),"/raw data/data from FOIA/Chicken/3-2012_RCPBS_2496_samples DI.xlsx"), sheet = "Sheet1")
# Remove empty columns
clean_data <- dplyr::select(input_data, c("projectid","date_collected","date_mailed","product_name","date_received","sal_bax","sal","sal_mpn_tubes","sal_mpn","sal_group","sal_type","sal_phage"))
# Convert projectid to factors
clean_data$projectid <- as.factor(clean_data$projectid)
# Format dates correctly
clean_data$date_collected <- as.Date(clean_data$date_collected, tryFormats = "%Y-%m-%d")
clean_data$date_mailed <- as.Date(clean_data$date_mailed, tryFormats = "%Y-%m-%d")
clean_data$date_received <- as.Date(clean_data$date_received, tryFormats = "%Y-%m-%d")
# Convert product_name to factors
clean_data$product_name <- as.factor(clean_data$product_name)
# Convert sal_bax to factors
clean_data$sal_bax <- as.factor(clean_data$sal_bax)
# Convert sal to factors
clean_data$sal <- as.factor(clean_data$sal)
# Convert sal_mpn_tubes to factors
clean_data$sal_mpn_tubes <- as.factor(clean_data$sal_mpn_tubes)
# Convert sal_group to factors
clean_data$sal_group <- as.factor(clean_data$sal_group)
# Convert sal_type to factors
clean_data$sal_type <- as.factor(clean_data$sal_type)
# Convert sal_phage to factors
clean_data$sal_phage <- as.factor(clean_data$sal_phage)

clean_data$value_type <- NA
clean_data$value_type[grepl("<",clean_data$sal_mpn)] <- ("Positive (Count Below LoQ)")
clean_data$value_type[grepl(">",clean_data$sal_mpn)] <- ("Positive (Count Above LoQ)")
clean_data$value_type[which(!grepl("<",clean_data$sal_mpn) & !grepl(">",clean_data$sal_mpn) & !is.na(clean_data$sal_mpn))] <- "Positive (Count Within LoQ)"
clean_data$value_type[which(clean_data$sal=="Negative")] <- "Negative"
clean_data$value_type <- factor(clean_data$value_type)

clean_data$sal_mpn_number <- as.numeric(stringr::str_remove_all(stringr::str_remove_all(stringr::str_remove_all(clean_data$sal_mpn,"<"),">"),"~"))


clean_data$sal_mpn_number[which(clean_data$value_type=="Negative")] <- (0.03)
clean_data$sal_mpn_number[which(clean_data$value_type=="Positive (Count Below LoQ)")] <- (0.03)
clean_data$sal_mpn_number_log10 <- log10(clean_data$sal_mpn_number)

ggplot(clean_data, aes(x = date_collected, y = sal_mpn_number_log10, color = value_type, shape = value_type)) +
  geom_point() +
  labs(shape = "Screening Result", colour = "Screening Result") +
  scale_color_manual(values=c("#009E73", "#7F00FF", "#56B4E9", "#D55E00")) +
  scale_shape_manual(values=c(21, 21, 21, 16), labels = c("Negative", "Positive (Count Above LoQ)", "Positive (Count Below LoQ)", "Positive (Count Within LoQ)")) +
  # Positive; Positive (Below Enumeration LoD); Negative
  ggtitle("2012_RCPBS_2496_samples") +
  xlab("Collection Date") +
  ylab("Sal. Level (Log10(CFU/ml))") +
  geom_hline(yintercept = log10(0.03)) +
  geom_hline(yintercept = log10(11)) +
  # geom_hline(yintercept = log10(10000000)) +
  # ylim(-2.5,7) +
  theme_bw() +
  theme(legend.position = "bottom") +
  theme(axis.text.x=element_text(angle = 45, hjust = 1))
```

